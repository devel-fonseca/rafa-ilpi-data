// apps/backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SCHEMA GLOBAL (public)
// ============================================

enum PlanType {
  FREE
  BASICO
  PROFISSIONAL
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO
}

enum CivilStatus {
  SOLTEIRO
  CASADO
  DIVORCIADO
  VIUVO
  UNIAO_ESTAVEL
}

enum BloodType {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
  NAO_INFORMADO
}

enum ResidentStatus {
  ATIVO
  INATIVO
  FALECIDO
}

// Planos disponíveis
model Plan {
  id                String         @id @default(uuid())
  name              String         @unique
  type              PlanType       @unique
  maxResidents      Int            // 5, 20, 100, -1 (ilimitado)
  maxUsers          Int            // 2, 5, 15, -1 (ilimitado)
  priceMonthly      Decimal        @db.Decimal(10, 2) // R$ 0, 299, 499, custom
  features          Json           // Lista de features habilitadas
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  subscriptions     Subscription[]

  @@map("plans")
}

// Tenants (ILPIs/Instituições)
model Tenant {
  id                String         @id @default(uuid())
  name              String         // Nome da ILPI
  slug              String         @unique // Ex: "casa-do-idoso-campinas"
  cnpj              String?        @unique
  email             String
  phone             String?
  status            TenantStatus   @default(TRIAL)
  schemaName        String         @unique // Ex: "tenant_abc123"

  // Endereço
  address           String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?

  subscriptions     Subscription[]
  users             User[]

  @@map("tenants")
}

// Assinatura do tenant
model Subscription {
  id                String         @id @default(uuid())
  tenantId          String
  planId            String

  status            String         // ACTIVE, TRIAL, CANCELLED, PAST_DUE, SUSPENDED
  startDate         DateTime       @default(now())
  endDate           DateTime?
  trialEndDate      DateTime?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan              Plan           @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

// Usuários (multi-tenant)
model User {
  id                String         @id @default(uuid())
  tenantId          String

  name              String
  email             String
  password          String         // bcrypt hash

  role              String         // ADMIN, MANAGER, USER, VIEWER

  isActive          Boolean        @default(true)
  passwordResetRequired Boolean    @default(false)
  lastLogin         DateTime?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?

  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens     RefreshToken[]

  @@unique([tenantId, email])
  @@map("users")
}

// Refresh tokens para JWT
model RefreshToken {
  id                String         @id @default(uuid())
  userId            String
  token             String         @unique
  expiresAt         DateTime

  createdAt         DateTime       @default(now())

  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================
// SCHEMA POR TENANT (tenant_xxx)
// Será criado dinamicamente para cada tenant
// Este modelo serve como template
// ============================================

// Residente - SCHEMA COMPLETO BASEADO NA ESPECIFICAÇÃO DO USUÁRIO
model Resident {
  id                String         @id @default(uuid())

  // ========================================
  // SEÇÃO 1: DADOS PESSOAIS DO RESIDENTE
  // ========================================

  // Foto 3x4
  fotoUrl           String?

  // Nome completo (obrigatório)
  nome              String

  // Nome social (opcional)
  nomeSocial        String?

  // CNS - Cartão Nacional de Saúde (máscara: 999 9999 9999 9999)
  cns               String?

  // CPF (obrigatório, com máscara: 999.999.999-99)
  cpf               String         @unique

  // RG (máscara: 99.999.999-9)
  rg                String?

  // Órgão Expedidor
  orgaoExpedidor    String?

  // Escolaridade
  escolaridade      String?

  // Profissão
  profissao         String?

  // Gênero (obrigatório: MASCULINO, FEMININO, OUTRO)
  genero            Gender

  // Estado Civil (opcional: Solteiro(a), Casado(a), Divorciado(a), Viúvo(a), União Estável)
  estadoCivil       CivilStatus?

  // Religião
  religiao          String?

  // Data de Nascimento (obrigatório, formato: DD/MM/AAAA)
  dataNascimento    DateTime

  // Nacionalidade
  nacionalidade     String         @default("Brasileira")

  // Local de Nascimento (Naturalidade)
  naturalidade      String?

  // UF de Nascimento (2 letras maiúsculas)
  ufNascimento      String?

  // Nome da Mãe
  nomeMae           String?

  // Nome do Pai
  nomePai           String?

  // Documentos Pessoais (RG, CPF) - ARRAY JSON de URLs
  documentosPessoaisUrls Json?     // [{url: string, fileName: string}]

  // Cartão CNS - URL única
  cnsCardUrl        String?

  // ========================================
  // SEÇÃO 2: ENDEREÇOS
  // ========================================

  // ------ Endereço Atual ------
  // CEP (máscara: 99999-999)
  cepAtual          String?

  // UF (2 letras maiúsculas)
  estadoAtual       String?

  // Cidade
  cidadeAtual       String?

  // Logradouro
  logradouroAtual   String?

  // Número
  numeroAtual       String?

  // Complemento
  complementoAtual  String?

  // Bairro
  bairroAtual       String?

  // Telefone (máscara: (99) 99999-9999, salvo SEM máscara)
  telefoneAtual     String?

  // ------ Endereço de Procedência ------
  // CEP
  cepProcedencia    String?

  // UF
  estadoProcedencia String?

  // Cidade
  cidadeProcedencia String?

  // Logradouro
  logradouroProcedencia String?

  // Número
  numeroProcedencia String?

  // Complemento
  complementoProcedencia String?

  // Bairro
  bairroProcedencia String?

  // Telefone
  telefoneProcedencia String?

  // Documentos de Endereço (comprovantes) - ARRAY JSON de URLs
  documentosEnderecoUrls Json?    // [{url: string, fileName: string}]

  // ========================================
  // SEÇÃO 3: CONTATOS DE EMERGÊNCIA
  // ========================================

  // Array de contatos - JSON com estrutura: [{nome, telefone, parentesco}]
  contatosEmergencia Json?        // [{nome: string, telefone: string, parentesco: string}]

  // ========================================
  // SEÇÃO 4: RESPONSÁVEL LEGAL
  // ========================================

  // Nome Completo do Responsável Legal
  responsavelLegalNome String?

  // CPF do Responsável (máscara: 999.999.999-99)
  responsavelLegalCpf String?

  // RG do Responsável (máscara: 99.999.999-9)
  responsavelLegalRg String?

  // Telefone do Responsável (máscara: (99) 99999-9999, salvo SEM máscara)
  responsavelLegalTelefone String?

  // Tipo de Responsabilidade (Curador, Procurador, Responsável Familiar)
  responsavelLegalTipo String?

  // ------ Endereço do Responsável Legal ------
  // CEP
  responsavelLegalCep String?

  // UF
  responsavelLegalUf String?

  // Cidade
  responsavelLegalCidade String?

  // Logradouro
  responsavelLegalLogradouro String?

  // Número
  responsavelLegalNumero String?

  // Complemento
  responsavelLegalComplemento String?

  // Bairro
  responsavelLegalBairro String?

  // Documentos do Responsável - ARRAY JSON de URLs
  responsavelLegalDocumentosUrls Json? // [{url: string, fileName: string}]

  // ========================================
  // SEÇÃO 5: DADOS DE ADMISSÃO
  // ========================================

  // Data de Admissão (obrigatório, formato: DD/MM/AAAA)
  dataAdmissao      DateTime

  // Tipo de Admissão (Voluntária, Involuntária, Judicial)
  tipoAdmissao      String?

  // Motivo da Admissão
  motivoAdmissao    String?        @db.Text

  // Condições de Admissão
  condicoesAdmissao String?        @db.Text

  // Data de Desligamento (formato: DD/MM/AAAA)
  dataDesligamento  DateTime?

  // Motivo do Desligamento
  motivoDesligamento String?       @db.Text

  // Termo de Admissão - URL
  termoAdmissaoUrl  String?

  // Consentimento LGPD - URL
  consentimentoLgpdUrl String?

  // Consentimento de Imagem - URL
  consentimentoImagemUrl String?

  // Data de Saída (formato: DD/MM/AAAA)
  dataSaida         DateTime?

  // Motivo da Saída
  motivoSaida       String?        @db.Text

  // Status do Residente (ATIVO, INATIVO, FALECIDO) - apenas modo edição
  status            ResidentStatus @default(ATIVO)

  // ========================================
  // SEÇÃO 6: INFORMAÇÕES DE SAÚDE
  // ========================================

  // Necessidades Especiais (textarea)
  necessidadesEspeciais String?    @db.Text

  // Restrições Alimentares (textarea)
  restricoesAlimentares String?    @db.Text

  // Aspectos Funcionais (textarea)
  aspectosFuncionais String?       @db.Text

  // Necessita Auxílio para Mobilidade (checkbox)
  necessitaAuxilioMobilidade Boolean @default(false)

  // Situação de Saúde (textarea)
  situacaoSaude     String?        @db.Text

  // Tipo Sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)
  tipoSanguineo     BloodType      @default(NAO_INFORMADO)

  // Altura em metros (decimal, ex: 1.75)
  altura            Decimal?       @db.Decimal(5, 2)

  // Peso em kg (decimal, ex: 70.5)
  peso              Decimal?       @db.Decimal(5, 2)

  // Grau de Dependência (Grau I, II, III)
  grauDependencia   String?

  // Medicamentos em uso (textarea)
  medicamentosUso   String?        @db.Text

  // Alergias (textarea)
  alergias          String?        @db.Text

  // Condições Crônicas (textarea)
  condicoesCronicas String?        @db.Text

  // Observações de Saúde (textarea)
  observacoesSaude  String?        @db.Text

  // Laudo Médico - URL
  laudoMedicoUrl    String?

  // Data do Laudo Médico (formato: DD/MM/AAAA)
  dataLaudoMedico   DateTime?

  // ========================================
  // SEÇÃO 7: PLANOS DE SAÚDE / CONVÊNIOS
  // ========================================

  // Array de convênios - JSON com estrutura: [{nome, numero, arquivoUrl}]
  convenios         Json?          // [{nome: string, numero: string, arquivoUrl: string}]

  // ========================================
  // SEÇÃO 8: PERTENCES
  // ========================================

  // Lista de Pertences (textarea, um por linha)
  pertencesLista    String?        @db.Text

  // Observações sobre Pertences
  pertencesObservacoes String?     @db.Text

  // ========================================
  // SEÇÃO 9: ACOMODAÇÃO
  // ========================================

  // Número do Quarto
  quartoNumero      String?

  // Número do Leito
  leitoNumero       String?

  // ========================================
  // AUDITORIA
  // ========================================

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  createdBy         String?        // UUID do usuário que criou
  updatedBy         String?        // UUID do usuário que atualizou
  deletedAt         DateTime?      // Soft delete
  deletedBy         String?        // UUID do usuário que deletou

  // Relações futuras (comentadas por enquanto)
  // registrosDiarios  RegistroDiario[]
  // medicacoes        Medicacao[]
  // avaliacoesAvd     AvaliacaoAvd[]

  @@map("residents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  Prisma Schema – Sistema Multi‑Tenant para Residências de Idosos
//  Data: 15/11/2025
//  Autor: @efonseca78 (BR)
// ──────────────────────────────────────────────────────────────────────────────

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ENUMS (usados em várias tabelas)
// ──────────────────────────────────────────────────────────────────────────────
enum PlanType {
  FREE
  BASICO
  PROFISSIONAL
  ENTERPRISE

  @@map("PlanType")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL

  @@map("TenantStatus")
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO

  @@map("Gender")
}

enum CivilStatus {
  SOLTEIRO
  CASADO
  DIVORCIADO
  VIUVO
  UNIAO_ESTAVEL

  @@map("CivilStatus")
}

enum BloodType {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
  NAO_INFORMADO

  @@map("BloodType")
}

enum RecordType {
  HIGIENE
  ALIMENTACAO
  HIDRATACAO
  MONITORAMENTO
  ELIMINACAO
  COMPORTAMENTO
  INTERCORRENCIA
  ATIVIDADES
  VISITA
  OUTROS

  @@map("RecordType")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PLANOS
// ──────────────────────────────────────────────────────────────────────────────
model Plan {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  type         PlanType
  maxResidents Int
  maxUsers     Int
  priceMonthly Decimal  @db.Decimal(10, 2)
  features     Json     @default("[]")
  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime @updatedAt @db.Timestamptz(3)

  subscriptions Subscription[]

  @@map("plans")
}

// ──────────────────────────────────────────────────────────────────────────────
//  TENANTS (Clínicas / Residências)
// ──────────────────────────────────────────────────────────────────────────────
model Tenant {
  id         String       @id @default(uuid()) @db.Uuid
  name       String
  slug       String       @unique
  cnpj       String?      @unique
  email      String
  phone      String?
  status     TenantStatus @default(TRIAL)
  schemaName String       @unique

  // Endereço detalhado
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  deletedAt DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  subscriptions Subscription[]
  users         User[]
  residents     Resident[]
  dailyRecords  DailyRecord[]

  @@map("tenants")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SUBSCRIPTIONS (Stripe‑style)
// ──────────────────────────────────────────────────────────────────────────────
model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  planId             String    @db.Uuid
  startDate          DateTime  @default(now()) @db.Timestamptz(3)
  endDate            DateTime? @db.Timestamptz(3)
  currentPeriodStart DateTime? @db.Timestamptz(3)
  currentPeriodEnd   DateTime? @db.Timestamptz(3)
  trialEndDate       DateTime? @db.Timestamptz(3)
  status             String // trialing | active | past_due | canceled | unpaid | incomplete

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@map("subscriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USERS (por tenant)
// ──────────────────────────────────────────────────────────────────────────────
model User {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @db.Uuid
  name                  String
  email                 String
  password              String
  role                  String // admin | user | viewer (pode virar enum depois)
  isActive              Boolean   @default(true)
  lastLogin             DateTime? @db.Timestamptz(3)
  passwordResetRequired Boolean   @default(false)
  deletedAt             DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens RefreshToken[]
  dailyRecords  DailyRecord[]

  @@unique([tenantId, email])
  @@map("users")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REFRESH TOKENS
// ──────────────────────────────────────────────────────────────────────────────
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ──────────────────────────────────────────────────────────────────────────────
//  RESIDENTS – MODELO FINAL (conforme especificação)
// ──────────────────────────────────────────────────────────────────────────────
model Resident {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // 0 – Status
  status String @default("Ativo") // Ativo | Inativo | Falecido

  // 1 – Dados Pessoais
  fullName    String
  socialName  String?
  cpf         String
  rg          String?
  rgIssuer    String?
  education   String?
  profession  String?
  cns         String?
  gender      Gender
  civilStatus CivilStatus?
  religion    String?
  birthDate   DateTime     @db.Date
  nationality String       @default("Brasileira")
  birthCity   String?
  birthState  String? // UF (2 letras)
  motherName  String?
  fatherName  String?
  fotoUrl     String? // URL da foto do residente no MinIO
  documents   Json         @default("[]") // URLs de documentos pessoais

  // 2 – Endereços
  // Atual
  currentCep        String?
  currentState      String?
  currentCity       String?
  currentStreet     String?
  currentNumber     String?
  currentComplement String?
  currentDistrict   String?
  currentPhone      String?

  // Procedência
  originCep        String?
  originState      String?
  originCity       String?
  originStreet     String?
  originNumber     String?
  originComplement String?
  originDistrict   String?
  originPhone      String?

  addressDocuments Json @default("[]") // comprovantes de endereço

  // 3 – Contatos de Emergência (array JSON)
  emergencyContacts Json @default("[]")
  // [{ "name": "...", "phone": "...", "relationship": "..." }]

  // 4 – Responsável Legal
  legalGuardianName       String?
  legalGuardianCpf        String?
  legalGuardianRg         String?
  legalGuardianPhone      String?
  legalGuardianType       String? // curador | procurador | responsável convencional
  legalGuardianCep        String?
  legalGuardianState      String?
  legalGuardianCity       String?
  legalGuardianStreet     String?
  legalGuardianNumber     String?
  legalGuardianComplement String?
  legalGuardianDistrict   String?
  legalGuardianDocuments  Json    @default("[]")

  // 5 – Admissão
  admissionDate       DateTime  @db.Date
  admissionType       String? // Voluntária | Involuntária | Judicial | outro
  admissionReason     String?
  admissionConditions String?
  dischargeDate       DateTime? @db.Date
  dischargeReason     String?

  // 6 – Saúde
  healthStatus           String?
  bloodType              BloodType @default(NAO_INFORMADO)
  height                 Decimal?  @db.Decimal(5, 2) // metros
  weight                 Decimal?  @db.Decimal(5, 1) // kg
  dependencyLevel        String? // Grau I - Independente | Grau II - Semidependente | Grau III - Dependente
  mobilityAid            Boolean?
  specialNeeds           String?
  functionalAspects      String?
  medicationsOnAdmission String?
  allergies              String?
  chronicConditions      String?
  dietaryRestrictions    String?
  medicalReport          Json      @default("[]")
  // [{ "url": "...", "date": "YYYY-MM-DD" }]

  // 7 – Convênios / Planos de Saúde
  healthPlans Json @default("[]")
  // [{ "name": "...", "cardNumber": "...", "cardUrl": "..." }]

  // 8 – Pertences
  belongings Json @default("[]")
  // ["Óculos", "Aparelho auditivo", ...]

  // 9 – Acomodação
  roomId String?
  bedId  String?

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dailyRecords DailyRecord[]

  // Índices
  @@unique([tenantId, cpf])
  @@index([tenantId, status])
  @@index([tenantId, admissionDate(sort: Desc)])
  @@index([deletedAt])
  @@map("residents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REGISTROS DIÁRIOS
// ──────────────────────────────────────────────────────────────────────────────
model DailyRecord {
  id         String     @id @default(uuid()) @db.Uuid
  tenantId   String     @db.Uuid
  residentId String     @db.Uuid

  // Tipo e metadados
  type RecordType
  date DateTime   @db.Date // Data do registro (sem hora)
  time String // Hora no formato "HH:mm" (ex: "07:00", "14:30")

  // Dados estruturados (JSON) - cada tipo tem sua própria estrutura
  data Json @default("{}")

  // Responsável pelo registro
  recordedBy String // Nome do profissional
  userId     String @db.Uuid // ID do usuário que fez o registro

  // Observações gerais (opcional)
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para performance
  @@index([tenantId, residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc), time])
  @@index([deletedAt])
  @@map("daily_records")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Prisma Schema â€“ Sistema Multiâ€‘Tenant para ResidÃªncias de Idosos
//  Data: 15/11/2025
//  Autor: @efonseca78 (BR)
//
//  CONFIGURAÃ‡ÃƒO BASE - Generators e Datasources
//  Este arquivo deve ser processado primeiro (ordem alfabÃ©tica garante isso)
//
//  âš ï¸  ARQUITETURA DE SCHEMAS MODULARES (Prisma 5+)
//
//  Este projeto usa schemas modulares organizados por domÃ­nio em prisma/schema/*.prisma
//  para melhor manutenibilidade e separaÃ§Ã£o de responsabilidades.
//
//  ğŸ“‚ Estrutura:
//  - prisma/schema.prisma (ESTE ARQUIVO)
//    â†’ Generator, Datasource e models compartilhados (AuditLog, etc)
//  - prisma/schema/*.prisma (SCHEMAS MODULARES)
//    â†’ auth.prisma: User, Role, Permission
//    â†’ tenant.prisma: Plan, Tenant, Subscription
//    â†’ billing.prisma: Invoice, Payment, UsageMetrics
//    â†’ residents.prisma: Resident, Bed, Building
//    â†’ clinical.prisma: VitalSign, Medication, ClinicalNote
//    â†’ ... e outros domÃ­nios
//
//  ğŸ”§ Como modificar:
//  1. Identifique o domÃ­nio correto (ex: Subscription estÃ¡ em tenant.prisma)
//  2. Edite o arquivo modular correspondente em prisma/schema/
//  3. Execute: npx prisma generate (regenera client com todos os schemas)
//  4. Execute: npx prisma migrate dev --name nome_da_migration
//
//  âš™ï¸  Preview Feature habilitada: "prismaSchemaFolder"
//  Permite mÃºltiplos arquivos .prisma em prisma/schema/*.prisma
//
//  ğŸ“– DocumentaÃ§Ã£o: https://www.prisma.io/docs/orm/prisma-schema/overview/location
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "prismaSchemaFolder"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUDITORIA
//
//  Logs de auditoria geral do sistema
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// TENANT TABLE - Cada tenant tem sua prÃ³pria tabela isolada
model AuditLog {
  id         Int      @id @default(autoincrement())
  tenantId   String   @map("tenant_id") @db.Uuid // Stored for reference, no FK (cross-schema)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.VarChar(255)
  action     String   @db.VarChar(50)
  userId     String   @map("user_id") @db.VarChar(255)
  userName   String   @map("user_name") @db.VarChar(255)
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  // Ãndices
  @@index([createdAt(sort: Desc)])
  @@index([entityType])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTENTICAÃ‡ÃƒO E CONTROLE DE ACESSO
//
//  Users, Tokens, PermissÃµes e Logs de Acesso
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model User {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String?   @db.Uuid // Optional: SUPERADMIN has NULL tenantId
  name                  String
  email                 String
  password              String
  cpf                   String? // CPF do usuÃ¡rio (identificaÃ§Ã£o Ãºnica nacional)
  role                  String // admin | user | viewer (pode virar enum depois)
  isActive              Boolean   @default(true)
  lastLogin             DateTime? @db.Timestamptz(3)
  passwordResetRequired Boolean   @default(false)
  deletedAt             DateTime? @db.Timestamptz(3)

  // Auditoria e Versionamento
  versionNumber Int      @default(1) // NÃºmero da versÃ£o atual (incrementa a cada UPDATE)
  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)
  createdBy     String?  @db.Uuid // ID do usuÃ¡rio que criou (NULL para primeiro admin)
  updatedBy     String?  @db.Uuid // ID do Ãºltimo usuÃ¡rio que alterou

  tenant   Tenant?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile  UserProfile?
  // NOTA: RelaÃ§Ã£o refreshTokens REMOVIDA (incompatÃ­vel com multi-tenancy)
  // refreshTokens RefreshToken[]
  dailyRecords DailyRecord[]
  medicationAdministrations    MedicationAdministration[]
  medicationLocks              MedicationLock[]           @relation("UserMedicationLocks")
  sosAdministrations           SOSAdministration[]
  vitalSigns                   VitalSign[]
  clinicalNotes                ClinicalNote[]
  clinicalNoteHistoryAuthor    ClinicalNoteHistory[]       @relation("ClinicalNoteHistoryProfessional")
  clinicalNoteHistoryChanges   ClinicalNoteHistory[]       @relation("ClinicalNoteHistoryChangedBy")
  clinicalProfilesCreated      ClinicalProfile[]           @relation("ClinicalProfileCreator")
  clinicalProfilesUpdated      ClinicalProfile[]           @relation("ClinicalProfileUpdater")
  clinicalProfileHistory       ClinicalProfileHistory[]    @relation("ClinicalProfileHistoryUser")
  dietaryRestrictionsCreated   DietaryRestriction[]        @relation("DietaryRestrictionCreator")
  dietaryRestrictionsUpdated   DietaryRestriction[]        @relation("DietaryRestrictionUpdater")
  dietaryRestrictionHistory    DietaryRestrictionHistory[] @relation("DietaryRestrictionHistoryUser")
  notificationReads            NotificationRead[] // Rastreamento individual de leitura
  clinicalNoteDocumentsCreated ClinicalNoteDocument[]      @relation("ClinicalNoteDocumentCreator")

  // RelaÃ§Ãµes de contratos de residentes (NÃƒO confundir com ServiceContract de SaaS)
  contractsUploaded ResidentContract[] @relation("ContractUploader") // Contratos de residentes que este usuÃ¡rio fez upload
  contractHistory   ContractHistory[]  @relation("ContractHistoryUser") // HistÃ³rico de alteraÃ§Ãµes que este usuÃ¡rio fez

  // RelaÃ§Ãµes de versionamento (Resident)
  residentsCreated Resident[]        @relation("ResidentCreator")
  residentsUpdated Resident[]        @relation("ResidentUpdater")
  residentHistory  ResidentHistory[] @relation("ResidentHistoryUser")

  // RelaÃ§Ãµes de versionamento (Prescription)
  prescriptionHistory PrescriptionHistory[] @relation("PrescriptionHistoryUser")

  // RelaÃ§Ãµes de versionamento (Medication)
  medicationsCreated Medication[]        @relation("MedicationCreatedBy")
  medicationsUpdated Medication[]        @relation("MedicationUpdatedBy")
  medicationHistory  MedicationHistory[] @relation("MedicationHistoryUser")

  // RelaÃ§Ãµes de versionamento (SOSMedication)
  sosMedicationsCreated SOSMedication[]        @relation("SOSMedicationCreatedBy")
  sosMedicationsUpdated SOSMedication[]        @relation("SOSMedicationUpdatedBy")
  sosMedicationHistory  SOSMedicationHistory[] @relation("SOSMedicationHistoryUser")

  // RelaÃ§Ãµes de versionamento (Vaccination)
  vaccinationsCreated Vaccination[]        @relation("VaccinationCreatedBy")
  vaccinationsUpdated Vaccination[]        @relation("VaccinationUpdatedBy")
  vaccinationHistory  VaccinationHistory[] @relation("VaccinationHistoryUser")

  // RelaÃ§Ãµes de versionamento (Allergy)
  allergiesCreated Allergy[]        @relation("AllergyCreatedBy")
  allergiesUpdated Allergy[]        @relation("AllergyUpdatedBy")
  allergyHistory   AllergyHistory[] @relation("AllergyHistoryUser")

  // RelaÃ§Ãµes de versionamento (Condition)
  conditionsCreated Condition[]        @relation("ConditionCreatedBy")
  conditionsUpdated Condition[]        @relation("ConditionUpdatedBy")
  conditionHistory  ConditionHistory[] @relation("ConditionHistoryUser")

  // RelaÃ§Ãµes de versionamento (VitalSign)
  vitalSignsCreated VitalSign[]        @relation("VitalSignCreator")
  vitalSignsUpdated VitalSign[]        @relation("VitalSignUpdater")
  vitalSignHistory  VitalSignHistory[] @relation("VitalSignHistoryUser")

  // RelaÃ§Ãµes de versionamento (User) - Self-referencing
  createdByUser      User?                @relation("UserCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser      User?                @relation("UserUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  usersCreated       User[]               @relation("UserCreatedBy")
  usersUpdated       User[]               @relation("UserUpdatedBy")
  userHistory        UserHistory[]        @relation("UserHistoryForUser")
  userHistoryChanges UserHistory[]        @relation("UserHistoryUser")
  bedTransfers       BedTransferHistory[]

  // RelaÃ§Ãµes de versionamento (ResidentScheduleConfig)
  scheduleConfigsCreated ResidentScheduleConfig[] @relation("ScheduleConfigCreatedBy")
  scheduleConfigsUpdated ResidentScheduleConfig[] @relation("ScheduleConfigUpdatedBy")

  // RelaÃ§Ãµes de versionamento (ResidentScheduledEvent)
  scheduledEventsCreated ResidentScheduledEvent[] @relation("ScheduledEventCreatedBy")
  scheduledEventsUpdated ResidentScheduledEvent[] @relation("ScheduledEventUpdatedBy")

  // RelaÃ§Ãµes de contratos e polÃ­ticas
  createdContracts ServiceContract[] @relation("ContractCreator")
  revokedContracts ServiceContract[] @relation("ContractRevoker")
  createdTerms     TermsOfService[]  @relation("TermsCreator")
  revokedTerms     TermsOfService[]  @relation("TermsRevoker")
  // NOTA: RelaÃ§Ãµes com acceptances REMOVIDAS (incompatÃ­veis com multi-tenancy)
  // contractAcceptances      ContractAcceptance[]
  // privacyPolicyAcceptances PrivacyPolicyAcceptance[]

  // Mensagens Internas
  sentMessages        Message[]           @relation("SentMessages")
  receivedMessages    MessageRecipient[]  @relation("ReceivedMessages")
  uploadedAttachments MessageAttachment[] @relation("UploadedAttachments")

  // Mensagens para Tenants (SuperAdmin)
  tenantMessagesCreated TenantMessage[]

  // Alertas de Sinais Vitais
  assignedAlerts           VitalSignAlert[]        @relation("AssignedAlerts")
  resolvedAlerts           VitalSignAlert[]        @relation("ResolvedAlerts")
  alertHistoryChanged      VitalSignAlertHistory[] @relation("AlertChangedBy")
  alertHistoryAssignedUser VitalSignAlertHistory[] @relation("AlertAssignedUser")

  // SeguranÃ§a e Auditoria
  passwordResetTokens PasswordResetToken[]
  // NOTA: RelaÃ§Ã£o accessLogs REMOVIDA (incompatÃ­vel com multi-tenancy)
  // accessLogs          AccessLog[]

  // Eventos Institucionais
  institutionalEventsCreated InstitutionalEvent[] @relation("InstitutionalEventCreatedBy")
  institutionalEventsUpdated InstitutionalEvent[] @relation("InstitutionalEventUpdatedBy")

  // IntercorrÃªncias e RDC 502/2021
  incidentMonthlyIndicatorsCalculated IncidentMonthlyIndicator[]  @relation("IndicatorCalculatedBy")
  sentinelEventNotifications          SentinelEventNotification[] @relation("SentinelEventResponsible")

  @@unique([tenantId, email])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  // Campos para rastreamento de sessÃ£o
  lastActivityAt DateTime @default(now()) @db.Timestamptz(3)
  ipAddress      String?  @db.VarChar(45)
  userAgent      String?  @db.Text
  device         String?  @db.VarChar(100)

  // NOTA: RelaÃ§Ã£o 'user' REMOVIDA - FK incompatÃ­vel com multi-tenancy schema-per-tenant
  // userId aponta para tenant_xyz.users, nÃ£o public.users
  // Integridade garantida por validaÃ§Ã£o em cÃ³digo + CASCADE DELETE via limpeza periÃ³dica

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  token     String    @unique // Hash SHA-256 do token original
  expiresAt DateTime  @db.Timestamptz(3)
  usedAt    DateTime? @db.Timestamptz(3) // Null enquanto nÃ£o usado
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  ipAddress String?   @db.VarChar(45)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model AccessLog {
  id        String       @id @default(uuid()) @db.Uuid
  userId    String       @db.Uuid
  tenantId  String       @db.Uuid
  action    AccessAction // LOGIN | LOGOUT | PASSWORD_CHANGED | SESSION_REVOKED
  status    String       @db.VarChar(20) // SUCCESS | FAILED
  reason    String?      @db.VarChar(100) // Motivo de falha (ex: INVALID_PASSWORD)
  ipAddress String       @db.VarChar(45)
  userAgent String       @db.Text
  device    String?      @db.VarChar(100) // Ex: "Chrome 120 on Windows"
  metadata  Json?        @db.JsonB // Dados adicionais (opcional)
  createdAt DateTime     @default(now()) @db.Timestamptz(3)

  // NOTA: RelaÃ§Ã£o 'user' REMOVIDA - FK incompatÃ­vel com multi-tenancy schema-per-tenant
  // userId aponta para tenant_xyz.users, nÃ£o public.users
  // Integridade garantida por validaÃ§Ã£o em cÃ³digo + logs sÃ£o append-only
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action])
  @@index([createdAt])
  @@map("access_logs")
}

model UserHistory {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  userId   String @db.Uuid

  // Versionamento
  versionNumber Int // NÃºmero da versÃ£o (1, 2, 3...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo da alteraÃ§Ã£o (obrigatÃ³rio, min 10 chars)

  // Campos alterados (array de nomes de campos)
  changedFields String[] @default([])

  // Snapshot completo dos dados (ANTES e DEPOIS da alteraÃ§Ã£o)
  // IMPORTANTE: password sempre mascarado como { passwordChanged: true }
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado novo

  // Auditoria
  changedAt     DateTime @db.Timestamptz(3) // Data/hora da alteraÃ§Ã£o
  changedBy     String   @db.Uuid // UsuÃ¡rio que fez a alteraÃ§Ã£o
  changedByName String? // Nome do usuÃ¡rio (desnormalizado para performance)

  // Metadados opcionais (IP, User Agent, etc.)
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text
  metadata  Json?   @db.JsonB

  // RelaÃ§Ãµes
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User   @relation("UserHistoryForUser", fields: [userId], references: [id], onDelete: Cascade)
  changedByUser User   @relation("UserHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)

  // Ãndices para consultas eficientes
  @@index([tenantId, userId, versionNumber(sort: Desc)]) // Listar histÃ³rico por usuÃ¡rio
  @@index([tenantId, changedAt(sort: Desc)]) // Auditoria geral por data
  @@index([changedBy]) // Auditar por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("user_history")
}

model UserProfile {
  id       String @id @default(uuid()) @db.Uuid
  userId   String @unique @db.Uuid
  tenantId String @db.Uuid

  // Dados do Perfil
  profilePhoto String? // URL ou path da foto de perfil
  phone        String?
  cpf          String? // CPF do usuÃ¡rio (sincronizado com User.cpf)
  department   String? // Departamento
  birthDate    DateTime? @db.Date
  notes        String?   @db.Text
  preferences  Json?     @default("{}") // PreferÃªncias do usuÃ¡rio (tema, sidebar, etc)

  // Sistema de PermissÃµes ILPI
  positionCode       PositionCode? // Cargo padronizado ILPI
  registrationType   RegistrationType? // Tipo de registro profissional (COREN, CRM, etc)
  registrationNumber String? // NÃºmero do registro no conselho
  registrationState  String? // UF do registro (ex: "SP", "RJ")

  // Flags especiais
  isTechnicalManager   Boolean @default(false) // Se Ã© ResponsÃ¡vel TÃ©cnico da ILPI
  isNursingCoordinator Boolean @default(false) // Se Ã© Coordenador de Enfermagem

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  // RelaÃ§Ãµes
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customPermissions UserPermission[] // PermissÃµes customizadas/sobrepostas

  @@map("user_profiles")
}

model UserPermission {
  id            String @id @default(uuid()) @db.Uuid
  userProfileId String @db.Uuid
  tenantId      String @db.Uuid

  // PermissÃ£o especÃ­fica
  permission PermissionType

  // Tipo de customizaÃ§Ã£o
  isGranted Boolean @default(true) // true = concedida, false = revogada

  // Auditoria
  grantedBy String   @db.Uuid // ID do usuÃ¡rio que concedeu/revogou
  grantedAt DateTime @default(now()) @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  userProfile UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  // Ãndices
  @@unique([userProfileId, permission]) // Evita duplicatas de permissÃ£o por usuÃ¡rio
  @@index([tenantId, userProfileId])
  @@index([permission])
  @@map("user_permissions")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FATURAMENTO E PAGAMENTOS
//
//  Faturas, Pagamentos, MÃ©tricas de Uso e Webhooks (SuperAdmin)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Invoice {
  id              String        @id @default(uuid()) @db.Uuid
  tenantId        String        @db.Uuid
  subscriptionId  String        @db.Uuid
  invoiceNumber   String        @unique @db.VarChar(50) // INV-2024-0001
  amount          Decimal       @db.Decimal(10, 2)
  originalAmount  Decimal?      @map("original_amount") @db.Decimal(10, 2) // Valor antes do desconto
  discountPercent Decimal?      @map("discount_percent") @db.Decimal(5, 2) // Desconto aplicado (0-100%)
  discountReason  String?       @map("discount_reason") @db.VarChar(255) // Motivo do desconto
  billingCycle    String?       @map("billing_cycle") @db.VarChar(20) // MONTHLY | ANNUAL
  description     String?       @db.Text // DescriÃ§Ã£o da fatura
  currency        String        @default("BRL") @db.VarChar(3)
  status           InvoiceStatus
  dueDate          DateTime      @db.Date
  paidAt           DateTime?     @db.Timestamptz(3)
  asaasInvoiceId   String?       @unique @db.VarChar(255)
  asaasInvoiceUrl  String?       @db.Text @map("asaas_invoice_url") // URL para visualizar fatura no Asaas
  asaasBankSlipUrl String?       @db.Text @map("asaas_bank_slip_url") // URL do boleto PDF
  paymentUrl       String?       @db.Text
  createdAt        DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime      @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  payments     Payment[]

  // Ãndices
  @@index([tenantId, status])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([asaasInvoiceId])
  @@map("invoices")
}

model Payment {
  id        String         @id @default(uuid()) @db.Uuid
  invoiceId String         @db.Uuid
  amount    Decimal        @db.Decimal(10, 2)
  currency  String         @default("BRL") @db.VarChar(3)
  gateway   PaymentGateway
  gatewayId String?        @db.VarChar(255) // ID externo (Asaas)
  method    PaymentMethod
  status    PaymentStatus
  paidAt    DateTime?      @db.Timestamptz(3)
  metadata  Json?          @db.JsonB
  createdAt DateTime       @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([invoiceId])
  @@index([status])
  @@index([gateway, gatewayId])
  @@map("payments")
}

model UsageMetrics {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  month           DateTime @db.Date // Primeiro dia do mÃªs
  activeResidents Int      @default(0)
  activeUsers     Int      @default(0)
  dailyRecords    Int      @default(0)
  prescriptions   Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Constraint: Um registro por tenant por mÃªs
  @@unique([tenantId, month])
  @@index([tenantId, month])
  @@map("usage_metrics")
}

model WebhookEvent {
  id             String         @id @default(uuid()) @db.Uuid
  gateway        PaymentGateway
  eventType      String         @db.VarChar(100)
  gatewayEventId String?        @db.VarChar(255) // ID Ãºnico do evento no gateway
  payload        Json           @db.JsonB
  processed      Boolean        @default(false)
  processedAt    DateTime?      @db.Timestamptz(3)
  error          String?        @db.Text
  createdAt      DateTime       @default(now()) @db.Timestamptz(3)

  // Ãndices
  @@index([gateway, gatewayEventId])
  @@index([processed])
  @@index([createdAt(sort: Desc)])
  @@map("webhook_events")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EVOLUÃ‡Ã•ES CLÃNICAS (SOAP)
//
//  Notas clÃ­nicas multidisciplinares e documentos anexados
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ClinicalNote {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  residentId     String @db.Uuid
  professionalId String @db.Uuid

  // ProfissÃ£o do autor
  profession ClinicalProfession

  // Data/hora da evoluÃ§Ã£o
  noteDate DateTime @default(now()) @db.Timestamptz(3)

  // MÃ©todo SOAP
  subjective String? @db.Text // S - Subjetivo
  objective  String? @db.Text // O - Objetivo
  assessment String? @db.Text // A - AvaliaÃ§Ã£o
  plan       String? @db.Text // P - Plano

  // Tags para filtros e dashboards
  tags String[] @default([])

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  // Versionamento
  version   Int     @default(1)
  isAmended Boolean @default(false) // Marcado como obsoleto

  // Janela de ediÃ§Ã£o (12 horas)
  editableUntil DateTime @db.Timestamptz(3) // noteDate + 12h

  // VÃ­nculo com alerta de sinal vital (opcional)
  vitalSignAlertId String? @db.Uuid

  // RelaÃ§Ãµes
  tenant         Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident               @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional   User                   @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  vitalSignAlert VitalSignAlert?        @relation(fields: [vitalSignAlertId], references: [id])
  history        ClinicalNoteHistory[]
  documents      ClinicalNoteDocument[]

  // Ãndices
  @@index([tenantId, residentId, noteDate(sort: Desc)])
  @@index([tenantId, professionalId])
  @@index([profession])
  @@index([noteDate])
  @@index([tags])
  @@index([isAmended])
  @@index([vitalSignAlertId])
  @@map("clinical_notes")
}

model ClinicalNoteHistory {
  id      String @id @default(uuid()) @db.Uuid
  noteId  String @db.Uuid
  version Int

  // Snapshot completo
  tenantId       String             @db.Uuid
  residentId     String             @db.Uuid
  professionalId String             @db.Uuid
  profession     ClinicalProfession
  noteDate       DateTime           @db.Timestamptz(3)
  subjective     String?            @db.Text
  objective      String?            @db.Text
  assessment     String?            @db.Text
  plan           String?            @db.Text
  tags           String[]           @default([])

  // Auditoria de alteraÃ§Ã£o
  changeReason String   @db.Text // Motivo obrigatÃ³rio (minLength 10)
  changedAt    DateTime @default(now()) @db.Timestamptz(3)
  changedBy    String   @db.Uuid

  // RelaÃ§Ãµes
  note          ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional  User         @relation("ClinicalNoteHistoryProfessional", fields: [professionalId], references: [id], onDelete: Restrict)
  changedByUser User         @relation("ClinicalNoteHistoryChangedBy", fields: [changedBy], references: [id], onDelete: Restrict)

  // Ãndices
  @@index([noteId, version])
  @@index([tenantId, residentId])
  @@index([changedAt])
  @@map("clinical_notes_history")
}

model ClinicalNoteDocument {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  noteId     String @db.Uuid
  residentId String @db.Uuid

  title        String   @db.VarChar(255)
  type         String?  @db.VarChar(100)
  documentDate DateTime @db.Timestamptz(3)

  // ConteÃºdo HTML (para futura ediÃ§Ã£o)
  htmlContent String @db.Text

  // PDF no MinIO
  pdfFileUrl  String?
  pdfFileKey  String?
  pdfFileName String? @db.VarChar(255)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clinicalNote ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator      User         @relation("ClinicalNoteDocumentCreator", fields: [createdBy], references: [id])

  @@index([tenantId, residentId])
  @@index([noteId])
  @@map("clinical_note_documents")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PERFIL CLÃNICO
//
//  Alergias, CondiÃ§Ãµes CrÃ´nicas e RestriÃ§Ãµes Alimentares
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ClinicalProfile {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @unique @db.Uuid

  // Dados clÃ­nicos textuais
  healthStatus      String? @db.Text
  specialNeeds      String? @db.Text
  functionalAspects String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // NÃºmero da versÃ£o atual (incrementa a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String?   @db.Uuid // ID do usuÃ¡rio que criou (pode ser NULL se criado automaticamente)
  updatedBy     String?   @db.Uuid // ID do Ãºltimo usuÃ¡rio que alterou

  // RelaÃ§Ãµes
  tenant   Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident                 @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator  User?                    @relation("ClinicalProfileCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater  User?                    @relation("ClinicalProfileUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  history  ClinicalProfileHistory[] // HistÃ³rico de versÃµes

  // Ãndices
  @@index([tenantId, residentId])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("clinical_profiles")
}

model ClinicalProfileHistory {
  id                String     @id @default(uuid()) @db.Uuid
  tenantId          String     @db.Uuid
  clinicalProfileId String     @db.Uuid
  versionNumber     Int // NÃºmero da versÃ£o (1, 2, 3, ...)
  changeType        ChangeType // CREATE | UPDATE | DELETE
  changeReason      String     @db.Text // Motivo obrigatÃ³rio da alteraÃ§Ã£o

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual apÃ³s a alteraÃ§Ã£o

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["healthStatus", "specialNeeds", "functionalAspects"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteraÃ§Ã£o
  changedBy     String   @db.Uuid // ID do usuÃ¡rio que fez a alteraÃ§Ã£o
  changedByName String? // Nome do usuÃ¡rio (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisiÃ§Ã£o
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexÃ­vel)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // RelaÃ§Ãµes
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clinicalProfile ClinicalProfile @relation(fields: [clinicalProfileId], references: [id], onDelete: Cascade)
  user            User            @relation("ClinicalProfileHistoryUser", fields: [changedBy], references: [id])

  // Ãndices para performance
  @@index([tenantId, clinicalProfileId, versionNumber(sort: Desc)]) // Buscar histÃ³rico de um perfil
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alteraÃ§Ãµes recentes do tenant
  @@index([changedBy]) // Buscar alteraÃ§Ãµes por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("clinical_profile_history")
}

model Allergy {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados da alergia
  substance String // Medicamento, alimento, lÃ¡tex, etc.
  reaction  String?          @db.Text // DescriÃ§Ã£o da reaÃ§Ã£o
  severity  AllergySeverity?

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident         @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User             @relation("AllergyCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?            @relation("AllergyUpdatedBy", fields: [updatedBy], references: [id])
  history       AllergyHistory[]

  // Ãndices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([substance])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("allergies")
}

model AllergyHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  allergyId     String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text

  previousData  Json?
  newData       Json
  changedFields String[] @default([])

  changedAt     DateTime @db.Timestamptz(3)
  changedBy     String   @db.Uuid
  changedByName String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?    @db.JsonB

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  allergy Allergy @relation(fields: [allergyId], references: [id], onDelete: Cascade)
  user    User    @relation("AllergyHistoryUser", fields: [changedBy], references: [id])

  @@index([tenantId, allergyId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@index([changeType])
  @@map("allergy_history")
}

model Condition {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados do diagnÃ³stico
  condition String // Nome da condiÃ§Ã£o
  icdCode   String? @db.VarChar(10) // CID-10 (opcional)
  notes     String? @db.Text // ObservaÃ§Ãµes clÃ­nicas

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User               @relation("ConditionCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?              @relation("ConditionUpdatedBy", fields: [updatedBy], references: [id])
  history       ConditionHistory[]

  // Ãndices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([condition])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("conditions")
}

model ConditionHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  conditionId   String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text

  previousData  Json?
  newData       Json
  changedFields String[] @default([])

  changedAt     DateTime @db.Timestamptz(3)
  changedBy     String   @db.Uuid
  changedByName String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?    @db.JsonB

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  condition Condition @relation(fields: [conditionId], references: [id], onDelete: Cascade)
  user      User      @relation("ConditionHistoryUser", fields: [changedBy], references: [id])

  @@index([tenantId, conditionId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@index([changeType])
  @@map("condition_history")
}

model DietaryRestriction {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados da restriÃ§Ã£o
  restrictionType RestrictionType
  description     String // Ex: "Sem glÃºten", "Dieta hipossÃ³dica"
  notes           String?         @db.Text // ObservaÃ§Ãµes do nutricionista

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // NÃºmero da versÃ£o atual (incrementa a cada UPDATE)
  createdBy     String    @db.Uuid // ID do usuÃ¡rio que criou o registro
  updatedBy     String?   @db.Uuid // ID do Ãºltimo usuÃ¡rio que alterou
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant   Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident                    @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator  User                        @relation("DietaryRestrictionCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updater  User?                       @relation("DietaryRestrictionUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  history  DietaryRestrictionHistory[] // HistÃ³rico de versÃµes

  // Ãndices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([restrictionType])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("dietary_restrictions")
}

model DietaryRestrictionHistory {
  id                   String     @id @default(uuid()) @db.Uuid
  tenantId             String     @db.Uuid
  dietaryRestrictionId String     @db.Uuid
  versionNumber        Int // NÃºmero da versÃ£o (1, 2, 3, ...)
  changeType           ChangeType // CREATE | UPDATE | DELETE
  changeReason         String     @db.Text // Motivo obrigatÃ³rio da alteraÃ§Ã£o

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual apÃ³s a alteraÃ§Ã£o

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["restrictionType", "description", "notes"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteraÃ§Ã£o
  changedBy     String   @db.Uuid // ID do usuÃ¡rio que fez a alteraÃ§Ã£o
  changedByName String? // Nome do usuÃ¡rio (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisiÃ§Ã£o
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexÃ­vel)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // RelaÃ§Ãµes
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dietaryRestriction DietaryRestriction @relation(fields: [dietaryRestrictionId], references: [id], onDelete: Cascade)
  user               User               @relation("DietaryRestrictionHistoryUser", fields: [changedBy], references: [id])

  // Ãndices para performance
  @@index([tenantId, dietaryRestrictionId, versionNumber(sort: Desc)]) // Buscar histÃ³rico de uma restriÃ§Ã£o
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alteraÃ§Ãµes recentes do tenant
  @@index([changedBy]) // Buscar alteraÃ§Ãµes por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("dietary_restriction_history")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  COMUNICAÃ‡ÃƒO E TEMPLATES DE EMAIL
//
//  Templates de email, logs e sistema de mensagens internas
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model EmailTemplate {
  id          String                @id @default(uuid()) @db.Uuid
  key         String                @unique @db.VarChar(100) // "user-invite", "payment-reminder", etc.
  name        String                @db.VarChar(255) // "Convite de UsuÃ¡rio"
  subject     String                @db.VarChar(500) // "Acesso liberado ao sistema da {{tenantName}}"
  description String?               @db.Text
  jsonContent Json                  @db.JsonB // Easy Email JSON structure
  variables   Json                  @db.JsonB // [{name: "tenantName", type: "string", required: true, description: "Nome da ILPI"}]
  version     Int                   @default(1)
  isActive    Boolean               @default(true)
  category    EmailTemplateCategory
  createdAt   DateTime              @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime              @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  versions EmailTemplateVersion[]

  // Ãndices
  @@index([key])
  @@index([category])
  @@index([isActive])
  @@map("email_templates")
}

model EmailTemplateVersion {
  id            String   @id @default(uuid()) @db.Uuid
  templateId    String   @db.Uuid
  versionNumber Int
  jsonContent   Json     @db.JsonB
  subject       String   @db.VarChar(500)
  createdBy     String   @db.Uuid // User ID do superadmin
  changeNote    String?  @db.Text
  createdAt     DateTime @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  template EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([templateId])
  @@index([versionNumber])
  @@map("email_template_versions")
}

model EmailLog {
  id             String      @id @default(uuid()) @db.Uuid
  templateKey    String?     @db.VarChar(100) // "user-invite", "payment-reminder", etc. (null se nÃ£o for de template)
  recipientEmail String      @db.VarChar(255)
  recipientName  String?     @db.VarChar(255)
  subject        String      @db.VarChar(500)
  tenantId       String?     @db.Uuid // Para emails vinculados a tenant
  resendId       String?     @db.VarChar(255) // ID retornado pela Resend API
  status         EmailStatus
  errorMessage   String?     @db.Text
  sentAt         DateTime    @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Ãndices
  @@index([templateKey])
  @@index([tenantId])
  @@index([sentAt(sort: Desc)])
  @@index([status])
  @@index([recipientEmail])
  @@map("email_logs")
}

model TenantMessage {
  id                String                 @id @default(uuid()) @db.Uuid
  title             String                 @db.VarChar(255) // "Nova funcionalidade: RelatÃ³rios"
  subject           String                 @db.VarChar(500) // Subject do email
  htmlContent       String                 @db.Text // HTML completo do email
  recipientFilter   MessageRecipientFilter
  specificTenantIds String[]               @db.Uuid // Array de IDs (se SPECIFIC_TENANTS)
  scheduledFor      DateTime?              @db.Timestamptz(3) // null = enviar agora
  sentAt            DateTime?              @db.Timestamptz(3)
  status            TenantMessageStatus    @default(DRAFT)
  sentCount         Int                    @default(0)
  failedCount       Int                    @default(0)
  createdBy         String                 @db.Uuid
  createdAt         DateTime               @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime               @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  creator User @relation(fields: [createdBy], references: [id])

  // Ãndices
  @@index([status])
  @@index([scheduledFor])
  @@index([createdBy])
  @@index([createdAt(sort: Desc)])
  @@map("tenant_messages")
}

model Message {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  senderId String @db.Uuid

  // Tipo e conteÃºdo
  type    MessageType
  subject String      @db.VarChar(255)
  body    String      @db.Text

  // Thread/ConversaÃ§Ã£o (opcional - para respostas)
  threadId String? @db.Uuid // Se Ã© resposta, aponta para mensagem original
  isReply  Boolean @default(false)

  // Metadata
  metadata Json? @db.JsonB // InformaÃ§Ãµes extras

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  deletedBy String?   @db.Uuid

  // RelaÃ§Ãµes
  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sender       User                @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  parentThread Message?            @relation("MessageThread", fields: [threadId], references: [id], onDelete: SetNull)
  replies      Message[]           @relation("MessageThread")
  recipients   MessageRecipient[]
  attachments  MessageAttachment[]

  // Ãndices
  @@index([tenantId, senderId, createdAt(sort: Desc)])
  @@index([tenantId, threadId])
  @@index([deletedAt])
  @@map("messages")
}

model MessageRecipient {
  id        String @id @default(uuid()) @db.Uuid
  messageId String @db.Uuid
  userId    String @db.Uuid
  tenantId  String @db.Uuid

  // Status individual
  status MessageStatus @default(SENT)
  readAt DateTime?     @db.Timestamptz(3)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation("ReceivedMessages", fields: [userId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([messageId, userId])
  @@index([userId, status, createdAt(sort: Desc)])
  @@index([tenantId, userId, status])
  @@map("message_recipients")
}

model MessageAttachment {
  id        String @id @default(uuid()) @db.Uuid
  messageId String @db.Uuid
  tenantId  String @db.Uuid

  // Dados do arquivo
  fileName String @db.VarChar(255)
  fileSize Int // Bytes
  mimeType String @db.VarChar(100)
  fileUrl  String @db.Text // URL no MinIO
  s3Key    String @db.Text // Chave no S3/MinIO

  // Auditoria
  uploadedBy String   @db.Uuid
  uploadedAt DateTime @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  message  Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploader User    @relation("UploadedAttachments", fields: [uploadedBy], references: [id])

  @@index([messageId])
  @@index([tenantId])
  @@map("message_attachments")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONTRATOS DE SERVIÃ‡O SaaS
//
//  Modelos para gerenciar contratos de serviÃ§o, aceites e compliance LGPD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Contratos de ServiÃ§o (Templates Versionados)
model ServiceContract {
  id            String         @id @default(uuid()) @db.Uuid
  version       String // "v1.0", "v1.1", "v2.0"
  planId        String?        @db.Uuid // NULL = genÃ©rico para todos planos
  status        ContractStatus @default(DRAFT)
  effectiveFrom DateTime?      @db.Timestamptz(3)
  title         String         @db.VarChar(255)
  content       String // HTML/Markdown
  contentHash   String         @db.VarChar(64) // SHA-256
  createdBy     String         @db.Uuid
  createdAt     DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(3)
  revokedAt     DateTime?      @db.Timestamptz(3)
  revokedBy     String?        @db.Uuid

  // RelaÃ§Ãµes
  plan        Plan?                @relation(fields: [planId], references: [id], onDelete: SetNull)
  creator     User                 @relation("ContractCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  revoker     User?                @relation("ContractRevoker", fields: [revokedBy], references: [id], onDelete: Restrict)
  acceptances ContractAcceptance[]

  @@unique([version, planId])
  @@index([status])
  @@index([effectiveFrom])
  @@index([planId])
  @@map("service_contracts")
}

// Termos de Uso (nova nomenclatura)
model TermsOfService {
  id            String         @id @default(uuid()) @db.Uuid
  version       String         @db.VarChar(50)
  planId        String?        @db.Uuid
  status        ContractStatus @default(DRAFT)
  effectiveFrom DateTime?      @map("effective_from") @db.Timestamptz(3)
  title         String         @db.VarChar(255)
  content       String         @db.Text
  contentHash   String         @map("content_hash") @db.VarChar(64)
  createdBy     String         @map("created_by") @db.Uuid
  createdAt     DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(3)
  revokedAt     DateTime?      @map("revoked_at") @db.Timestamptz(3)
  revokedBy     String?        @map("revoked_by") @db.Uuid

  // RelaÃ§Ãµes
  plan        Plan?                         @relation("TermsOfServicePlan", fields: [planId], references: [id], onDelete: SetNull)
  creator     User                          @relation("TermsCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  revoker     User?                         @relation("TermsRevoker", fields: [revokedBy], references: [id], onDelete: Restrict)
  acceptances TermsOfServiceAcceptance[]

  @@unique([version, planId])
  @@index([status])
  @@index([effectiveFrom])
  @@index([planId])
  @@map("terms_of_service")
}

// Registros de Aceite de Termos de Uso (Prova JurÃ­dica)
model TermsOfServiceAcceptance {
  id           String   @id @default(uuid()) @db.Uuid
  termsId      String   @map("terms_id") @db.Uuid
  tenantId     String   @unique @db.Uuid
  userId       String   @db.Uuid
  acceptedAt   DateTime @default(now()) @map("accepted_at") @db.Timestamptz(3)
  ipAddress    String   @map("ip_address") @db.VarChar(45)
  userAgent    String   @map("user_agent") @db.Text
  termsVersion String   @map("terms_version") @db.VarChar(50)
  termsHash    String   @map("terms_hash") @db.VarChar(64)
  termsContent String   @map("terms_content") @db.Text

  // RelaÃ§Ãµes
  terms  TermsOfService @relation(fields: [termsId], references: [id], onDelete: Restrict)
  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([termsId])
  @@index([acceptedAt])
  @@map("terms_of_service_acceptances")
}

// Registros de Aceite (Prova JurÃ­dica)
model ContractAcceptance {
  id              String   @id @default(uuid()) @db.Uuid
  contractId      String   @db.Uuid
  tenantId        String   @unique @db.Uuid // Tenant sÃ³ aceita uma vez
  userId          String   @db.Uuid
  acceptedAt      DateTime @default(now()) @db.Timestamptz(3)
  ipAddress       String   @db.VarChar(45)
  userAgent       String
  contractVersion String   @db.VarChar(50) // Snapshot imutÃ¡vel
  contractHash    String   @db.VarChar(64) // Snapshot imutÃ¡vel
  contractContent String // Snapshot imutÃ¡vel

  // RelaÃ§Ãµes
  contract ServiceContract @relation(fields: [contractId], references: [id], onDelete: Restrict)
  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // NOTA: RelaÃ§Ã£o 'user' REMOVIDA - FK incompatÃ­vel com multi-tenancy schema-per-tenant
  // userId aponta para tenant_xyz.users, nÃ£o public.users
  // Integridade garantida por validaÃ§Ã£o em cÃ³digo + aceites append-only

  @@index([contractId])
  @@index([acceptedAt])
  @@map("contract_acceptances")
}

// Registros de Aceite da PolÃ­tica de Privacidade (Prova JurÃ­dica LGPD)
model PrivacyPolicyAcceptance {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @unique @db.Uuid // Tenant sÃ³ aceita uma vez
  userId              String   @db.Uuid
  acceptedAt          DateTime @default(now()) @db.Timestamptz(3)
  ipAddress           String   @db.VarChar(45)
  userAgent           String
  policyVersion       String   @db.VarChar(50) // ex: "2.2"
  policyEffectiveDate String   @db.VarChar(50) // ex: "24/12/2025"
  policyContent       String   @db.Text // Snapshot completo Markdown

  // DeclaraÃ§Ãµes LGPD registradas no onboarding
  lgpdIsDataController           Boolean @default(false)
  lgpdHasLegalBasis              Boolean @default(false)
  lgpdAcknowledgesResponsibility Boolean @default(false)

  // RelaÃ§Ãµes
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // NOTA: RelaÃ§Ã£o 'user' REMOVIDA - FK incompatÃ­vel com multi-tenancy schema-per-tenant
  // userId aponta para tenant_xyz.users, nÃ£o public.users
  // Integridade garantida por validaÃ§Ã£o em cÃ³digo + aceites append-only

  @@index([tenantId])
  @@index([acceptedAt])
  @@map("privacy_policy_acceptances")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  REGISTROS DIÃRIOS
//
//  Registros diÃ¡rios de cuidados e agenda do residente
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model DailyRecord {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo e metadados
  type RecordType
  date DateTime   @db.Date // Data do registro (sem hora)
  time String // Hora no formato "HH:mm" (ex: "07:00", "14:30")

  // Dados estruturados (JSON) - cada tipo tem sua prÃ³pria estrutura
  data Json @default("{}")

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CAMPOS PARA INTERCORRÃŠNCIAS E RDC 502/2021 (opcionais)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  incidentCategory        IncidentCategory?
  incidentSubtypeClinical IncidentSubtypeClinical?
  incidentSubtypeAssist   IncidentSubtypeAssistencial?
  incidentSubtypeAdmin    IncidentSubtypeAdministrativa?
  incidentSeverity        IncidentSeverity?
  isEventoSentinela       Boolean                        @default(false)
  isDoencaNotificavel     Boolean                        @default(false)
  rdcIndicators           Json                           @default("[]") // Array de RdcIndicatorType
  notificadoVigilancia    Boolean                        @default(false)
  dataNotificacao         DateTime?                      @db.Timestamptz(3)
  protocoloNotificacao    String?                        @db.VarChar(100)

  // ResponsÃ¡vel pelo registro
  recordedBy String // Nome do profissional
  userId     String @db.Uuid // ID do usuÃ¡rio que fez o registro

  // ObservaÃ§Ãµes gerais (opcional)
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // RelaÃ§Ã£o com histÃ³rico de versÃµes
  history DailyRecordHistory[]

  // RelaÃ§Ã£o com Eventos Sentinela
  sentinelEventNotifications SentinelEventNotification[]

  // Ãndices para performance
  @@index([tenantId, residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc), time])
  @@index([deletedAt])
  // Ãndices compostos adicionais para queries frequentes
  @@index([tenantId, type, date(sort: Desc)]) // Registros por tipo (ex: ALIMENTACAO do dia)
  @@index([residentId, type, date(sort: Desc)]) // Registros do residente por tipo
  @@index([tenantId, date, deletedAt]) // Registros ativos do dia
  @@map("daily_records")
}

model DailyRecordHistory {
  id            String @id @default(uuid()) @db.Uuid
  recordId      String @db.Uuid // FK para DailyRecord
  tenantId      String @db.Uuid
  versionNumber Int // NÃºmero sequencial da versÃ£o (1, 2, 3...)

  // Dados da versÃ£o anterior (snapshot completo)
  previousData Json // Snapshot completo do estado anterior

  // Dados da nova versÃ£o (para comparaÃ§Ã£o)
  newData Json // Snapshot completo do novo estado

  // Campos alterados (array de nomes de campos: ["time", "data.pressao"])
  changedFields Json @default("[]")

  // Auditoria da mudanÃ§a
  changeType    String // "UPDATE" ou "DELETE"
  changeReason  String   @db.Text // Motivo obrigatÃ³rio da mudanÃ§a
  changedBy     String   @db.Uuid // ID do usuÃ¡rio que fez a mudanÃ§a
  changedByName String // Nome do usuÃ¡rio que fez a mudanÃ§a
  changedAt     DateTime @default(now()) @db.Timestamptz(3)

  // IP e User Agent para auditoria adicional
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // RelaÃ§Ãµes
  record DailyRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Ãndices para performance
  @@index([recordId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("daily_record_history")
}

model ResidentScheduleConfig {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de registro obrigatÃ³rio (usa enum RecordType existente)
  recordType RecordType

  // FrequÃªncia de recorrÃªncia
  frequency ScheduleFrequency

  // ConfiguraÃ§Ãµes especÃ­ficas por frequÃªncia
  // Para WEEKLY: 0-6 (0=Domingo, 1=Segunda, ..., 6=SÃ¡bado)
  // Para MONTHLY: 1-31 (dia do mÃªs)
  // Para DAILY: null
  dayOfWeek  Int? // 0-6 (apenas para WEEKLY)
  dayOfMonth Int? // 1-31 (apenas para MONTHLY)

  // HorÃ¡rios sugeridos - array de strings "HH:mm"
  // Ex: ["08:00", "14:00"] para 2x ao dia
  suggestedTimes Json @default("[]")

  // Status
  isActive Boolean @default(true)

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Metadados extras (JSON) - usado para armazenar informaÃ§Ãµes especÃ­ficas por tipo
  // Ex: para ALIMENTACAO: { "mealType": "CafÃ© da ManhÃ£" }
  metadata Json? @default("{}")

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ScheduleConfigCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("ScheduleConfigUpdatedBy", fields: [updatedBy], references: [id])

  // Ãndices
  @@index([tenantId, residentId])
  @@index([residentId, isActive])
  @@index([recordType])
  @@index([deletedAt])
  // Ãndices compostos adicionais para queries frequentes
  @@index([residentId, recordType, isActive]) // ConfiguraÃ§Ãµes ativas do residente por tipo
  @@index([tenantId, recordType, isActive]) // ConfiguraÃ§Ãµes ativas do tenant por tipo
  @@map("resident_schedule_configs")
}

model ResidentScheduledEvent {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de evento
  eventType ScheduledEventType

  // Data e hora do agendamento
  scheduledDate DateTime @db.Date
  scheduledTime String // HH:mm

  // Detalhes do evento
  title       String // Ex: "Vacina Influenza - 1Âª dose"
  description String? @db.Text

  // Campos especÃ­ficos para vacinas (quando eventType = VACCINATION)
  vaccineData Json? // {vaccine, dose, manufacturer, etc}

  // Status
  status ScheduledEventStatus @default(SCHEDULED)

  // ReferÃªncia ao registro criado (quando status = COMPLETED)
  completedRecordId String?   @db.Uuid
  completedAt       DateTime? @db.Timestamptz(3)

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ScheduledEventCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("ScheduledEventUpdatedBy", fields: [updatedBy], references: [id])

  // Ãndices
  @@index([tenantId, scheduledDate])
  @@index([residentId, scheduledDate])
  @@index([status, scheduledDate])
  @@index([eventType])
  @@index([deletedAt])
  // Ãndices compostos adicionais para queries frequentes
  @@index([tenantId, status, scheduledDate]) // Eventos pendentes do dia
  @@index([residentId, status, scheduledDate]) // Eventos pendentes do residente
  @@index([tenantId, eventType, scheduledDate]) // Eventos por tipo (ex: VACINACAO)
  @@map("resident_scheduled_events")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GESTÃƒO DE INTERCORRÃŠNCIAS E CONFORMIDADE RDC 502/2021
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Indicadores mensais RDC 502/2021
model IncidentMonthlyIndicator {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  year  Int // 2024, 2025, etc
  month Int // 1-12

  indicatorType RdcIndicatorType

  numerator   Int // Casos identificados
  denominator Int // Total de residentes (mÃ©dia do mÃªs)
  rate        Float // Taxa calculada (numerator/denominator * 100)

  incidentIds Json  @default("[]") // Array de UUIDs
  metadata    Json? @db.JsonB

  calculatedAt DateTime @default(now()) @db.Timestamptz(3)
  calculatedBy String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation("IndicatorCalculatedBy", fields: [calculatedBy], references: [id])

  @@unique([tenantId, year, month, indicatorType])
  @@index([tenantId, year(sort: Desc), month(sort: Desc)])
  @@index([indicatorType])
  @@map("incident_monthly_indicators")
}

// Rastreamento de notificaÃ§Ãµes Ã  vigilÃ¢ncia (Eventos Sentinela)
model SentinelEventNotification {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  dailyRecordId  String @db.Uuid
  notificationId String @db.Uuid

  eventType String @db.VarChar(100) // QUEDA_COM_LESAO, TENTATIVA_SUICIDIO

  status String @default("PENDENTE") @db.VarChar(50) // PENDENTE, ENVIADO, CONFIRMADO

  protocolo          String?   @db.VarChar(100)
  dataEnvio          DateTime? @db.Timestamptz(3)
  dataConfirmacao    DateTime? @db.Timestamptz(3)
  responsavelEnvio   String?   @db.Uuid
  emailEnviado       Boolean   @default(false)
  emailEnviadoEm     DateTime? @db.Timestamptz(3)
  emailDestinatarios Json?     @default("[]")

  observacoes String? @db.Text
  metadata    Json?   @db.JsonB

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dailyRecord  DailyRecord  @relation(fields: [dailyRecordId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User?        @relation("SentinelEventResponsible", fields: [responsavelEnvio], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([dailyRecordId])
  @@index([status])
  @@map("sentinel_event_notifications")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DOCUMENTAÃ‡ÃƒO INSTITUCIONAL
//
//  Perfil e documentos da instituiÃ§Ã£o (CNPJ, alvarÃ¡s, etc)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model TenantProfile {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @unique @db.Uuid

  // Logo e identidade visual
  logoUrl String? // URL do logo no S3/MinIO
  logoKey String? // Chave do arquivo no S3 para deleÃ§Ã£o

  // Natureza jurÃ­dica e dados bÃ¡sicos
  legalNature LegalNature?
  tradeName   String? // Nome fantasia

  // Dados regulatÃ³rios
  cnesCode         String? @db.VarChar(20) // CÃ³digo CNES (Cadastro Nacional de Estabelecimentos de SaÃºde)
  capacityDeclared Int? // Capacidade declarada de residentes
  capacityLicensed Int? // Capacidade licenciada pela vigilÃ¢ncia sanitÃ¡ria

  // Contatos institucionais
  contactPhone String?
  contactEmail String?
  websiteUrl   String?

  // InformaÃ§Ãµes complementares
  foundedAt DateTime? @db.Date // Data de fundaÃ§Ã£o
  mission   String?   @db.Text // MissÃ£o institucional
  vision    String?   @db.Text // VisÃ£o institucional
  values    String?   @db.Text // Valores institucionais

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([tenantId])
  @@index([legalNature])
  @@index([deletedAt])
  @@map("tenant_profiles")
}

model TenantDocument {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // Tipo de documento (baseado na natureza jurÃ­dica)
  type String @db.VarChar(100) // ESTATUTO, CMI, CNPJ, ALVARA_USO, etc.

  // Arquivo
  fileUrl  String // URL completa do arquivo no S3/MinIO
  fileKey  String? // Chave do arquivo no S3 para deleÃ§Ã£o
  fileName String // Nome original do arquivo
  fileSize Int? // Tamanho em bytes
  mimeType String? @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Metadados do documento
  issuedAt       DateTime?      @db.Date // Data de emissÃ£o
  expiresAt      DateTime?      @db.Date // Data de vencimento (se aplicÃ¡vel)
  status         DocumentStatus @default(PENDENTE) // Calculado automaticamente
  documentNumber String?        @db.VarChar(100) // NÃºmero do documento (ex: protocolo, nÃºmero de alvarÃ¡)
  issuerEntity   String?        @db.VarChar(200) // Entidade emissora (ex: VigilÃ¢ncia SanitÃ¡ria, Corpo de Bombeiros)
  tags           String[]       @default([]) // Tags para categorizaÃ§Ã£o adicional

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Versionamento e substituiÃ§Ã£o
  version      Int       @default(1) // VersÃ£o do documento (incrementa a cada substituiÃ§Ã£o)
  replacedById String?   @db.Uuid // ID do documento que substituiu este
  replacedAt   DateTime? @db.Timestamptz(3) // Data em que foi substituÃ­do

  // Auditoria
  uploadedBy String    @db.Uuid // ID do usuÃ¡rio que fez upload
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replacedBy TenantDocument?   @relation("DocumentReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces   TenantDocument[]  @relation("DocumentReplacement")
  history    DocumentHistory[]

  // Ãndices
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, expiresAt])
  @@index([expiresAt])
  @@index([status])
  @@index([deletedAt])
  @@index([replacedById])
  @@index([version])
  @@map("tenant_documents")
}

model DocumentHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  documentId String @db.Uuid // Documento atual relacionado

  // AÃ§Ã£o realizada
  action DocumentAction // CREATED, UPDATED, REPLACED, DELETED
  reason String?        @db.Text // Motivo da alteraÃ§Ã£o

  // Snapshot dos dados anteriores (JSON)
  previousData Json? // Estado anterior do documento
  newData      Json? // Novo estado do documento

  // Campos que mudaram
  changedFields String[] @default([]) // Lista de campos alterados

  // Auditoria
  changedBy String   @db.Uuid // UsuÃ¡rio que realizou a aÃ§Ã£o
  changedAt DateTime @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document TenantDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([tenantId, documentId])
  @@index([documentId])
  @@index([action])
  @@index([changedAt])
  @@map("document_history")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ENUMS - Sistema Multiâ€‘Tenant para ResidÃªncias de Idosos
//
//  Este arquivo centraliza TODOS os 47 enums do sistema organizados por categoria
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ==========================================
// NEGÃ“CIO E COMERCIAL (7 enums)
// ==========================================

enum PlanType {
  FREE
  BASICO
  PROFISSIONAL
  ENTERPRISE

  @@map("PlanType")
}

enum BillingCycle {
  MONTHLY
  ANNUAL

  @@map("BillingCycle")
}

enum ContractStatus {
  DRAFT // EdiÃ§Ã£o (nÃ£o afeta ninguÃ©m)
  ACTIVE // Publicado (novos cadastros usam)
  REVOKED // Revogado (nÃ£o aceita mais)

  @@map("ContractStatus")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  OVERDUE
  VOID
  UNCOLLECTIBLE

  @@map("InvoiceStatus")
}

enum PaymentGateway {
  ASAAS
  MANUAL

  @@map("PaymentGateway")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  PIX
  TRANSFER

  @@map("PaymentMethod")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED

  @@map("PaymentStatus")
}

// ==========================================
// PERMISSÃ•ES E SEGURANÃ‡A (5 enums)
// ==========================================

// ENUM: Tipos de PermissÃµes do Sistema (37 permissÃµes granulares)
enum PermissionType {
  // Residentes
  VIEW_RESIDENTS
  CREATE_RESIDENTS
  UPDATE_RESIDENTS
  DELETE_RESIDENTS

  // Registros DiÃ¡rios
  VIEW_DAILY_RECORDS
  CREATE_DAILY_RECORDS
  UPDATE_DAILY_RECORDS
  DELETE_DAILY_RECORDS

  // PrescriÃ§Ãµes
  VIEW_PRESCRIPTIONS
  CREATE_PRESCRIPTIONS
  UPDATE_PRESCRIPTIONS
  DELETE_PRESCRIPTIONS

  // AdministraÃ§Ã£o de Medicamentos
  VIEW_MEDICATIONS
  ADMINISTER_MEDICATIONS
  ADMINISTER_CONTROLLED_MEDICATIONS

  // Sinais Vitais
  VIEW_VITAL_SIGNS
  RECORD_VITAL_SIGNS

  // VacinaÃ§Ãµes
  VIEW_VACCINATIONS
  CREATE_VACCINATIONS
  UPDATE_VACCINATIONS
  DELETE_VACCINATIONS

  // EvoluÃ§Ãµes ClÃ­nicas (SOAP)
  VIEW_CLINICAL_NOTES
  CREATE_CLINICAL_NOTES
  UPDATE_CLINICAL_NOTES
  DELETE_CLINICAL_NOTES

  // Perfis ClÃ­nicos
  VIEW_CLINICAL_PROFILE
  CREATE_CLINICAL_PROFILE
  UPDATE_CLINICAL_PROFILE

  // Alergias
  VIEW_ALLERGIES
  CREATE_ALLERGIES
  UPDATE_ALLERGIES
  DELETE_ALLERGIES

  // CondiÃ§Ãµes CrÃ´nicas
  VIEW_CONDITIONS
  CREATE_CONDITIONS
  UPDATE_CONDITIONS
  DELETE_CONDITIONS

  // RestriÃ§Ãµes Alimentares
  VIEW_DIETARY_RESTRICTIONS
  CREATE_DIETARY_RESTRICTIONS
  UPDATE_DIETARY_RESTRICTIONS
  DELETE_DIETARY_RESTRICTIONS

  // GestÃ£o de Leitos
  VIEW_BEDS
  MANAGE_BEDS

  // Infraestrutura (PrÃ©dios, Andares, Quartos, Leitos)
  MANAGE_INFRASTRUCTURE

  // Documentos
  VIEW_DOCUMENTS
  UPLOAD_DOCUMENTS
  DELETE_DOCUMENTS

  // UsuÃ¡rios e PermissÃµes
  VIEW_USERS
  CREATE_USERS
  UPDATE_USERS
  DELETE_USERS
  MANAGE_PERMISSIONS

  // RelatÃ³rios e Auditoria
  VIEW_REPORTS
  EXPORT_DATA
  VIEW_AUDIT_LOGS

  // Conformidade RDC 502/2021 (acesso restrito a gestores)
  VIEW_COMPLIANCE_DASHBOARD // Acessar dashboard de conformidade RDC
  VIEW_SENTINEL_EVENTS // Visualizar e gerenciar eventos sentinela

  // ConfiguraÃ§Ãµes Institucionais
  VIEW_INSTITUTIONAL_SETTINGS
  UPDATE_INSTITUTIONAL_SETTINGS

  // Perfil Institucional
  VIEW_INSTITUTIONAL_PROFILE
  UPDATE_INSTITUTIONAL_PROFILE

  // POPs (Procedimentos Operacionais PadrÃ£o)
  VIEW_POPS
  CREATE_POPS
  UPDATE_POPS
  DELETE_POPS
  PUBLISH_POPS
  MANAGE_POPS

  // Agenda do Residente
  VIEW_RESIDENT_SCHEDULE
  MANAGE_RESIDENT_SCHEDULE

  // Eventos Institucionais (Documentos, Treinamentos, ReuniÃµes, InspeÃ§Ãµes, etc)
  VIEW_INSTITUTIONAL_EVENTS
  CREATE_INSTITUTIONAL_EVENTS
  UPDATE_INSTITUTIONAL_EVENTS
  DELETE_INSTITUTIONAL_EVENTS

  // Mensagens Internas
  VIEW_MESSAGES
  SEND_MESSAGES
  DELETE_MESSAGES
  BROADCAST_MESSAGES

  // Contratos de Residentes
  VIEW_CONTRACTS
  CREATE_CONTRACTS
  UPDATE_CONTRACTS
  DELETE_CONTRACTS
  REPLACE_CONTRACTS

  @@map("PermissionType")
}

// ENUM: Cargos ILPI (baseado em funÃ§Ãµes reais de uma ILPI)
enum PositionCode {
  ADMINISTRATOR // Administrador da ILPI
  TECHNICAL_MANAGER // ResponsÃ¡vel TÃ©cnico (nÃ­vel superior)
  NURSING_COORDINATOR // Coordenador de Enfermagem
  NURSE // Enfermeiro
  NURSING_TECHNICIAN // TÃ©cnico de Enfermagem
  NURSING_ASSISTANT // Auxiliar de Enfermagem
  DOCTOR // MÃ©dico
  PSYCHOLOGIST // PsicÃ³logo
  SOCIAL_WORKER // Assistente Social
  PHYSIOTHERAPIST // Fisioterapeuta
  NUTRITIONIST // Nutricionista
  SPEECH_THERAPIST // FonoaudiÃ³logo
  OCCUPATIONAL_THERAPIST // Terapeuta Ocupacional
  CAREGIVER // Cuidador de Idosos
  ADMINISTRATIVE // Administrativo
  ADMINISTRATIVE_ASSISTANT // Assistente Administrativo
  OTHER // Outros

  @@map("PositionCode")
}

// ENUM: Tipo de Registro Profissional
enum RegistrationType {
  COREN // Conselho Regional de Enfermagem
  CRM // Conselho Regional de Medicina
  CRN // Conselho Regional de NutriÃ§Ã£o
  CREFITO // Conselho Regional de Fisioterapia e Terapia Ocupacional
  CRP // Conselho Regional de Psicologia
  CREFONO // Conselho Regional de Fonoaudiologia
  CRESS // Conselho Regional de ServiÃ§o Social
  NONE // Sem registro (para cargos que nÃ£o exigem)

  @@map("RegistrationType")
}

// ENUM: AÃ§Ãµes de Acesso para Logs de Auditoria
enum AccessAction {
  LOGIN // Login bem-sucedido
  LOGOUT // Logout
  PASSWORD_CHANGED // Senha alterada pelo usuÃ¡rio
  SESSION_REVOKED // SessÃ£o revogada manualmente
  FORCE_PASSWORD_CHANGE // Troca forÃ§ada de senha (primeiro login)

  @@map("AccessAction")
}

// Enum para versionamento - Tipo de alteraÃ§Ã£o no histÃ³rico
enum ChangeType {
  CREATE // CriaÃ§Ã£o inicial do registro
  UPDATE // AtualizaÃ§Ã£o de campos
  DELETE // Soft delete (marcaÃ§Ã£o como deletado)

  @@map("ChangeType")
}

// ==========================================
// TENANT E STATUS (2 enums)
// ==========================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL

  @@map("TenantStatus")
}

enum LegalNature {
  ASSOCIACAO // AssociaÃ§Ã£o sem fins lucrativos
  FUNDACAO // FundaÃ§Ã£o privada
  EMPRESA_PRIVADA // Empresa privada
  MEI // Microempreendedor Individual

  @@map("LegalNature")
}

// ==========================================
// DADOS DEMOGRÃFICOS (3 enums)
// ==========================================

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO

  @@map("Gender")
}

enum CivilStatus {
  SOLTEIRO
  CASADO
  DIVORCIADO
  VIUVO
  UNIAO_ESTAVEL

  @@map("CivilStatus")
}

enum BloodType {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
  NAO_INFORMADO

  @@map("BloodType")
}

// ==========================================
// REGISTROS DIÃRIOS (4 enums)
// ==========================================

enum RecordType {
  HIGIENE
  ALIMENTACAO
  HIDRATACAO
  MONITORAMENTO
  ELIMINACAO
  COMPORTAMENTO
  HUMOR
  SONO
  PESO
  INTERCORRENCIA
  ATIVIDADES
  VISITA
  OUTROS

  @@map("RecordType")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ENUMS PARA GESTÃƒO DE INTERCORRÃŠNCIAS E RDC 502/2021
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum IncidentCategory {
  CLINICA // IntercorrÃªncias clÃ­nicas (saÃºde)
  ASSISTENCIAL // IntercorrÃªncias assistenciais (cuidados)
  ADMINISTRATIVA // IntercorrÃªncias administrativas (gestÃ£o)

  @@map("IncidentCategory")
}

enum IncidentSubtypeClinical {
  QUEDA_COM_LESAO // Evento Sentinela - notificaÃ§Ã£o obrigatÃ³ria
  QUEDA_SEM_LESAO
  TENTATIVA_SUICIDIO // Evento Sentinela - notificaÃ§Ã£o obrigatÃ³ria
  DOENCA_DIARREICA_AGUDA // Indicador RDC (incidÃªncia)
  DESIDRATACAO // Indicador RDC (incidÃªncia)
  ULCERA_DECUBITO // Indicador RDC (prevalÃªncia)
  DESNUTRICAO // Indicador RDC (prevalÃªncia)
  ESCABIOSE // Indicador RDC (incidÃªncia)
  FEBRE_HIPERTERMIA
  HIPOTERMIA
  HIPOGLICEMIA
  HIPERGLICEMIA
  CONVULSAO
  ALTERACAO_CONSCIENCIA
  DOR_TORACICA
  DISPNEIA
  VOMITO
  SANGRAMENTO
  REACAO_ALERGICA
  OBITO // Indicador RDC (mortalidade)
  OUTRA_CLINICA

  @@map("IncidentSubtypeClinical")
}

enum IncidentSubtypeAssistencial {
  ERRO_MEDICACAO
  RECUSA_MEDICACAO
  RECUSA_ALIMENTACAO
  RECUSA_HIGIENE
  RECUSA_BANHO
  AGITACAO_PSICOMOTORA
  AGRESSIVIDADE
  FUGA_EVASAO
  PERDA_OBJETOS
  DANO_EQUIPAMENTO
  OUTRA_ASSISTENCIAL

  @@map("IncidentSubtypeAssistencial")
}

enum IncidentSubtypeAdministrativa {
  AUSENCIA_PROFISSIONAL
  FALTA_INSUMO
  FALTA_MEDICAMENTO
  EQUIPAMENTO_QUEBRADO
  PROBLEMA_INFRAESTRUTURA
  RECLAMACAO_FAMILIAR
  CONFLITO_EQUIPE
  OUTRA_ADMINISTRATIVA

  @@map("IncidentSubtypeAdministrativa")
}

enum IncidentSeverity {
  LEVE // Sem impacto significativo
  MODERADA // Requer atenÃ§Ã£o
  GRAVE // Requer intervenÃ§Ã£o imediata
  CRITICA // Risco de vida ou Evento Sentinela

  @@map("IncidentSeverity")
}

enum RdcIndicatorType {
  MORTALIDADE // Taxa de mortalidade
  DIARREIA_AGUDA // Taxa de incidÃªncia de doenÃ§a diarrÃ©ica aguda
  ESCABIOSE // Taxa de incidÃªncia de escabiose
  DESIDRATACAO // Taxa de incidÃªncia de desidrataÃ§Ã£o
  ULCERA_DECUBITO // Taxa de prevalÃªncia de Ãºlcera de decÃºbito
  DESNUTRICAO // Taxa de prevalÃªncia de desnutriÃ§Ã£o

  @@map("RdcIndicatorType")
}

enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY

  @@map("ScheduleFrequency")
}

enum ScheduledEventType {
  VACCINATION
  CONSULTATION
  EXAM
  PROCEDURE
  OTHER

  @@map("ScheduledEventType")
}

enum ScheduledEventStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  MISSED

  @@map("ScheduledEventStatus")
}

enum InstitutionalEventType {
  DOCUMENT_EXPIRY // Vencimento de documentos
  TRAINING // Treinamentos
  MEETING // ReuniÃµes
  INSPECTION // InspeÃ§Ãµes/FiscalizaÃ§Ãµes
  MAINTENANCE // ManutenÃ§Ãµes
  OTHER // Outros eventos

  @@map("InstitutionalEventType")
}

enum InstitutionalEventVisibility {
  ADMIN_ONLY // Apenas admin vÃª
  RT_ONLY // Apenas RT (ResponsÃ¡vel TÃ©cnico) vÃª
  ALL_USERS // Todos os usuÃ¡rios veem

  @@map("InstitutionalEventVisibility")
}

// ==========================================
// MEDICAÃ‡Ã•ES E PRESCRIÃ‡Ã•ES (9 enums)
// ==========================================

enum PrescriptionType {
  ROTINA
  ALTERACAO_PONTUAL
  ANTIBIOTICO
  ALTO_RISCO
  CONTROLADO
  OUTRO

  @@map("PrescriptionType")
}

enum AdministrationRoute {
  VO
  IM
  EV
  SC
  TOPICA
  SL
  RETAL
  OCULAR
  NASAL
  INALATORIA
  OUTRA

  @@map("AdministrationRoute")
}

enum MedicationPresentation {
  COMPRIMIDO
  CAPSULA
  AMPOLA
  GOTAS
  SOLUCAO
  SUSPENSAO
  POMADA
  CREME
  SPRAY
  INALADOR
  ADESIVO
  SUPOSITORIO
  OUTRO

  @@map("MedicationPresentation")
}

enum NotificationType {
  AMARELA
  AZUL
  BRANCA_ESPECIAL
  NAO_APLICA

  @@map("NotificationType")
}

enum ControlledClass {
  BZD
  PSICOFARMACO
  OPIOIDE
  ANTICONVULSIVANTE
  OUTRO

  @@map("ControlledClass")
}

enum MedicationFrequency {
  UMA_VEZ_DIA
  DUAS_VEZES_DIA
  SEIS_SEIS_H
  OITO_OITO_H
  DOZE_DOZE_H
  PERSONALIZADO

  @@map("MedicationFrequency")
}

enum SOSIndicationType {
  DOR
  FEBRE
  ANSIEDADE
  AGITACAO
  NAUSEA
  INSONIA
  OUTRO

  @@map("SOSIndicationType")
}

// ==========================================
// SAÃšDE E BEM-ESTAR (4 enums)
// ==========================================

// ENUM: ProfissÃµes para EvoluÃ§Ãµes ClÃ­nicas (SOAP)
enum ClinicalProfession {
  MEDICINE // MÃ©dico
  NURSING // Enfermagem
  NUTRITION // NutriÃ§Ã£o
  PHYSIOTHERAPY // Fisioterapia
  PSYCHOLOGY // Psicologia
  SOCIAL_WORK // ServiÃ§o Social
  SPEECH_THERAPY // Fonoaudiologia
  OCCUPATIONAL_THERAPY // Terapia Ocupacional

  @@map("ClinicalProfession")
}

enum AllergySeverity {
  LEVE
  MODERADA
  GRAVE
  ANAFILAXIA

  @@map("AllergySeverity")
}

enum RestrictionType {
  ALERGIA_ALIMENTAR
  INTOLERANCIA
  RESTRICAO_MEDICA
  RESTRICAO_RELIGIOSA
  DISFAGIA
  DIABETES
  HIPERTENSAO
  OUTRA

  @@map("RestrictionType")
}

// ==========================================
// DOCUMENTAÃ‡ÃƒO INSTITUCIONAL (2 enums)
// ==========================================

// ENUM: Status de compliance do documento
enum DocumentStatus {
  OK // Documento OK (sem vencimento ou com vencimento > 30 dias)
  PENDENTE // Documento obrigatÃ³rio nÃ£o enviado
  VENCENDO // Vence em <= 30 dias
  VENCIDO // Vencimento ultrapassado

  @@map("DocumentStatus")
}

// Enum para aÃ§Ãµes de histÃ³rico de documentos
enum DocumentAction {
  CREATED // Documento criado
  UPDATED // Metadados atualizados
  REPLACED // Arquivo substituÃ­do
  DELETED // Documento deletado
}

// ==========================================
// NOTIFICAÃ‡Ã•ES E ALERTAS (5 enums)
// ==========================================

enum SystemNotificationType {
  // PrescriÃ§Ãµes
  PRESCRIPTION_EXPIRED
  PRESCRIPTION_EXPIRING
  PRESCRIPTION_MISSING_RECEIPT
  PRESCRIPTION_CONTROLLED_NO_RECEIPT

  // Sinais Vitais
  VITAL_SIGN_ABNORMAL_BP
  VITAL_SIGN_ABNORMAL_GLUCOSE
  VITAL_SIGN_ABNORMAL_TEMPERATURE
  VITAL_SIGN_ABNORMAL_HEART_RATE
  VITAL_SIGN_ABNORMAL_RESPIRATORY_RATE

  // Documentos
  DOCUMENT_EXPIRED
  DOCUMENT_EXPIRING

  // Registro DiÃ¡rio
  DAILY_RECORD_MISSING

  // MedicaÃ§Ã£o
  MEDICATION_ADMINISTRATION_MISSED
  MEDICATION_ADMINISTRATION_LATE

  // POPs
  POP_REVIEW_DUE

  // Sistema
  SYSTEM_UPDATE
  SYSTEM_MAINTENANCE
  USER_MENTION

  // Agendamentos
  SCHEDULED_EVENT_DUE
  SCHEDULED_EVENT_MISSED

  // Eventos Institucionais
  INSTITUTIONAL_EVENT_CREATED
  INSTITUTIONAL_EVENT_UPDATED
  INSTITUTIONAL_EVENT_DUE

  // IntercorrÃªncias e Eventos Sentinela (RDC 502/2021)
  INCIDENT_CREATED
  INCIDENT_SENTINEL_EVENT
  INCIDENT_RDC_INDICATOR_ALERT
}

enum NotificationCategory {
  PRESCRIPTION
  VITAL_SIGN
  DOCUMENT
  DAILY_RECORD
  MEDICATION
  POP
  SYSTEM
  SCHEDULED_EVENT
  INSTITUTIONAL_EVENT
  INCIDENT // IntercorrÃªncias e Eventos Sentinela
}

enum NotificationSeverity {
  CRITICAL // Requer aÃ§Ã£o imediata (vermelho)
  WARNING // Requer atenÃ§Ã£o (amarelo/laranja)
  INFO // Informativo (azul)
  SUCCESS // Sucesso (verde)
}

enum AlertType {
  PAYMENT_FAILED
  PAYMENT_OVERDUE
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_CANCELLED
  USAGE_LIMIT_EXCEEDED
  TENANT_SUSPENDED
  SYSTEM_ERROR

  @@map("AlertType")
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL

  @@map("AlertSeverity")
}

// ==========================================
// CONTRATOS DE RESIDENTES (1 enum)
// ==========================================

enum ContractDocumentStatus {
  VIGENTE // Contrato vigente/ativo
  VENCENDO_EM_30_DIAS // Contrato vence em 30 dias ou menos
  VENCIDO // Contrato vencido

  @@map("ContractDocumentStatus")
}

// ==========================================
// POPs - PROCEDIMENTOS OPERACIONAIS PADRÃƒO (3 enums)
// ==========================================

enum PopStatus {
  DRAFT // Rascunho (criado por RT ou sugestÃ£o de enfermeiro)
  PUBLISHED // Publicado e vigente
  OBSOLETE // SubstituÃ­do ou descontinuado

  @@map("PopStatus")
}

enum PopCategory {
  GESTAO_OPERACAO // GestÃ£o e OperaÃ§Ã£o (8 templates)
  ENFERMAGEM_CUIDADOS // Enfermagem e Cuidados (20 templates)

  @@map("PopCategory")
}

enum PopAction {
  CREATED // POP criado
  UPDATED // ConteÃºdo atualizado
  PUBLISHED // Publicado (de DRAFT para PUBLISHED)
  VERSIONED // Nova versÃ£o criada
  OBSOLETED // Marcado como obsoleto
  DELETED // Soft delete

  @@map("PopAction")
}

// ==========================================
// COMUNICAÃ‡ÃƒO E EMAIL (6 enums)
// ==========================================

enum EmailTemplateCategory {
  ONBOARDING // user-invite
  BILLING // payment-reminder, overdue-report
  LIFECYCLE // trial-expiring, trial-converted
  INCIDENT // sentinel-event-alert, incident-notifications
  SYSTEM // outros

  @@map("EmailTemplateCategory")
}

// Enum: EmailStatus (Status de envio de email)
enum EmailStatus {
  SENT // Email enviado com sucesso
  FAILED // Falha no envio
  BOUNCED // Email retornou (bounce)

  @@map("EmailStatus")
}

enum MessageType {
  DIRECT // Mensagem 1:1 entre usuÃ¡rios
  BROADCAST // Admin/RT â†’ todos os usuÃ¡rios do tenant

  @@map("MessageType")
}

enum MessageStatus {
  SENT // Enviada
  DELIVERED // Entregue (visualizada na lista)
  READ // Lida (aberta pelo usuÃ¡rio)

  @@map("MessageStatus")
}

// Enum: MessageRecipientFilter (Filtro de destinatÃ¡rios para TenantMessage)
enum MessageRecipientFilter {
  ALL_TENANTS // Todos os tenants
  ACTIVE_ONLY // Apenas tenants com subscription ativa
  TRIAL_ONLY // Apenas tenants em trial
  OVERDUE_ONLY // Apenas tenants inadimplentes
  SPECIFIC_TENANTS // Lista especÃ­fica de tenants

  @@map("MessageRecipientFilter")
}

// Enum: TenantMessageStatus (Status da mensagem aos tenants)
enum TenantMessageStatus {
  DRAFT // Rascunho (nÃ£o enviado)
  SCHEDULED // Agendado para envio futuro
  SENDING // Enviando (em progresso)
  SENT // Enviado com sucesso

  @@map("TenantMessageStatus")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INFRAESTRUTURA FÃSICA
//
//  PrÃ©dios, Andares, Quartos, Leitos e TransferÃªncias
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Building {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  name        String // "Casa Principal", "Bloco A"
  code        String // "PRED-001", "BLOCO-A"
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floors Floor[]

  @@index([tenantId, isActive])
  @@map("buildings")
}

model Floor {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  buildingId  String    @db.Uuid
  name        String // "TÃ©rreo", "1Âº Andar", "Ala Feminina"
  code        String // "PISO-0", "PISO-1"
  orderIndex  Int       @default(0) // OrdenaÃ§Ã£o visual (crescente)
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@index([tenantId, buildingId])
  @@index([buildingId, orderIndex])
  @@index([deletedAt])
  @@map("floors")
}

model Room {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  floorId            String    @db.Uuid
  name               String // "101", "Quarto 3"
  code               String // "Q-101", "Q-102"
  roomNumber         String // "101", "102"
  capacity           Int       @default(1) // NÃºmero total de leitos (calculado automaticamente)
  roomType           String? // "Coletivo", "SuÃ­te", "Enfermaria", "Individual", "Duplo", "Triplo"
  genderRestriction  String? // null, "M", "F"
  hasBathroom        Boolean   @default(false) // Se o quarto tem banheiro
  hasPrivateBathroom Boolean   @default(false) // Se tem banheiro privativo
  accessible         Boolean   @default(false) // Se Ã© acessÃ­vel para PCD
  observations       String?   @db.Text // ObservaÃ§Ãµes adicionais
  notes              String?   @db.Text
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt          DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt          DateTime? @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floor  Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds   Bed[]

  @@index([tenantId, floorId])
  @@index([floorId, isActive])
  @@index([deletedAt])
  @@map("rooms")
}

model Bed {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @db.Uuid
  roomId    String    @db.Uuid
  code      String // "101-A", "101-B", "Leito 1"
  status    String    @default("DisponÃ­vel") // "DisponÃ­vel", "Ocupado", "ManutenÃ§Ã£o" (calculado dinamicamente)
  notes     String?   @db.Text
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room           Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  resident       Resident?
  transfersFrom  BedTransferHistory[] @relation("BedTransferFrom")
  transfersTo    BedTransferHistory[] @relation("BedTransferTo")
  statusHistory  BedStatusHistory[]

  @@unique([tenantId, code]) // CÃ³digo do leito Ãºnico por tenant
  @@index([tenantId, roomId])
  @@index([roomId, status])
  @@index([tenantId, status])
  @@index([deletedAt])
  @@map("beds")
}

model BedTransferHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Leitos
  fromBedId String @db.Uuid
  toBedId   String @db.Uuid

  // Motivo da transferÃªncia
  reason String @db.Text // ObrigatÃ³rio, min 10 chars

  // Data e hora da transferÃªncia
  transferredAt DateTime @default(now()) @db.Timestamptz(3)

  // Auditoria
  transferredBy String    @db.Uuid // ID do usuÃ¡rio que realizou a transferÃªncia
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  fromBed  Bed      @relation("BedTransferFrom", fields: [fromBedId], references: [id], onDelete: Restrict)
  toBed    Bed      @relation("BedTransferTo", fields: [toBedId], references: [id], onDelete: Restrict)
  user     User     @relation(fields: [transferredBy], references: [id], onDelete: Restrict)

  // Ãndices
  @@index([tenantId, residentId])
  @@index([residentId, transferredAt(sort: Desc)])
  @@index([fromBedId])
  @@index([toBedId])
  @@index([deletedAt])
  @@map("bed_transfer_history")
}

model BedStatusHistory {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  bedId          String   @db.Uuid
  previousStatus String   @db.VarChar(50)
  newStatus      String   @db.VarChar(50)
  reason         String?  @db.Text
  metadata       Json?
  changedBy      String   @db.Uuid
  changedAt      DateTime @default(now()) @db.Timestamptz(3)
  createdAt      DateTime @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bed    Bed    @relation(fields: [bedId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([bedId, changedAt(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([tenantId, bedId])
  @@map("bed_status_history")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EVENTOS INSTITUCIONAIS
//
//  Eventos da prÃ³pria instituiÃ§Ã£o (vencimentos, treinamentos, reuniÃµes, etc.)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model InstitutionalEvent {
  id            String                       @id @default(uuid()) @db.Uuid
  tenantId      String                       @db.Uuid
  eventType     InstitutionalEventType
  visibility    InstitutionalEventVisibility @default(ALL_USERS)
  title         String
  description   String?                      @db.Text
  scheduledDate DateTime                     @db.Date
  scheduledTime String? // Formato HH:mm
  allDay        Boolean                      @default(false)
  status        ScheduledEventStatus         @default(SCHEDULED)
  completedAt   DateTime?                    @db.Timestamptz(3)
  notes         String?                      @db.Text

  // Campos especÃ­ficos para vencimento de documentos
  documentType   String?
  documentNumber String?
  expiryDate     DateTime? @db.Date
  responsible    String?

  // Campos especÃ­ficos para treinamentos
  trainingTopic  String?
  instructor     String?
  targetAudience String?
  location       String?

  // Metadados adicionais (JSON flexÃ­vel)
  metadata Json? @db.JsonB

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid

  // RelaÃ§Ãµes
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser User   @relation("InstitutionalEventCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  updatedByUser User?  @relation("InstitutionalEventUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)

  // Ãndices
  @@index([tenantId])
  @@index([scheduledDate])
  @@index([eventType])
  @@index([visibility])
  @@index([status])
  @@index([deletedAt])
  @@index([tenantId, scheduledDate])
  @@index([tenantId, eventType, scheduledDate])
  @@index([expiryDate])
  @@map("institutional_events")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MEDICAÃ‡Ã•ES E PRESCRIÃ‡Ã•ES
//
//  PrescriÃ§Ãµes, medicamentos regulares, SOS e administraÃ§Ã£o
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Prescription {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados do Prescritor
  doctorName       String
  doctorCrm        String
  doctorCrmState   String // UF
  prescriptionDate DateTime         @db.Date
  prescriptionType PrescriptionType
  validUntil       DateTime?        @db.Date // ObrigatÃ³rio para ANTIBIOTICO e CONTROLADO
  reviewDate       DateTime?        @db.Date // Data estimada para revisÃ£o da prescriÃ§Ã£o

  // Campos especÃ­ficos para CONTROLADO
  controlledClass    ControlledClass?
  notificationNumber String?
  notificationType   NotificationType?

  // Anexos
  prescriptionImageUrl String? // URL da receita mÃ©dica (obrigatÃ³rio para controlado)

  // ObservaÃ§Ãµes gerais
  notes String? @db.Text

  // RevisÃ£o MÃ©dica (quando prescriÃ§Ã£o Ã© revisada por mÃ©dico)
  lastMedicalReviewDate DateTime? @db.Date // Data da consulta mÃ©dica
  lastReviewedByDoctor  String? // Nome do mÃ©dico que revisou
  lastReviewDoctorCrm   String? // CRM do mÃ©dico revisor
  lastReviewDoctorState String? // UF do CRM do mÃ©dico revisor
  lastReviewNotes       String?   @db.Text // ObservaÃ§Ãµes da revisÃ£o

  // Status
  isActive Boolean @default(true)

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // NÃºmero da versÃ£o atual (incrementado a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String    @db.Uuid // ID do usuÃ¡rio que criou
  updatedBy     String?   @db.Uuid // ID do Ãºltimo usuÃ¡rio que alterou

  // RelaÃ§Ãµes
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident           Resident                   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  medications        Medication[]
  sosMedications     SOSMedication[]
  administrations    MedicationAdministration[]
  sosAdministrations SOSAdministration[]
  history            PrescriptionHistory[] // HistÃ³rico de versÃµes da prescriÃ§Ã£o

  // Ãndices
  @@index([tenantId, residentId])
  @@index([tenantId, isActive])
  @@index([tenantId, validUntil])
  @@index([tenantId, lastMedicalReviewDate])
  @@index([deletedAt])
  // Ãndices compostos para queries frequentes
  @@index([tenantId, residentId, isActive]) // Listar prescriÃ§Ãµes ativas do residente
  @@index([tenantId, isActive, validUntil]) // PrescriÃ§Ãµes ativas prÃ³ximas do vencimento
  @@map("prescriptions")
}

model PrescriptionHistory {
  id             String     @id @default(uuid()) @db.Uuid
  tenantId       String     @db.Uuid
  prescriptionId String     @db.Uuid
  versionNumber  Int // NÃºmero da versÃ£o (1, 2, 3, ...)
  changeType     ChangeType // CREATE | UPDATE | DELETE
  changeReason   String     @db.Text // Motivo obrigatÃ³rio da alteraÃ§Ã£o

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual apÃ³s a alteraÃ§Ã£o

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["doctorName", "validUntil", "medications.0.dose"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteraÃ§Ã£o
  changedBy     String   @db.Uuid // ID do usuÃ¡rio que fez a alteraÃ§Ã£o
  changedByName String? // Nome do usuÃ¡rio (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisiÃ§Ã£o
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexÃ­vel)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // RelaÃ§Ãµes
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  user         User         @relation("PrescriptionHistoryUser", fields: [changedBy], references: [id])

  // Ãndices para performance
  @@index([tenantId, prescriptionId, versionNumber(sort: Desc)]) // Buscar histÃ³rico de uma prescriÃ§Ã£o
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alteraÃ§Ãµes recentes do tenant
  @@index([changedBy]) // Buscar alteraÃ§Ãµes por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("prescription_history")
}

model Medication {
  id             String @id @default(uuid()) @db.Uuid
  prescriptionId String @db.Uuid

  // Dados do medicamento
  name           String // DCB (DenominaÃ§Ã£o Comum Brasileira)
  presentation   MedicationPresentation
  concentration  String // Ex: "500mg", "5mg/mL"
  dose           String // Ex: "1 cp", "20 gotas"
  route          AdministrationRoute
  frequency      MedicationFrequency
  scheduledTimes Json                   @default("[]") // Array de horÃ¡rios: ["06:00", "14:00", "22:00"]

  // PerÃ­odo
  startDate DateTime  @db.Date
  endDate   DateTime? @db.Date // null = uso contÃ­nuo

  // Flags especiais
  isControlled        Boolean @default(false)
  isHighRisk          Boolean @default(false)
  requiresDoubleCheck Boolean @default(false) // Exige dupla checagem

  // ObservaÃ§Ãµes
  instructions String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  prescription    Prescription               @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  administrations MedicationAdministration[]
  history         MedicationHistory[]
  locks           MedicationLock[] // Sprint 2: Locks para prevenir administraÃ§Ã£o duplicada
  createdByUser   User                       @relation("MedicationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?                      @relation("MedicationUpdatedBy", fields: [updatedBy], references: [id])

  // Ãndices
  @@index([prescriptionId])
  @@index([isControlled])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  // Ãndices compostos para queries frequentes
  @@index([prescriptionId, deletedAt]) // Medicamentos ativos de uma prescriÃ§Ã£o
  @@index([prescriptionId, startDate, endDate]) // Medicamentos vigentes de uma prescriÃ§Ã£o
  @@map("medications")
}

model MedicationHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  medicationId  String     @db.Uuid
  versionNumber Int // NÃºmero da versÃ£o (1, 2, 3, ...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo obrigatÃ³rio da alteraÃ§Ã£o

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual apÃ³s a alteraÃ§Ã£o

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["name", "dose", "frequency"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteraÃ§Ã£o
  changedBy     String   @db.Uuid // ID do usuÃ¡rio que fez a alteraÃ§Ã£o
  changedByName String? // Nome do usuÃ¡rio (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisiÃ§Ã£o
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexÃ­vel)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // RelaÃ§Ãµes
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  user       User       @relation("MedicationHistoryUser", fields: [changedBy], references: [id])

  // Ãndices para performance
  @@index([tenantId, medicationId, versionNumber(sort: Desc)]) // Buscar histÃ³rico de um medicamento
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alteraÃ§Ãµes recentes do tenant
  @@index([changedBy]) // Buscar alteraÃ§Ãµes por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("medication_history")
}

model SOSMedication {
  id             String @id @default(uuid()) @db.Uuid
  prescriptionId String @db.Uuid

  // Dados do medicamento
  name          String
  presentation  MedicationPresentation
  concentration String
  dose          String
  route         AdministrationRoute

  // IndicaÃ§Ã£o e limites
  indication        SOSIndicationType
  indicationDetails String? // Ex: "dor > 7", "febre > 38Â°C"
  minInterval       String // Ex: "6 horas", "4 horas"
  maxDailyDoses     Int // Limite diÃ¡rio (ex: 3)

  // PerÃ­odo de validade
  startDate DateTime  @db.Date
  endDate   DateTime? @db.Date

  // ObservaÃ§Ãµes
  instructions String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  prescription       Prescription           @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosAdministrations SOSAdministration[]
  history            SOSMedicationHistory[]
  createdByUser      User                   @relation("SOSMedicationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?                  @relation("SOSMedicationUpdatedBy", fields: [updatedBy], references: [id])

  // Ãndices
  @@index([prescriptionId])
  @@index([indication])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("sos_medications")
}

model SOSMedicationHistory {
  id              String     @id @default(uuid()) @db.Uuid
  tenantId        String     @db.Uuid
  sosMedicationId String     @db.Uuid
  versionNumber   Int // NÃºmero da versÃ£o (1, 2, 3, ...)
  changeType      ChangeType // CREATE | UPDATE | DELETE
  changeReason    String     @db.Text // Motivo obrigatÃ³rio da alteraÃ§Ã£o

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual apÃ³s a alteraÃ§Ã£o

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["name", "dose", "indication"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteraÃ§Ã£o
  changedBy     String   @db.Uuid // ID do usuÃ¡rio que fez a alteraÃ§Ã£o
  changedByName String? // Nome do usuÃ¡rio (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisiÃ§Ã£o
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexÃ­vel)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // RelaÃ§Ãµes
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  user          User          @relation("SOSMedicationHistoryUser", fields: [changedBy], references: [id])

  // Ãndices para performance
  @@index([tenantId, sosMedicationId, versionNumber(sort: Desc)]) // Buscar histÃ³rico de um medicamento SOS
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alteraÃ§Ãµes recentes do tenant
  @@index([changedBy]) // Buscar alteraÃ§Ãµes por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("sos_medication_history")
}

model MedicationAdministration {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  prescriptionId String @db.Uuid
  medicationId   String @db.Uuid
  residentId     String @db.Uuid

  // Data/hora da administraÃ§Ã£o
  date          DateTime @db.Date
  scheduledTime String // HorÃ¡rio programado (ex: "06:00")
  actualTime    String? // HorÃ¡rio real de administraÃ§Ã£o (se diferente)

  // Status
  wasAdministered Boolean @default(false)
  reason          String? // Motivo de nÃ£o administraÃ§Ã£o

  // Checagem
  administeredBy  String // Nome do profissional
  userId          String  @db.Uuid
  checkedBy       String? // Para dupla checagem
  checkedByUserId String? @db.Uuid

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication   Medication   @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Ãndices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([medicationId, date])
  @@index([wasAdministered])
  // Ãndices compostos para queries frequentes
  @@index([tenantId, date, wasAdministered]) // AdministraÃ§Ãµes pendentes do dia
  @@index([residentId, date, wasAdministered]) // AdministraÃ§Ãµes pendentes do residente
  @@map("medication_administrations")
}

model SOSAdministration {
  id              String @id @default(uuid()) @db.Uuid
  tenantId        String @db.Uuid
  prescriptionId  String @db.Uuid
  sosMedicationId String @db.Uuid
  residentId      String @db.Uuid

  // Data/hora
  date DateTime @db.Date
  time String // HorÃ¡rio da administraÃ§Ã£o

  // Motivo
  indication String // DescriÃ§Ã£o do motivo (ex: "dor intensa no joelho")

  // Checagem
  administeredBy String
  userId         String @db.Uuid

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription  Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  resident      Resident      @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Ãndices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([sosMedicationId, date])
  @@map("sos_administrations")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NOTIFICAÃ‡Ã•ES E ALERTAS
//
//  Sistema de notificaÃ§Ãµes e alertas do sistema
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Notification {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // Tipo e Categoria
  type     SystemNotificationType
  category NotificationCategory
  severity NotificationSeverity

  // ConteÃºdo
  title     String  @db.VarChar(255)
  message   String  @db.Text
  actionUrl String? @db.Text // URL para navegaÃ§Ã£o ao clicar

  // ReferÃªncia Ã  entidade relacionada
  entityType String? @db.VarChar(50) // Ex: "PRESCRIPTION", "VITAL_SIGN"
  entityId   String? @db.Uuid

  // Metadata flexÃ­vel para informaÃ§Ãµes adicionais
  metadata Json? @db.JsonB

  // ExpiraÃ§Ã£o automÃ¡tica
  expiresAt DateTime? @db.Timestamptz(3)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant                     Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reads                      NotificationRead[] // Rastreamento individual de leitura
  vitalSignAlerts            VitalSignAlert[] // Alertas mÃ©dicos vinculados a esta notificaÃ§Ã£o
  sentinelEventNotifications SentinelEventNotification[] // NotificaÃ§Ãµes de Eventos Sentinela

  // Ãndices para performance
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, category, createdAt(sort: Desc)])
  @@index([tenantId, severity, createdAt(sort: Desc)])
  @@index([type])
  @@index([category])
  @@index([severity])
  @@index([expiresAt])
  @@index([tenantId, type]) // NotificaÃ§Ãµes por tipo
  @@index([entityType, entityId]) // Buscar notificaÃ§Ãµes de uma entidade especÃ­fica
  @@map("notifications")
}

// Tabela de rastreamento individual de leitura de notificaÃ§Ãµes
model NotificationRead {
  id             String   @id @default(uuid()) @db.Uuid
  notificationId String   @db.Uuid
  userId         String   @db.Uuid
  readAt         DateTime @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ãndices para performance
  @@unique([notificationId, userId]) // Um usuÃ¡rio sÃ³ pode marcar como lida uma vez
  @@index([userId, readAt(sort: Desc)]) // HistÃ³rico de leituras do usuÃ¡rio
  @@index([notificationId]) // Buscar leituras de uma notificaÃ§Ã£o
  @@map("notification_reads")
}

model SystemAlert {
  id        String        @id @default(uuid()) @db.Uuid
  type      AlertType
  severity  AlertSeverity
  title     String        @db.VarChar(255)
  message   String        @db.Text
  metadata  Json?         @db.JsonB
  tenantId  String?       @db.Uuid
  read      Boolean       @default(false)
  readAt    DateTime?     @db.Timestamptz(3)
  createdAt DateTime      @default(now()) @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([type, severity])
  @@index([read])
  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  // Ãndices compostos adicionais para queries frequentes
  @@index([tenantId, read, createdAt(sort: Desc)]) // Alertas nÃ£o lidos do tenant
  @@index([type, read, createdAt(sort: Desc)]) // Alertas nÃ£o lidos por tipo
  @@map("system_alerts")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  POPs - PROCEDIMENTOS OPERACIONAIS PADRÃƒO
//
//  GestÃ£o de POPs institucionais com versionamento
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Pop {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // IdentificaÃ§Ã£o
  title      String      @db.VarChar(255)
  category   PopCategory
  templateId String?     @db.VarChar(100) // ID do template (ex: "POP_HIGIENIZACAO_MAOS")

  // ConteÃºdo (HTML do Tiptap - headings, listas, tabelas)
  content String @db.Text

  // Status e Workflow
  status PopStatus @default(DRAFT)

  // Versionamento
  version      Int       @default(1)
  replacedById String?   @db.Uuid
  replacedAt   DateTime? @db.Timestamptz(3)

  // RevisÃ£o periÃ³dica
  reviewIntervalMonths Int?
  lastReviewedAt       DateTime? @db.Timestamptz(3)
  nextReviewDate       DateTime? @db.Timestamptz(3)
  requiresReview       Boolean   @default(false)

  // ObservaÃ§Ãµes
  notes String? @db.Text

  // Auditoria
  createdBy   String    @db.Uuid
  updatedBy   String?   @db.Uuid
  publishedBy String?   @db.Uuid
  publishedAt DateTime? @db.Timestamptz(3)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replacedBy  Pop?            @relation("PopReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces    Pop[]           @relation("PopReplacement")
  attachments PopAttachment[]
  history     PopHistory[]

  // Ãndices
  @@index([tenantId, status])
  @@index([tenantId, category, status])
  @@index([tenantId, templateId])
  @@index([status])
  @@index([category])
  @@index([nextReviewDate])
  @@index([requiresReview])
  @@index([replacedById])
  @@index([deletedAt])
  @@map("pops")
}

model PopHistory {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  popId    String @db.Uuid

  // AÃ§Ã£o e motivo
  action PopAction
  reason String?   @db.Text

  // Snapshots para auditoria
  previousData  Json?    @db.JsonB
  newData       Json?    @db.JsonB
  changedFields String[] @default([])

  // Auditoria
  changedBy     String   @db.Uuid
  changedByName String   @db.VarChar(255)
  changedAt     DateTime @default(now()) @db.Timestamptz(3)
  ipAddress     String?  @db.VarChar(45)
  userAgent     String?  @db.Text

  // RelaÃ§Ãµes
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pop    Pop    @relation(fields: [popId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([tenantId, popId, changedAt(sort: Desc)])
  @@index([popId, action])
  @@index([changedAt(sort: Desc)])
  @@index([action])
  @@map("pop_history")
}

model PopAttachment {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  popId    String @db.Uuid

  // Arquivo
  fileUrl  String  @db.Text
  fileKey  String? @db.Text
  fileName String  @db.VarChar(255)
  fileSize Int?
  mimeType String? @db.VarChar(100)

  // Metadados opcionais
  description String? @db.Text
  type        String? @db.VarChar(50) // FORMULARIO, CHECKLIST, FLUXOGRAMA, etc.

  // Auditoria
  uploadedBy String    @db.Uuid
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pop    Pop    @relation(fields: [popId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([tenantId, popId])
  @@index([popId])
  @@index([deletedAt])
  @@map("pop_attachments")
}


// ============================================================================
// RESIDENT CONTRACTS - Contratos Digitalizados dos Residentes
// ============================================================================

enum ContractHistoryAction {
  CREATED
  UPDATED
  REPLACED
  DELETED
}

enum SignatoryRole {
  RESIDENTE
  RESPONSAVEL_LEGAL
  RESPONSAVEL_CONTRATUAL
  TESTEMUNHA
  ILPI
}

model ResidentContract {
  id                     String                  @id @default(uuid()) @db.Uuid
  tenantId               String                  @db.Uuid
  residentId             String                  @db.Uuid
  contractNumber         String                  @db.VarChar(100)
  startDate              DateTime                @db.Date
  endDate                DateTime                @db.Date
  monthlyAmount          Decimal                 @db.Decimal(10, 2)
  dueDay                 Int
  status                 ContractDocumentStatus
  adjustmentIndex        String?                 @db.VarChar(50)
  adjustmentRate         Decimal?                @db.Decimal(5, 2)
  lastAdjustmentDate     DateTime?               @db.Date
  signatories            Json                    @db.JsonB
  originalFileUrl        String                  @db.Text
  originalFileKey        String                  @db.Text
  originalFileName       String                  @db.Text
  originalFileSize       Int
  originalFileMimeType   String                  @db.VarChar(100)
  originalFileHash       String                  @db.VarChar(64)
  processedFileUrl       String                  @db.Text
  processedFileKey       String                  @db.Text
  processedFileName      String                  @db.Text
  processedFileSize      Int
  processedFileHash      String                  @db.VarChar(64)
  publicToken            String                  @unique @db.VarChar(64) // Token pÃºblico para validaÃ§Ã£o de autenticidade
  notes                  String?                 @db.Text
  version                Int                     @default(1)
  replacedById           String?                 @db.Uuid
  replacedAt             DateTime?               @db.Timestamptz(3)
  uploadedBy             String                  @db.Uuid
  createdAt              DateTime                @default(now()) @db.Timestamptz(3)
  updatedAt              DateTime                @updatedAt @db.Timestamptz(3)
  deletedAt              DateTime?               @db.Timestamptz(3)

  // Relations
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident               Resident                @relation(fields: [residentId], references: [id], onDelete: Cascade)
  uploader               User                    @relation("ContractUploader", fields: [uploadedBy], references: [id])
  replacedBy             ResidentContract?       @relation("ContractReplacements", fields: [replacedById], references: [id])
  replacements           ResidentContract[]      @relation("ContractReplacements")
  history                ContractHistory[]

  @@unique([tenantId, contractNumber])
  @@index([tenantId, residentId])
  @@index([tenantId, status])
  @@index([tenantId, endDate])
  @@index([residentId])
  @@index([endDate])
  @@index([status])
  @@index([deletedAt])
  @@index([replacedById])
  @@index([version])
  @@index([processedFileHash])
  @@map("resident_contracts")
}

model ContractHistory {
  id             String                 @id @default(uuid()) @db.Uuid
  tenantId       String                 @db.Uuid
  contractId     String                 @db.Uuid
  action         ContractHistoryAction
  reason         String?                @db.Text
  previousData   Json?                  @db.JsonB
  newData        Json?                  @db.JsonB
  changedFields  String[]               @default([])
  changedBy      String                 @db.Uuid
  changedAt      DateTime               @default(now()) @db.Timestamptz(3)

  // Relations
  tenant         Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract       ResidentContract       @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user           User                   @relation("ContractHistoryUser", fields: [changedBy], references: [id])

  @@index([tenantId, contractId])
  @@index([contractId])
  @@index([action])
  @@index([changedAt])
  @@map("resident_contracts_history")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RESIDENTES
//
//  Dados demogrÃ¡ficos e documentos dos residentes
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Resident {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // 0 â€“ Status
  status String @default("Ativo") // Ativo | Inativo | Falecido

  // 1 â€“ Dados Pessoais
  fullName    String
  socialName  String?
  email       String? // Email do residente
  cpf         String
  rg          String?
  rgIssuer    String?
  education   String?
  profession  String?
  cns         String?
  gender      Gender
  civilStatus CivilStatus?
  religion    String?
  birthDate   DateTime     @db.Date
  nationality String       @default("Brasileira")
  birthCity   String?
  birthState  String? // UF (2 letras)
  motherName  String?
  fatherName  String?
  fotoUrl     String? // URL da foto do residente no MinIO

  // 2 â€“ EndereÃ§os
  // Atual
  currentCep        String?
  currentState      String?
  currentCity       String?
  currentStreet     String?
  currentNumber     String?
  currentComplement String?
  currentDistrict   String?
  currentPhone      String?

  // ProcedÃªncia (texto livre)
  origin String? // Ex: "Vindo da ClÃ­nica X", "Diretamente da residÃªncia", "IndicaÃ§Ã£o judicial"

  // 3 â€“ Contatos de EmergÃªncia (array JSON)
  emergencyContacts Json @default("[]")
  // [{ "name": "...", "phone": "...", "relationship": "..." }]

  // 4 â€“ ResponsÃ¡vel Legal
  legalGuardianName       String?
  legalGuardianEmail      String? // Email do responsÃ¡vel legal
  legalGuardianCpf        String?
  legalGuardianRg         String?
  legalGuardianPhone      String?
  legalGuardianType       String? // curador | procurador | responsÃ¡vel convencional
  legalGuardianCep        String?
  legalGuardianState      String?
  legalGuardianCity       String?
  legalGuardianStreet     String?
  legalGuardianNumber     String?
  legalGuardianComplement String?
  legalGuardianDistrict   String?

  // 5 â€“ AdmissÃ£o
  admissionDate       DateTime  @db.Date
  admissionType       String? // VoluntÃ¡ria | InvoluntÃ¡ria | Judicial | outro
  admissionReason     String?
  admissionConditions String?
  dischargeDate       DateTime? @db.Date
  dischargeReason     String?

  // 6 â€“ SaÃºde (Dados EstÃ¡veis - dados clÃ­nicos evolutivos migraram para clinical_profiles)
  bloodType              BloodType @default(NAO_INFORMADO)
  height                 Decimal?  @db.Decimal(5, 2) // metros
  weight                 Decimal?  @db.Decimal(5, 1) // kg
  dependencyLevel        String? // Grau I - Independente | Grau II - Semidependente | Grau III - Dependente
  mobilityAid            Boolean?
  medicationsOnAdmission String?

  // 7 â€“ ConvÃªnios / Planos de SaÃºde
  healthPlans Json @default("[]")
  // [{ "name": "...", "cardNumber": "...", "cardUrl": "..." }]

  // 8 â€“ Pertences
  belongings Json @default("[]")
  // ["Ã“culos", "Aparelho auditivo", ...]

  // 9 â€“ AcomodaÃ§Ã£o
  roomId String? @db.Uuid
  bedId  String? @unique @db.Uuid

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // NÃºmero da versÃ£o atual (incrementa a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String    @db.Uuid // ID do usuÃ¡rio que criou o registro
  updatedBy     String?   @db.Uuid // ID do Ãºltimo usuÃ¡rio que alterou

  // RelaÃ§Ãµes
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator                   User                       @relation("ResidentCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updater                   User?                      @relation("ResidentUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  history                   ResidentHistory[] // HistÃ³rico de alteraÃ§Ãµes (imutÃ¡vel)
  bed                       Bed?                       @relation(fields: [bedId], references: [id])
  dailyRecords              DailyRecord[]
  prescriptions             Prescription[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  vitalSigns                VitalSign[]
  clinicalNotes             ClinicalNote[]
  clinicalNoteHistory       ClinicalNoteHistory[]
  residentDocuments         ResidentDocument[]
  contracts                 ResidentContract[] // Contratos digitalizados de prestaÃ§Ã£o de serviÃ§o da ILPI
  clinicalProfile           ClinicalProfile?
  allergies                 Allergy[]
  conditions                Condition[]
  dietaryRestrictions       DietaryRestriction[]
  clinicalNoteDocuments     ClinicalNoteDocument[]
  bedTransferHistory        BedTransferHistory[]
  scheduleConfigs           ResidentScheduleConfig[]
  scheduledEvents           ResidentScheduledEvent[]
  vitalSignAlerts           VitalSignAlert[] // Alertas mÃ©dicos de sinais vitais

  // Ãndices
  @@unique([tenantId, cpf])
  @@index([tenantId, status])
  @@index([tenantId, admissionDate(sort: Desc)])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("residents")
}

model ResidentHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Versionamento
  versionNumber Int // NÃºmero da versÃ£o (1, 2, 3...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo da alteraÃ§Ã£o (obrigatÃ³rio, min 10 chars)

  // Campos alterados (array de nomes de campos)
  changedFields String[] @default([])

  // Snapshot completo dos dados (ANTES e DEPOIS da alteraÃ§Ã£o)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado novo

  // Auditoria
  changedAt DateTime @db.Timestamptz(3) // Data/hora da alteraÃ§Ã£o
  changedBy String   @db.Uuid // UsuÃ¡rio que fez a alteraÃ§Ã£o

  // Metadados opcionais (IP, User Agent, etc.)
  metadata Json? @default("{}")

  // RelaÃ§Ãµes
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation("ResidentHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)

  // Ãndices para consultas eficientes
  @@index([tenantId, residentId, versionNumber(sort: Desc)]) // Listar histÃ³rico por residente
  @@index([tenantId, changedAt(sort: Desc)]) // Auditoria geral por data
  @@index([changedBy]) // Auditar por usuÃ¡rio
  @@index([changeType]) // Filtrar por tipo de alteraÃ§Ã£o
  @@map("resident_history")
}

model ResidentDocument {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de documento
  type String @db.VarChar(100)
  // Tipos possÃ­veis:
  // - CARTAO_CONVENIO
  // - COMPROVANTE_RESIDENCIA_RESIDENTE
  // - DOCUMENTOS_RESPONSAVEL_LEGAL
  // - COMPROVANTE_RESIDENCIA_RESPONSAVEL
  // - DOCUMENTOS_PESSOAIS
  // - LAUDO_MEDICO
  // - TERMO_ADMISSAO
  // - TERMO_CONSENTIMENTO_IMAGEM
  // - TERMO_CONSENTIMENTO_LGPD

  // Arquivo
  fileUrl  String // URL completa do arquivo no S3/MinIO
  fileKey  String? // Chave do arquivo no S3 para deleÃ§Ã£o
  fileName String // Nome original do arquivo
  fileSize Int? // Tamanho em bytes
  mimeType String? @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Detalhes opcionais (ex: "Unimed", "Laudo de entrada", etc.)
  details String? @db.Text

  // Auditoria
  uploadedBy String    @db.Uuid // ID do usuÃ¡rio que fez upload
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)

  // Ãndices
  @@index([tenantId, residentId])
  @@index([residentId, type])
  @@index([deletedAt])
  @@map("resident_documents")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NÃšCLEO MULTI-TENANT
//
//  Plan, Tenant e Subscription - Hub central do sistema
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PLANOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Plan {
  id                    String       @id @default(uuid()) @db.Uuid
  name                  String       @unique
  displayName           String
  type                  PlanType
  maxResidents          Int
  maxUsers              Int
  price                 Decimal?     @db.Decimal(10, 2)
  annualDiscountPercent Decimal?     @default(0) @map("annual_discount_percent") @db.Decimal(5, 2) // Desconto para assinaturas anuais (0-100%)
  trialDays             Int          @default(0)
  isPopular             Boolean      @default(false)
  isActive              Boolean      @default(true)
  features              Json         @default("{}")
  billingCycle          BillingCycle @default(MONTHLY) // MONTHLY | ANNUAL
  createdAt             DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt             DateTime     @updatedAt @db.Timestamptz(3)

  subscriptions Subscription[]
  contracts     ServiceContract[]
  termsOfService TermsOfService[] @relation("TermsOfServicePlan")

  @@map("plans")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TENANTS (ClÃ­nicas / ResidÃªncias)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Tenant {
  id         String       @id @default(uuid()) @db.Uuid
  name       String
  slug       String       @unique
  cnpj       String?      @unique
  email      String
  phone      String?
  status     TenantStatus @default(TRIAL)
  schemaName String       @unique

  // Asaas Integration
  asaasCustomerId String? @unique @db.VarChar(255) // ID do cliente no Asaas

  // EndereÃ§o detalhado
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  // Timezone
  timezone String @default("America/Sao_Paulo") @db.VarChar(50) // Timezone IANA do tenant

  deletedAt DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  subscriptions              Subscription[]
  users                      User[]
  userProfiles               UserProfile[]
  userHistory                UserHistory[] // HistÃ³rico de usuÃ¡rios
  residents                  Resident[]
  residentHistory            ResidentHistory[] // HistÃ³rico de residentes
  dailyRecords               DailyRecord[]
  dailyRecordHistory         DailyRecordHistory[]
  vitalSigns                 VitalSign[]
  prescriptions              Prescription[]
  prescriptionHistory        PrescriptionHistory[] // HistÃ³rico de prescriÃ§Ãµes
  medicationHistory          MedicationHistory[] // HistÃ³rico de medicamentos
  sosMedicationHistory       SOSMedicationHistory[] // HistÃ³rico de medicamentos SOS
  medicationAdministrations  MedicationAdministration[]
  sosAdministrations         SOSAdministration[]
  vaccinations               Vaccination[]
  vaccinationHistory         VaccinationHistory[] // HistÃ³rico de vacinaÃ§Ãµes
  allergies                  Allergy[]
  allergyHistory             AllergyHistory[] // HistÃ³rico de alergias
  conditions                 Condition[]
  conditionHistory           ConditionHistory[] // HistÃ³rico de condiÃ§Ãµes
  clinicalNotes              ClinicalNote[]
  clinicalNoteHistory        ClinicalNoteHistory[]
  clinicalProfiles           ClinicalProfile[]
  clinicalProfileHistory     ClinicalProfileHistory[]
  dietaryRestrictions        DietaryRestriction[]
  dietaryRestrictionHistory  DietaryRestrictionHistory[]
  auditLogs                  AuditLog[]
  buildings                  Building[]
  floors                     Floor[]
  rooms                      Room[]
  beds                       Bed[]
  bedStatusHistory           BedStatusHistory[]
  profile                    TenantProfile?
  documents                  TenantDocument[]
  residentDocuments          ResidentDocument[]
  residentContracts          ResidentContract[] // Contratos de serviÃ§o dos residentes (NÃƒO confundir com ServiceContract de SaaS)
  contractHistory            ContractHistory[] // HistÃ³rico de alteraÃ§Ãµes nos contratos dos residentes
  notifications              Notification[]
  clinicalNoteDocuments      ClinicalNoteDocument[]
  documentHistory            DocumentHistory[]
  pops                       Pop[]
  popAttachments             PopAttachment[]
  popHistory                 PopHistory[]
  VitalSignHistory           VitalSignHistory[]
  bedTransferHistory         BedTransferHistory[]
  residentScheduleConfigs    ResidentScheduleConfig[]
  residentScheduledEvents    ResidentScheduledEvent[]
  invoices                   Invoice[] // SuperAdmin - Faturas
  usageMetrics               UsageMetrics[] // SuperAdmin - MÃ©tricas de uso
  systemAlerts               SystemAlert[] // SuperAdmin - Alertas
  contractAcceptance         ContractAcceptance?
  termsOfServiceAcceptance   TermsOfServiceAcceptance?
  privacyPolicyAcceptance    PrivacyPolicyAcceptance?
  messages                   Message[]
  messageRecipients          MessageRecipient[]
  messageAttachments         MessageAttachment[]
  emailLogs                  EmailLog[] // Auditoria de emails enviados
  accessLogs                 AccessLog[] // Logs de acesso e auditoria de seguranÃ§a
  vitalSignAlerts            VitalSignAlert[] // Alertas mÃ©dicos de sinais vitais
  institutionalEvents        InstitutionalEvent[] // Eventos institucionais
  incidentMonthlyIndicators  IncidentMonthlyIndicator[] // Indicadores mensais RDC 502/2021
  sentinelEventNotifications SentinelEventNotification[] // NotificaÃ§Ãµes de Eventos Sentinela

  @@index([timezone])
  @@map("tenants")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SUBSCRIPTIONS (Stripeâ€‘style)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  planId             String    @db.Uuid
  startDate          DateTime  @default(now()) @db.Timestamptz(3)
  endDate            DateTime? @db.Timestamptz(3)
  currentPeriodStart DateTime? @db.Timestamptz(3)
  currentPeriodEnd   DateTime? @db.Timestamptz(3)
  trialEndDate       DateTime? @db.Timestamptz(3)
  status             String // trialing | active | past_due | canceled | unpaid | incomplete

  // Asaas Integration
  asaasSubscriptionId String? @unique @db.VarChar(255) // ID da assinatura no Asaas

  // Pricing Overrides (Descontos e PreÃ§os Personalizados)
  discountPercent Decimal? @db.Decimal(5, 2) // Desconto percentual (0.00 a 100.00)
  discountReason  String? // RazÃ£o do desconto (ex: "PromoÃ§Ã£o Black Friday", "Cliente VIP")
  customPrice     Decimal? @db.Decimal(10, 2) // PreÃ§o customizado (override total do plan.price)

  // Feature Snapshot (Features no momento da assinatura)
  subscribedFeatures Json? @map("subscribed_features")

  // Billing Preferences (Onboarding)
  billingCycle           String? @map("billing_cycle") @db.VarChar(20) // MONTHLY | ANNUAL
  preferredPaymentMethod String? @map("preferred_payment_method") @db.VarChar(50) // PIX | BOLETO | CREDIT_CARD

  // Trial Alerts Control (IdempotÃªncia - evitar emails duplicados)
  trialAlert7Sent Boolean @default(false) @map("trial_alert_7_sent") // Email D-7 enviado
  trialAlert3Sent Boolean @default(false) @map("trial_alert_3_sent") // Email D-3 enviado
  trialAlert1Sent Boolean @default(false) @map("trial_alert_1_sent") // Email D-1 enviado

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan     Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)
  invoices Invoice[] // SuperAdmin - Faturas da assinatura

  @@map("subscriptions")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  VACINAÃ‡Ã•ES
//
//  Registro de vacinas administradas aos residentes
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Vaccination {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // 11 Campos obrigatÃ³rios (RDC 502/2021)
  vaccine        String // 1) Vacina/Profilaxia (ex: "COVID-19", "Influenza")
  dose           String // 3) Dose (ex: "1Âª dose", "2Âª dose", "ReforÃ§o")
  date           DateTime @db.Date // 2) Data da vacinaÃ§Ã£o
  batch          String // 4) Lote do imunizante
  manufacturer   String // 5) Fabricante
  cnes           String // 6) CNES (CÃ³digo Nacional do Estabelecimento de SaÃºde)
  healthUnit     String // 7) Estabelecimento de SaÃºde
  municipality   String // 8) MunicÃ­pio
  state          String // 9) UF (2 caracteres)
  certificateUrl String? // 10) URL do comprovante (file upload)
  notes          String?  @db.Text // 11) ObservaÃ§Ãµes adicionais

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3) // Soft delete

  // RelaÃ§Ãµes
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident             @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User                 @relation("VaccinationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?                @relation("VaccinationUpdatedBy", fields: [updatedBy], references: [id])
  history       VaccinationHistory[]

  // Ãndices para performance
  @@index([tenantId, residentId])
  @@index([residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("vaccinations")
}

model VaccinationHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  vaccinationId String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text

  // Snapshots dos dados (JSON)
  previousData Json?
  newData      Json

  // Campos alterados (array de strings)
  changedFields String[] @default([])

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3)
  changedBy     String   @db.Uuid
  changedByName String?
  ipAddress     String?
  userAgent     String?

  // Metadados adicionais
  metadata Json? @db.JsonB

  // RelaÃ§Ãµes
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vaccination Vaccination @relation(fields: [vaccinationId], references: [id], onDelete: Cascade)
  user        User        @relation("VaccinationHistoryUser", fields: [changedBy], references: [id])

  // Ãndices para performance
  @@index([tenantId, vaccinationId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@index([changeType])
  @@map("vaccination_history")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HISTÃ“RICO DE ALERTAS DE SINAIS VITAIS
//
//  Rastreia todas as alteraÃ§Ãµes feitas em alertas mÃ©dicos para exibiÃ§Ã£o ao usuÃ¡rio
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model VitalSignAlertHistory {
  id      String @id @default(uuid()) @db.Uuid
  alertId String @map("alert_id") @db.Uuid

  // Dados histÃ³ricos (snapshot)
  status       String  @db.VarChar(50) // Status no momento da alteraÃ§Ã£o
  assignedTo   String? @map("assigned_to") @db.Uuid
  medicalNotes String? @map("medical_notes") @db.Text
  actionTaken  String? @map("action_taken") @db.Text

  // Metadados da alteraÃ§Ã£o
  changedBy    String   @map("changed_by") @db.Uuid // Quem fez a alteraÃ§Ã£o
  changeReason String?  @map("change_reason") @db.Text // Motivo da alteraÃ§Ã£o (opcional)
  changeType   String   @map("change_type") @db.VarChar(50) // CREATED, STATUS_CHANGED, ASSIGNED, NOTES_ADDED, etc
  changedAt    DateTime @default(now()) @map("changed_at") @db.Timestamptz(3)

  // Relacionamentos
  alert        VitalSignAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  changedUser  User           @relation("AlertChangedBy", fields: [changedBy], references: [id], onDelete: SetNull)
  assignedUser User?          @relation("AlertAssignedUser", fields: [assignedTo], references: [id], onDelete: SetNull)

  // Ãndices
  @@index([alertId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("vital_sign_alert_history")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ALERTAS MÃ‰DICOS DE SINAIS VITAIS
//
//  Sistema de alertas mÃ©dicos persistentes vinculados a sinais vitais anormais.
//  Complementa o sistema de notificaÃ§Ãµes broadcast com registro clÃ­nico permanente.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model VitalSignAlert {
  id             String  @id @default(uuid()) @db.Uuid
  tenantId       String  @db.Uuid
  residentId     String  @db.Uuid
  vitalSignId    String  @db.Uuid
  notificationId String? @db.Uuid

  // Tipo e severidade do alerta
  type     VitalSignAlertType
  severity AlertSeverity

  // DescriÃ§Ã£o do alerta
  title       String @db.VarChar(255)
  description String @db.Text
  value       String @db.VarChar(100) // Ex: "175/98 mmHg", "280 mg/dL"
  metadata    Json   @db.JsonB // { threshold, expectedRange, detectedAt, etc }

  // Gerenciamento do alerta
  status     AlertStatus @default(ACTIVE)
  priority   Int         @default(0) // 0-5 para ordenaÃ§Ã£o (calculado automaticamente)
  assignedTo String?     @db.Uuid // Profissional responsÃ¡vel

  // DocumentaÃ§Ã£o mÃ©dica
  medicalNotes String? @db.Text // ObservaÃ§Ãµes da equipe
  actionTaken  String? @db.Text // Conduta aplicada

  // Auditoria
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  resolvedAt DateTime? @db.Timestamptz(3)
  resolvedBy String?   @db.Uuid
  createdBy  String?   @db.Uuid // NULL = criado automaticamente pelo sistema

  // Relacionamentos
  tenant        Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident                @relation(fields: [residentId], references: [id], onDelete: Cascade)
  vitalSign     VitalSign               @relation(fields: [vitalSignId], references: [id], onDelete: Cascade)
  notification  Notification?           @relation(fields: [notificationId], references: [id], onDelete: SetNull)
  clinicalNotes ClinicalNote[] // Um alerta pode gerar vÃ¡rias evoluÃ§Ãµes
  assignedUser  User?                   @relation("AssignedAlerts", fields: [assignedTo], references: [id], onDelete: SetNull)
  resolvedUser  User?                   @relation("ResolvedAlerts", fields: [resolvedBy], references: [id], onDelete: SetNull)
  history       VitalSignAlertHistory[] // HistÃ³rico de alteraÃ§Ãµes para exibiÃ§Ã£o ao usuÃ¡rio

  // Ãndices para performance
  @@index([tenantId, residentId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([residentId, status])
  @@index([vitalSignId])
  @@index([notificationId])
  @@index([assignedTo])
  @@map("vital_sign_alerts")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ENUMS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum VitalSignAlertType {
  PRESSURE_HIGH // PA sistÃ³lica elevada
  PRESSURE_LOW // PA sistÃ³lica baixa
  GLUCOSE_HIGH // Hiperglicemia
  GLUCOSE_LOW // Hipoglicemia
  TEMPERATURE_HIGH // Febre/Hipertermia
  TEMPERATURE_LOW // Hipotermia
  OXYGEN_LOW // HipÃ³xia
  HEART_RATE_HIGH // Taquicardia
  HEART_RATE_LOW // Bradicardia
}

enum AlertStatus {
  ACTIVE // Aguardando conduta (recÃ©m-criado)
  IN_TREATMENT // Em tratamento (conduta aplicada ou evoluÃ§Ã£o criada)
  MONITORING // Sob monitoramento contÃ­nuo
  RESOLVED // Resolvido com sucesso
  IGNORED // Ignorado (com justificativa em medicalNotes)
}

// NOTA: AlertSeverity jÃ¡ estÃ¡ definido em enums.prisma (linhas 583-589)
// Reutilizando: INFO, WARNING, CRITICAL


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SINAIS VITAIS
//
//  Monitoramento de sinais vitais dos residentes
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model VitalSign {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid
  userId     String @db.Uuid // ID do usuÃ¡rio que registrou

  // Timestamp do registro (data + hora completa)
  timestamp DateTime @db.Timestamptz(3)

  // Sinais Vitais (todos opcionais - registra apenas os que foram aferidos)
  systolicBloodPressure  Float? // PressÃ£o arterial sistÃ³lica (mmHg)
  diastolicBloodPressure Float? // PressÃ£o arterial diastÃ³lica (mmHg)
  temperature            Float? // Temperatura corporal (Â°C)
  heartRate              Int? // FrequÃªncia cardÃ­aca (bpm)
  oxygenSaturation       Float? // SaturaÃ§Ã£o perifÃ©rica de Oâ‚‚ (%)
  bloodGlucose           Float? // Glicemia (mg/dL)

  // Versionamento (RDC 502/2021 + LGPD)
  versionNumber Int     @default(1)
  createdBy     String  @db.Uuid
  updatedBy     String? @db.Uuid

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // RelaÃ§Ãµes
  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  creator  User               @relation("VitalSignCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updater  User?              @relation("VitalSignUpdater", fields: [updatedBy], references: [id], onDelete: Restrict)
  history  VitalSignHistory[]
  alerts   VitalSignAlert[] // Alertas mÃ©dicos gerados por este sinal vital

  // Ãndices para consultas otimizadas
  @@index([tenantId, residentId, timestamp(sort: Desc)])
  @@index([residentId, timestamp(sort: Desc)])
  @@index([tenantId, timestamp(sort: Desc)])
  @@index([deletedAt])
  @@map("vital_signs")
}

model VitalSignHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  vitalSignId   String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text
  previousData  Json?
  newData       Json?
  changedFields String[]
  changedAt     DateTime   @db.Timestamptz(3)
  changedBy     String     @db.Uuid

  // RelaÃ§Ãµes
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vitalSign VitalSign @relation(fields: [vitalSignId], references: [id], onDelete: Cascade)
  user      User      @relation("VitalSignHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)

  @@index([vitalSignId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@map("vital_sign_history")
}

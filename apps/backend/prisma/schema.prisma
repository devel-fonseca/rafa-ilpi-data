// ──────────────────────────────────────────────────────────────────────────────
//  Prisma Schema – Sistema Multi‑Tenant para Residências de Idosos
//  Data: 15/11/2025
//  Autor: @efonseca78 (BR)
// ──────────────────────────────────────────────────────────────────────────────

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ENUMS (usados em várias tabelas)
// ──────────────────────────────────────────────────────────────────────────────
enum PlanType {
  FREE
  BASICO
  PROFISSIONAL
  ENTERPRISE

  @@map("PlanType")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL

  @@map("TenantStatus")
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO

  @@map("Gender")
}

enum CivilStatus {
  SOLTEIRO
  CASADO
  DIVORCIADO
  VIUVO
  UNIAO_ESTAVEL

  @@map("CivilStatus")
}

enum BloodType {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
  NAO_INFORMADO

  @@map("BloodType")
}

enum RecordType {
  HIGIENE
  ALIMENTACAO
  HIDRATACAO
  MONITORAMENTO
  ELIMINACAO
  COMPORTAMENTO
  INTERCORRENCIA
  ATIVIDADES
  VISITA
  OUTROS

  @@map("RecordType")
}

enum PrescriptionType {
  ROTINA
  ALTERACAO_PONTUAL
  ANTIBIOTICO
  ALTO_RISCO
  CONTROLADO
  OUTRO

  @@map("PrescriptionType")
}

enum AdministrationRoute {
  VO
  IM
  EV
  SC
  TOPICA
  SL
  RETAL
  OCULAR
  NASAL
  INALATORIA
  OUTRA

  @@map("AdministrationRoute")
}

enum MedicationPresentation {
  COMPRIMIDO
  CAPSULA
  AMPOLA
  GOTAS
  SOLUCAO
  SUSPENSAO
  POMADA
  CREME
  SPRAY
  INALADOR
  ADESIVO
  SUPOSITORIO
  OUTRO

  @@map("MedicationPresentation")
}

enum NotificationType {
  AMARELA
  AZUL
  BRANCA_ESPECIAL
  NAO_APLICA

  @@map("NotificationType")
}

enum ControlledClass {
  BZD
  PSICOFARMACO
  OPIOIDE
  ANTICONVULSIVANTE
  OUTRO

  @@map("ControlledClass")
}

enum MedicationFrequency {
  UMA_VEZ_DIA
  DUAS_VEZES_DIA
  SEIS_SEIS_H
  OITO_OITO_H
  DOZE_DOZE_H
  PERSONALIZADO

  @@map("MedicationFrequency")
}

enum SOSIndicationType {
  DOR
  FEBRE
  ANSIEDADE
  AGITACAO
  NAUSEA
  INSONIA
  OUTRO

  @@map("SOSIndicationType")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PLANOS
// ──────────────────────────────────────────────────────────────────────────────
model Plan {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  displayName  String
  type         PlanType
  maxResidents Int
  maxUsers     Int
  price        Decimal? @db.Decimal(10, 2)
  trialDays    Int      @default(0)
  isPopular    Boolean  @default(false)
  features     Json     @default("{}")
  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime @updatedAt @db.Timestamptz(3)

  subscriptions Subscription[]

  @@map("plans")
}

// ──────────────────────────────────────────────────────────────────────────────
//  TENANTS (Clínicas / Residências)
// ──────────────────────────────────────────────────────────────────────────────
model Tenant {
  id         String       @id @default(uuid()) @db.Uuid
  name       String
  slug       String       @unique
  cnpj       String?      @unique
  email      String
  phone      String?
  status     TenantStatus @default(TRIAL)
  schemaName String       @unique

  // Endereço detalhado
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  deletedAt DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  subscriptions             Subscription[]
  users                     User[]
  userProfiles              UserProfile[]
  residents                 Resident[]
  dailyRecords              DailyRecord[]
  dailyRecordHistory        DailyRecordHistory[]
  vitalSigns                VitalSign[]
  prescriptions             Prescription[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  auditLogs                 AuditLog[]
  buildings                 Building[]
  floors                    Floor[]
  rooms                     Room[]
  beds                      Bed[]
  profile                   TenantProfile?
  documents                 TenantDocument[]
  residentDocuments         ResidentDocument[]

  @@map("tenants")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SUBSCRIPTIONS (Stripe‑style)
// ──────────────────────────────────────────────────────────────────────────────
model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  planId             String    @db.Uuid
  startDate          DateTime  @default(now()) @db.Timestamptz(3)
  endDate            DateTime? @db.Timestamptz(3)
  currentPeriodStart DateTime? @db.Timestamptz(3)
  currentPeriodEnd   DateTime? @db.Timestamptz(3)
  trialEndDate       DateTime? @db.Timestamptz(3)
  status             String // trialing | active | past_due | canceled | unpaid | incomplete

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@map("subscriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USERS (por tenant)
// ──────────────────────────────────────────────────────────────────────────────
model User {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @db.Uuid
  name                  String
  email                 String
  password              String
  role                  String // admin | user | viewer (pode virar enum depois)
  isActive              Boolean   @default(true)
  lastLogin             DateTime? @db.Timestamptz(3)
  passwordResetRequired Boolean   @default(false)
  deletedAt             DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile                   UserProfile?
  refreshTokens             RefreshToken[]
  dailyRecords              DailyRecord[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  vitalSigns                VitalSign[]

  @@unique([tenantId, email])
  @@map("users")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REFRESH TOKENS
// ──────────────────────────────────────────────────────────────────────────────
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USER PROFILES
// ──────────────────────────────────────────────────────────────────────────────
model UserProfile {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @unique @db.Uuid
  tenantId     String    @db.Uuid

  // Dados do Perfil
  profilePhoto String?   // URL ou path da foto de perfil
  phone        String?
  position     String?   // Cargo do usuário
  department   String?   // Departamento
  birthDate    DateTime? @db.Date
  notes        String?   @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid

  // Relações
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ──────────────────────────────────────────────────────────────────────────────
//  RESIDENTS – MODELO FINAL (conforme especificação)
// ──────────────────────────────────────────────────────────────────────────────
model Resident {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // 0 – Status
  status String @default("Ativo") // Ativo | Inativo | Falecido

  // 1 – Dados Pessoais
  fullName    String
  socialName  String?
  cpf         String
  rg          String?
  rgIssuer    String?
  education   String?
  profession  String?
  cns         String?
  gender      Gender
  civilStatus CivilStatus?
  religion    String?
  birthDate   DateTime     @db.Date
  nationality String       @default("Brasileira")
  birthCity   String?
  birthState  String? // UF (2 letras)
  motherName  String?
  fatherName  String?
  fotoUrl     String? // URL da foto do residente no MinIO

  // 2 – Endereços
  // Atual
  currentCep        String?
  currentState      String?
  currentCity       String?
  currentStreet     String?
  currentNumber     String?
  currentComplement String?
  currentDistrict   String?
  currentPhone      String?

  // Procedência
  originCep        String?
  originState      String?
  originCity       String?
  originStreet     String?
  originNumber     String?
  originComplement String?
  originDistrict   String?
  originPhone      String?

  // 3 – Contatos de Emergência (array JSON)
  emergencyContacts Json @default("[]")
  // [{ "name": "...", "phone": "...", "relationship": "..." }]

  // 4 – Responsável Legal
  legalGuardianName       String?
  legalGuardianCpf        String?
  legalGuardianRg         String?
  legalGuardianPhone      String?
  legalGuardianType       String? // curador | procurador | responsável convencional
  legalGuardianCep        String?
  legalGuardianState      String?
  legalGuardianCity       String?
  legalGuardianStreet     String?
  legalGuardianNumber     String?
  legalGuardianComplement String?
  legalGuardianDistrict   String?

  // 5 – Admissão
  admissionDate       DateTime  @db.Date
  admissionType       String? // Voluntária | Involuntária | Judicial | outro
  admissionReason     String?
  admissionConditions String?
  dischargeDate       DateTime? @db.Date
  dischargeReason     String?

  // 6 – Saúde
  healthStatus           String?
  bloodType              BloodType @default(NAO_INFORMADO)
  height                 Decimal?  @db.Decimal(5, 2) // metros
  weight                 Decimal?  @db.Decimal(5, 1) // kg
  dependencyLevel        String? // Grau I - Independente | Grau II - Semidependente | Grau III - Dependente
  mobilityAid            Boolean?
  specialNeeds           String?
  functionalAspects      String?
  medicationsOnAdmission String?
  allergies              String?
  chronicConditions      String?
  dietaryRestrictions    String?

  // 7 – Convênios / Planos de Saúde
  healthPlans Json @default("[]")
  // [{ "name": "...", "cardNumber": "...", "cardUrl": "..." }]

  // 8 – Pertences
  belongings Json @default("[]")
  // ["Óculos", "Aparelho auditivo", ...]

  // 9 – Acomodação
  roomId String? @db.Uuid
  bedId  String? @unique @db.Uuid

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bed                       Bed?                       @relation(fields: [bedId], references: [id])
  dailyRecords              DailyRecord[]
  prescriptions             Prescription[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  vitalSigns                VitalSign[]
  residentDocuments         ResidentDocument[]

  // Índices
  @@unique([tenantId, cpf])
  @@index([tenantId, status])
  @@index([tenantId, admissionDate(sort: Desc)])
  @@index([deletedAt])
  @@map("residents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  DOCUMENTOS DE RESIDENTES
// ──────────────────────────────────────────────────────────────────────────────
model ResidentDocument {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  residentId  String    @db.Uuid

  // Tipo de documento
  type        String    @db.VarChar(100)
  // Tipos possíveis:
  // - CARTAO_CONVENIO
  // - COMPROVANTE_RESIDENCIA_RESIDENTE
  // - DOCUMENTOS_RESPONSAVEL_LEGAL
  // - COMPROVANTE_RESIDENCIA_RESPONSAVEL
  // - DOCUMENTOS_PESSOAIS
  // - LAUDO_MEDICO
  // - TERMO_ADMISSAO
  // - TERMO_CONSENTIMENTO_IMAGEM
  // - TERMO_CONSENTIMENTO_LGPD

  // Arquivo
  fileUrl     String    // URL completa do arquivo no S3/MinIO
  fileKey     String?   // Chave do arquivo no S3 para deleção
  fileName    String    // Nome original do arquivo
  fileSize    Int?      // Tamanho em bytes
  mimeType    String?   @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Detalhes opcionais (ex: "Unimed", "Laudo de entrada", etc.)
  details     String?   @db.Text

  // Auditoria
  uploadedBy  String    @db.Uuid // ID do usuário que fez upload
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  // Relações
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident    Resident  @relation(fields: [residentId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId, type])
  @@index([deletedAt])
  @@map("resident_documents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REGISTROS DIÁRIOS
// ──────────────────────────────────────────────────────────────────────────────
model DailyRecord {
  id         String     @id @default(uuid()) @db.Uuid
  tenantId   String     @db.Uuid
  residentId String     @db.Uuid

  // Tipo e metadados
  type RecordType
  date DateTime   @db.Date // Data do registro (sem hora)
  time String // Hora no formato "HH:mm" (ex: "07:00", "14:30")

  // Dados estruturados (JSON) - cada tipo tem sua própria estrutura
  data Json @default("{}")

  // Responsável pelo registro
  recordedBy String // Nome do profissional
  userId     String @db.Uuid // ID do usuário que fez o registro

  // Observações gerais (opcional)
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para performance
  @@index([tenantId, residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc), time])
  @@index([deletedAt])
  @@map("daily_records")

  // Relação com histórico de versões
  history DailyRecordHistory[]
}

// Histórico de Versões de Registros Diários (para conformidade com prontuário eletrônico)
model DailyRecordHistory {
  id             String   @id @default(uuid()) @db.Uuid
  recordId       String   @db.Uuid // FK para DailyRecord
  tenantId       String   @db.Uuid
  versionNumber  Int // Número sequencial da versão (1, 2, 3...)

  // Dados da versão anterior (snapshot completo)
  previousData   Json // Snapshot completo do estado anterior

  // Dados da nova versão (para comparação)
  newData        Json // Snapshot completo do novo estado

  // Campos alterados (array de nomes de campos: ["time", "data.pressao"])
  changedFields  Json @default("[]")

  // Auditoria da mudança
  changeType     String // "UPDATE" ou "DELETE"
  changeReason   String @db.Text // Motivo obrigatório da mudança
  changedBy      String @db.Uuid // ID do usuário que fez a mudança
  changedByName  String // Nome do usuário que fez a mudança
  changedAt      DateTime @default(now()) @db.Timestamptz(3)

  // IP e User Agent para auditoria adicional
  ipAddress      String? @db.VarChar(45)
  userAgent      String? @db.Text

  // Relações
  record DailyRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([recordId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("daily_record_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SINAIS VITAIS (Tabela dedicada para análises e consultas otimizadas)
// ──────────────────────────────────────────────────────────────────────────────
model VitalSign {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  residentId String   @db.Uuid
  userId     String   @db.Uuid // ID do usuário que registrou

  // Timestamp do registro (data + hora completa)
  timestamp  DateTime @db.Timestamptz(3)

  // Sinais Vitais (todos opcionais - registra apenas os que foram aferidos)
  systolicBloodPressure   Float? // Pressão arterial sistólica (mmHg)
  diastolicBloodPressure  Float? // Pressão arterial diastólica (mmHg)
  temperature             Float? // Temperatura corporal (°C)
  heartRate               Int?   // Frequência cardíaca (bpm)
  oxygenSaturation        Float? // Saturação periférica de O₂ (%)
  bloodGlucose            Float? // Glicemia (mg/dL)

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para consultas otimizadas
  @@index([tenantId, residentId, timestamp(sort: Desc)])
  @@index([residentId, timestamp(sort: Desc)])
  @@index([tenantId, timestamp(sort: Desc)])
  @@index([deletedAt])
  @@map("vital_signs")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PRESCRIÇÕES MÉDICAS
// ──────────────────────────────────────────────────────────────────────────────
model Prescription {
  id         String           @id @default(uuid()) @db.Uuid
  tenantId   String           @db.Uuid
  residentId String           @db.Uuid

  // Dados do Prescritor
  doctorName       String
  doctorCrm        String
  doctorCrmState   String // UF
  prescriptionDate DateTime @db.Date
  prescriptionType PrescriptionType
  validUntil       DateTime? @db.Date // Obrigatório para ANTIBIOTICO e CONTROLADO
  reviewDate       DateTime? @db.Date // Data estimada para revisão da prescrição

  // Campos específicos para CONTROLADO
  controlledClass    ControlledClass?
  notificationNumber String?
  notificationType   NotificationType?

  // Anexos
  prescriptionImageUrl String? // URL da receita médica (obrigatório para controlado)

  // Observações gerais
  notes String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  createdBy String    @db.Uuid // ID do usuário que criou

  // Relações
  tenant              Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident            Resident                   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  medications         Medication[]
  sosMedications      SOSMedication[]
  administrations     MedicationAdministration[]
  sosAdministrations  SOSAdministration[]

  // Índices
  @@index([tenantId, residentId])
  @@index([tenantId, isActive])
  @@index([tenantId, validUntil])
  @@index([deletedAt])
  @@map("prescriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAMENTOS CONTÍNUOS
// ──────────────────────────────────────────────────────────────────────────────
model Medication {
  id             String                 @id @default(uuid()) @db.Uuid
  prescriptionId String                 @db.Uuid

  // Dados do medicamento
  name           String // DCB (Denominação Comum Brasileira)
  presentation   MedicationPresentation
  concentration  String // Ex: "500mg", "5mg/mL"
  dose           String // Ex: "1 cp", "20 gotas"
  route          AdministrationRoute
  frequency      MedicationFrequency
  scheduledTimes Json                   @default("[]") // Array de horários: ["06:00", "14:00", "22:00"]

  // Período
  startDate DateTime  @db.Date
  endDate   DateTime? @db.Date // null = uso contínuo

  // Flags especiais
  isControlled        Boolean @default(false)
  isHighRisk          Boolean @default(false)
  requiresDoubleCheck Boolean @default(false) // Exige dupla checagem

  // Observações
  instructions String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  prescription    Prescription               @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  administrations MedicationAdministration[]

  // Índices
  @@index([prescriptionId])
  @@index([isControlled])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@map("medications")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAÇÕES SOS (uso eventual)
// ──────────────────────────────────────────────────────────────────────────────
model SOSMedication {
  id             String                 @id @default(uuid()) @db.Uuid
  prescriptionId String                 @db.Uuid

  // Dados do medicamento
  name           String
  presentation   MedicationPresentation
  concentration  String
  dose           String
  route          AdministrationRoute

  // Indicação e limites
  indication        SOSIndicationType
  indicationDetails String? // Ex: "dor > 7", "febre > 38°C"
  minInterval       String // Ex: "6 horas", "4 horas"
  maxDailyDoses     Int // Limite diário (ex: 3)

  // Período de validade
  startDate DateTime  @db.Date
  endDate   DateTime? @db.Date

  // Observações
  instructions String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  prescription       Prescription        @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosAdministrations SOSAdministration[]

  // Índices
  @@index([prescriptionId])
  @@index([indication])
  @@index([deletedAt])
  @@map("sos_medications")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ADMINISTRAÇÃO DE MEDICAMENTOS CONTÍNUOS
// ──────────────────────────────────────────────────────────────────────────────
model MedicationAdministration {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  prescriptionId String   @db.Uuid
  medicationId   String   @db.Uuid
  residentId     String   @db.Uuid

  // Data/hora da administração
  date          DateTime @db.Date
  scheduledTime String // Horário programado (ex: "06:00")
  actualTime    String? // Horário real de administração (se diferente)

  // Status
  wasAdministered Boolean @default(false)
  reason          String? // Motivo de não administração

  // Checagem
  administeredBy  String // Nome do profissional
  userId          String @db.Uuid
  checkedBy       String? // Para dupla checagem
  checkedByUserId String? @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication   Medication   @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([medicationId, date])
  @@index([wasAdministered])
  @@map("medication_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ADMINISTRAÇÃO DE MEDICAÇÕES SOS
// ──────────────────────────────────────────────────────────────────────────────
model SOSAdministration {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  prescriptionId  String   @db.Uuid
  sosMedicationId String   @db.Uuid
  residentId      String   @db.Uuid

  // Data/hora
  date DateTime @db.Date
  time String // Horário da administração

  // Motivo
  indication String // Descrição do motivo (ex: "dor intensa no joelho")

  // Checagem
  administeredBy String
  userId         String @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription  Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  resident      Resident      @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([sosMedicationId, date])
  @@map("sos_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  VACINAÇÕES / IMUNIZAÇÕES (RDC 502/2021 - Art. 39)
// ──────────────────────────────────────────────────────────────────────────────
model Vaccination {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  residentId     String   @db.Uuid

  // 11 Campos obrigatórios (RDC 502/2021)
  vaccine        String                    // 1) Vacina/Profilaxia (ex: "COVID-19", "Influenza")
  dose           String                    // 3) Dose (ex: "1ª dose", "2ª dose", "Reforço")
  date           DateTime   @db.Date       // 2) Data da vacinação
  batch          String                    // 4) Lote do imunizante
  manufacturer   String                    // 5) Fabricante
  cnes           String                    // 6) CNES (Código Nacional do Estabelecimento de Saúde)
  healthUnit     String                    // 7) Estabelecimento de Saúde
  municipality   String                    // 8) Município
  state          String                    // 9) UF (2 caracteres)
  certificateUrl String?                   // 10) URL do comprovante (file upload)
  notes          String?    @db.Text       // 11) Observações adicionais

  // Auditoria
  userId         String     @db.Uuid       // ID do usuário que registrou
  createdAt      DateTime   @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime   @updatedAt @db.Timestamptz(3)
  deletedAt      DateTime?  @db.Timestamptz(3) // Soft delete

  // Relações
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para performance
  @@index([tenantId, residentId])
  @@index([residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([deletedAt])
  @@map("vaccinations")
}

// ==========================================
// AUDITORIA
// ==========================================

model AuditLog {
  id         Int      @id @default(autoincrement())
  tenantId   String   @map("tenant_id") @db.Uuid
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.VarChar(255)
  action     String   @db.VarChar(50)
  userId     String   @map("user_id") @db.VarChar(255)
  userName   String   @map("user_name") @db.VarChar(255)
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([entityType])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ──────────────────────────────────────────────────────────────────────────────
//  GESTÃO DE LEITOS (MAPA DE OCUPAÇÃO)
//  Estrutura: Building → Floor → Room → Bed
// ──────────────────────────────────────────────────────────────────────────────

// NÍVEL 1: PRÉDIOS / BLOCOS / CASAS
model Building {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  name        String    // "Casa Principal", "Bloco A"
  code        String    // "PRED-001", "BLOCO-A"
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floors Floor[]

  @@index([tenantId, isActive])
  @@map("buildings")
}

// NÍVEL 2: ANDARES / SETORES / ALAS / PAVILHÕES
model Floor {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  buildingId  String    @db.Uuid
  name        String    // "Térreo", "1º Andar", "Ala Feminina"
  code        String    // "PISO-0", "PISO-1"
  orderIndex  Int       @default(0) // Ordenação visual (crescente)
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@index([tenantId, buildingId])
  @@index([buildingId, orderIndex])
  @@index([deletedAt])
  @@map("floors")
}

// NÍVEL 3: QUARTOS / ENFERMARIAS / SUÍTES
model Room {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @db.Uuid
  floorId               String    @db.Uuid
  name                  String    // "101", "Quarto 3"
  code                  String    // "Q-101", "Q-102"
  roomNumber            String    // "101", "102"
  capacity              Int       @default(1) // Número total de leitos (calculado automaticamente)
  roomType              String?   // "Coletivo", "Suíte", "Enfermaria", "Individual", "Duplo", "Triplo"
  genderRestriction     String?   // null, "M", "F"
  hasBathroom           Boolean   @default(false) // Se o quarto tem banheiro
  hasPrivateBathroom    Boolean   @default(false) // Se tem banheiro privativo
  accessible            Boolean   @default(false) // Se é acessível para PCD
  observations          String?   @db.Text // Observações adicionais
  notes                 String?   @db.Text
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt             DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt             DateTime? @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floor  Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds   Bed[]

  @@index([tenantId, floorId])
  @@index([floorId, isActive])
  @@index([deletedAt])
  @@map("rooms")
}

// NÍVEL 4: LEITOS (conecta com Residents)
model Bed {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @db.Uuid
  roomId    String    @db.Uuid
  code      String    // "101-A", "101-B", "Leito 1"
  status    String    @default("Disponível") // "Disponível", "Ocupado", "Manutenção" (calculado dinamicamente)
  notes     String?   @db.Text
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room     Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  resident Resident?

  @@unique([tenantId, code]) // Código do leito único por tenant
  @@index([tenantId, roomId])
  @@index([roomId, status])
  @@index([tenantId, status])
  @@index([deletedAt])
  @@map("beds")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERFIL INSTITUCIONAL
//  Informações regulatórias, documentação e compliance da ILPI
// ──────────────────────────────────────────────────────────────────────────────

// ENUM: Natureza Jurídica da Instituição
enum LegalNature {
  ASSOCIACAO      // Associação sem fins lucrativos
  FUNDACAO        // Fundação privada
  EMPRESA_PRIVADA // Empresa privada
  MEI             // Microempreendedor Individual

  @@map("LegalNature")
}

// PERFIL INSTITUCIONAL (1:1 com Tenant)
model TenantProfile {
  id                  String       @id @default(uuid()) @db.Uuid
  tenantId            String       @unique @db.Uuid

  // Logo e identidade visual
  logoUrl             String?      // URL do logo no S3/MinIO
  logoKey             String?      // Chave do arquivo no S3 para deleção

  // Natureza jurídica e dados básicos
  legalNature         LegalNature?
  tradeName           String?      // Nome fantasia

  // Dados regulatórios
  cnesCode            String?      @db.VarChar(20)  // Código CNES (Cadastro Nacional de Estabelecimentos de Saúde)
  capacityDeclared    Int?         // Capacidade declarada de residentes
  capacityLicensed    Int?         // Capacidade licenciada pela vigilância sanitária

  // Contatos institucionais
  contactPhone        String?
  contactEmail        String?
  websiteUrl          String?

  // Informações complementares
  foundedAt           DateTime?    @db.Date         // Data de fundação
  mission             String?      @db.Text         // Missão institucional
  vision              String?      @db.Text         // Visão institucional
  values              String?      @db.Text         // Valores institucionais

  // Observações
  notes               String?      @db.Text

  // Auditoria
  createdAt           DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt           DateTime     @updatedAt @db.Timestamptz(3)
  deletedAt           DateTime?    @db.Timestamptz(3)

  // Relações
  tenant              Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId])
  @@index([legalNature])
  @@index([deletedAt])
  @@map("tenant_profiles")
}

// ENUM: Status de compliance do documento
enum DocumentStatus {
  OK         // Documento OK (sem vencimento ou com vencimento > 30 dias)
  PENDENTE   // Documento obrigatório não enviado
  VENCENDO   // Vence em <= 30 dias
  VENCIDO    // Vencimento ultrapassado

  @@map("DocumentStatus")
}

// DOCUMENTOS INSTITUCIONAIS
model TenantDocument {
  id          String          @id @default(uuid()) @db.Uuid
  tenantId    String          @db.Uuid

  // Tipo de documento (baseado na natureza jurídica)
  type        String          @db.VarChar(100) // ESTATUTO, CMI, CNPJ, ALVARA_USO, etc.

  // Arquivo
  fileUrl     String          // URL completa do arquivo no S3/MinIO
  fileKey     String?         // Chave do arquivo no S3 para deleção
  fileName    String          // Nome original do arquivo
  fileSize    Int?            // Tamanho em bytes
  mimeType    String?         @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Metadados do documento
  issuedAt    DateTime?       @db.Date         // Data de emissão
  expiresAt   DateTime?       @db.Date         // Data de vencimento (se aplicável)
  status      DocumentStatus  @default(PENDENTE) // Calculado automaticamente

  // Observações
  notes       String?         @db.Text

  // Auditoria
  uploadedBy  String          @db.Uuid         // ID do usuário que fez upload
  createdAt   DateTime        @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime        @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime?       @db.Timestamptz(3)

  // Relações
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, expiresAt])
  @@index([expiresAt])
  @@index([status])
  @@index([deletedAt])
  @@map("tenant_documents")
}

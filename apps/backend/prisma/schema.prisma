// ──────────────────────────────────────────────────────────────────────────────
//  Prisma Schema – Sistema Multi‑Tenant para Residências de Idosos
//  Data: 15/11/2025
//  Autor: @efonseca78 (BR)
// ──────────────────────────────────────────────────────────────────────────────

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ENUMS (usados em várias tabelas)
// ──────────────────────────────────────────────────────────────────────────────
enum PlanType {
  FREE
  BASICO
  PROFISSIONAL
  ENTERPRISE

  @@map("PlanType")
}

enum BillingCycle {
  MONTHLY
  ANNUAL

  @@map("BillingCycle")
}

// ENUM: Tipos de Permissões do Sistema
enum PermissionType {
  // Residentes
  VIEW_RESIDENTS
  CREATE_RESIDENTS
  UPDATE_RESIDENTS
  DELETE_RESIDENTS

  // Registros Diários
  VIEW_DAILY_RECORDS
  CREATE_DAILY_RECORDS
  UPDATE_DAILY_RECORDS
  DELETE_DAILY_RECORDS

  // Prescrições
  VIEW_PRESCRIPTIONS
  CREATE_PRESCRIPTIONS
  UPDATE_PRESCRIPTIONS
  DELETE_PRESCRIPTIONS

  // Administração de Medicamentos
  VIEW_MEDICATIONS
  ADMINISTER_MEDICATIONS
  ADMINISTER_CONTROLLED_MEDICATIONS

  // Sinais Vitais
  VIEW_VITAL_SIGNS
  RECORD_VITAL_SIGNS

  // Vacinações
  VIEW_VACCINATIONS
  CREATE_VACCINATIONS
  UPDATE_VACCINATIONS
  DELETE_VACCINATIONS

  // Evoluções Clínicas (SOAP)
  VIEW_CLINICAL_NOTES
  CREATE_CLINICAL_NOTES
  UPDATE_CLINICAL_NOTES
  DELETE_CLINICAL_NOTES

  // Perfis Clínicos
  VIEW_CLINICAL_PROFILE
  UPDATE_CLINICAL_PROFILE

  // Alergias
  VIEW_ALLERGIES
  CREATE_ALLERGIES
  UPDATE_ALLERGIES
  DELETE_ALLERGIES

  // Condições Crônicas
  VIEW_CONDITIONS
  CREATE_CONDITIONS
  UPDATE_CONDITIONS
  DELETE_CONDITIONS

  // Restrições Alimentares
  VIEW_DIETARY_RESTRICTIONS
  CREATE_DIETARY_RESTRICTIONS
  UPDATE_DIETARY_RESTRICTIONS
  DELETE_DIETARY_RESTRICTIONS

  // Gestão de Leitos
  VIEW_BEDS
  MANAGE_BEDS

  // Infraestrutura (Prédios, Andares, Quartos, Leitos)
  MANAGE_INFRASTRUCTURE

  // Documentos
  VIEW_DOCUMENTS
  UPLOAD_DOCUMENTS
  DELETE_DOCUMENTS

  // Usuários e Permissões
  VIEW_USERS
  CREATE_USERS
  UPDATE_USERS
  DELETE_USERS
  MANAGE_PERMISSIONS

  // Relatórios e Auditoria
  VIEW_REPORTS
  EXPORT_DATA
  VIEW_AUDIT_LOGS

  // Configurações Institucionais
  VIEW_INSTITUTIONAL_SETTINGS
  UPDATE_INSTITUTIONAL_SETTINGS

  // Perfil Institucional
  VIEW_INSTITUTIONAL_PROFILE
  UPDATE_INSTITUTIONAL_PROFILE

  // POPs (Procedimentos Operacionais Padrão)
  VIEW_POPS
  CREATE_POPS
  UPDATE_POPS
  DELETE_POPS
  PUBLISH_POPS
  MANAGE_POPS

  // Agenda do Residente
  VIEW_RESIDENT_SCHEDULE
  MANAGE_RESIDENT_SCHEDULE

  @@map("PermissionType")
}

// ENUM: Cargos ILPI (baseado em funções reais de uma ILPI)
enum PositionCode {
  ADMINISTRATOR // Administrador da ILPI
  TECHNICAL_MANAGER // Responsável Técnico (nível superior)
  NURSING_COORDINATOR // Coordenador de Enfermagem
  NURSE // Enfermeiro
  NURSING_TECHNICIAN // Técnico de Enfermagem
  NURSING_ASSISTANT // Auxiliar de Enfermagem
  DOCTOR // Médico
  PSYCHOLOGIST // Psicólogo
  SOCIAL_WORKER // Assistente Social
  PHYSIOTHERAPIST // Fisioterapeuta
  NUTRITIONIST // Nutricionista
  SPEECH_THERAPIST // Fonoaudiólogo
  OCCUPATIONAL_THERAPIST // Terapeuta Ocupacional
  CAREGIVER // Cuidador de Idosos
  ADMINISTRATIVE // Administrativo
  ADMINISTRATIVE_ASSISTANT // Assistente Administrativo
  OTHER // Outros

  @@map("PositionCode")
}

// ENUM: Tipo de Registro Profissional
enum RegistrationType {
  COREN // Conselho Regional de Enfermagem
  CRM // Conselho Regional de Medicina
  CRN // Conselho Regional de Nutrição
  CREFITO // Conselho Regional de Fisioterapia e Terapia Ocupacional
  CRP // Conselho Regional de Psicologia
  CREFONO // Conselho Regional de Fonoaudiologia
  CRESS // Conselho Regional de Serviço Social
  NONE // Sem registro (para cargos que não exigem)

  @@map("RegistrationType")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL

  @@map("TenantStatus")
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO

  @@map("Gender")
}

enum CivilStatus {
  SOLTEIRO
  CASADO
  DIVORCIADO
  VIUVO
  UNIAO_ESTAVEL

  @@map("CivilStatus")
}

enum BloodType {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
  NAO_INFORMADO

  @@map("BloodType")
}

enum RecordType {
  HIGIENE
  ALIMENTACAO
  HIDRATACAO
  MONITORAMENTO
  ELIMINACAO
  COMPORTAMENTO
  HUMOR
  SONO
  PESO
  INTERCORRENCIA
  ATIVIDADES
  VISITA
  OUTROS

  @@map("RecordType")
}

enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY

  @@map("ScheduleFrequency")
}

enum ScheduledEventType {
  VACCINATION
  CONSULTATION
  EXAM
  PROCEDURE
  OTHER

  @@map("ScheduledEventType")
}

enum ScheduledEventStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  MISSED

  @@map("ScheduledEventStatus")
}

enum PrescriptionType {
  ROTINA
  ALTERACAO_PONTUAL
  ANTIBIOTICO
  ALTO_RISCO
  CONTROLADO
  OUTRO

  @@map("PrescriptionType")
}

enum AdministrationRoute {
  VO
  IM
  EV
  SC
  TOPICA
  SL
  RETAL
  OCULAR
  NASAL
  INALATORIA
  OUTRA

  @@map("AdministrationRoute")
}

enum MedicationPresentation {
  COMPRIMIDO
  CAPSULA
  AMPOLA
  GOTAS
  SOLUCAO
  SUSPENSAO
  POMADA
  CREME
  SPRAY
  INALADOR
  ADESIVO
  SUPOSITORIO
  OUTRO

  @@map("MedicationPresentation")
}

enum NotificationType {
  AMARELA
  AZUL
  BRANCA_ESPECIAL
  NAO_APLICA

  @@map("NotificationType")
}

enum ControlledClass {
  BZD
  PSICOFARMACO
  OPIOIDE
  ANTICONVULSIVANTE
  OUTRO

  @@map("ControlledClass")
}

enum MedicationFrequency {
  UMA_VEZ_DIA
  DUAS_VEZES_DIA
  SEIS_SEIS_H
  OITO_OITO_H
  DOZE_DOZE_H
  PERSONALIZADO

  @@map("MedicationFrequency")
}

enum SOSIndicationType {
  DOR
  FEBRE
  ANSIEDADE
  AGITACAO
  NAUSEA
  INSONIA
  OUTRO

  @@map("SOSIndicationType")
}

// ENUM: Profissões para Evoluções Clínicas (SOAP)
enum ClinicalProfession {
  MEDICINE // Médico
  NURSING // Enfermagem
  NUTRITION // Nutrição
  PHYSIOTHERAPY // Fisioterapia
  PSYCHOLOGY // Psicologia
  SOCIAL_WORK // Serviço Social
  SPEECH_THERAPY // Fonoaudiologia
  OCCUPATIONAL_THERAPY // Terapia Ocupacional

  @@map("ClinicalProfession")
}

enum AllergySeverity {
  LEVE
  MODERADA
  GRAVE
  ANAFILAXIA

  @@map("AllergySeverity")
}

enum RestrictionType {
  ALERGIA_ALIMENTAR
  INTOLERANCIA
  RESTRICAO_MEDICA
  RESTRICAO_RELIGIOSA
  DISFAGIA
  DIABETES
  HIPERTENSAO
  OUTRA

  @@map("RestrictionType")
}

// Enum para versionamento - Tipo de alteração no histórico
enum ChangeType {
  CREATE // Criação inicial do registro
  UPDATE // Atualização de campos
  DELETE // Soft delete (marcação como deletado)

  @@map("ChangeType")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PLANOS
// ──────────────────────────────────────────────────────────────────────────────
model Plan {
  id           String       @id @default(uuid()) @db.Uuid
  name         String       @unique
  displayName  String
  type         PlanType
  maxResidents Int
  maxUsers     Int
  price        Decimal?     @db.Decimal(10, 2)
  trialDays    Int          @default(0)
  isPopular    Boolean      @default(false)
  features     Json         @default("{}")
  billingCycle BillingCycle @default(MONTHLY) // MONTHLY | ANNUAL
  createdAt    DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime     @updatedAt @db.Timestamptz(3)

  subscriptions Subscription[]

  @@map("plans")
}

// ──────────────────────────────────────────────────────────────────────────────
//  TENANTS (Clínicas / Residências)
// ──────────────────────────────────────────────────────────────────────────────
model Tenant {
  id         String       @id @default(uuid()) @db.Uuid
  name       String
  slug       String       @unique
  cnpj       String?      @unique
  email      String
  phone      String?
  status     TenantStatus @default(TRIAL)
  schemaName String       @unique

  // Asaas Integration
  asaasCustomerId String? @unique @db.VarChar(255) // ID do cliente no Asaas

  // Endereço detalhado
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  deletedAt DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  subscriptions             Subscription[]
  users                     User[]
  userProfiles              UserProfile[]
  userHistory               UserHistory[] // Histórico de usuários
  residents                 Resident[]
  residentHistory           ResidentHistory[] // Histórico de residentes
  dailyRecords              DailyRecord[]
  dailyRecordHistory        DailyRecordHistory[]
  vitalSigns                VitalSign[]
  prescriptions             Prescription[]
  prescriptionHistory       PrescriptionHistory[] // Histórico de prescrições
  medicationHistory         MedicationHistory[] // Histórico de medicamentos
  sosMedicationHistory      SOSMedicationHistory[] // Histórico de medicamentos SOS
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  vaccinationHistory        VaccinationHistory[] // Histórico de vacinações
  allergies                 Allergy[]
  allergyHistory            AllergyHistory[] // Histórico de alergias
  conditions                Condition[]
  conditionHistory          ConditionHistory[] // Histórico de condições
  clinicalNotes             ClinicalNote[]
  clinicalNoteHistory       ClinicalNoteHistory[]
  clinicalProfiles          ClinicalProfile[]
  clinicalProfileHistory    ClinicalProfileHistory[]
  dietaryRestrictions       DietaryRestriction[]
  dietaryRestrictionHistory DietaryRestrictionHistory[]
  auditLogs                 AuditLog[]
  buildings                 Building[]
  floors                    Floor[]
  rooms                     Room[]
  beds                      Bed[]
  profile                   TenantProfile?
  documents                 TenantDocument[]
  residentDocuments         ResidentDocument[]
  notifications             Notification[]
  clinicalNoteDocuments     ClinicalNoteDocument[]
  documentHistory           DocumentHistory[]
  pops                      Pop[]
  popAttachments            PopAttachment[]
  popHistory                PopHistory[]
  VitalSignHistory          VitalSignHistory[]
  bedTransferHistory        BedTransferHistory[]
  residentScheduleConfigs   ResidentScheduleConfig[]
  residentScheduledEvents   ResidentScheduledEvent[]
  invoices                  Invoice[] // SuperAdmin - Faturas
  usageMetrics              UsageMetrics[] // SuperAdmin - Métricas de uso
  systemAlerts              SystemAlert[] // SuperAdmin - Alertas

  @@map("tenants")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SUBSCRIPTIONS (Stripe‑style)
// ──────────────────────────────────────────────────────────────────────────────
model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  planId             String    @db.Uuid
  startDate          DateTime  @default(now()) @db.Timestamptz(3)
  endDate            DateTime? @db.Timestamptz(3)
  currentPeriodStart DateTime? @db.Timestamptz(3)
  currentPeriodEnd   DateTime? @db.Timestamptz(3)
  trialEndDate       DateTime? @db.Timestamptz(3)
  status             String // trialing | active | past_due | canceled | unpaid | incomplete

  // Asaas Integration
  asaasSubscriptionId String? @unique @db.VarChar(255) // ID da assinatura no Asaas

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan     Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)
  invoices Invoice[] // SuperAdmin - Faturas da assinatura

  @@map("subscriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USERS (por tenant)
// ──────────────────────────────────────────────────────────────────────────────
model User {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String?   @db.Uuid // Optional: SUPERADMIN has NULL tenantId
  name                  String
  email                 String
  password              String
  cpf                   String? // CPF do usuário (identificação única nacional)
  role                  String // admin | user | viewer (pode virar enum depois)
  isActive              Boolean   @default(true)
  lastLogin             DateTime? @db.Timestamptz(3)
  passwordResetRequired Boolean   @default(false)
  deletedAt             DateTime? @db.Timestamptz(3)

  // Auditoria e Versionamento
  versionNumber Int      @default(1) // Número da versão atual (incrementa a cada UPDATE)
  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)
  createdBy     String?  @db.Uuid // ID do usuário que criou (NULL para primeiro admin)
  updatedBy     String?  @db.Uuid // ID do último usuário que alterou

  tenant                       Tenant?                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile                      UserProfile?
  refreshTokens                RefreshToken[]
  dailyRecords                 DailyRecord[]
  medicationAdministrations    MedicationAdministration[]
  sosAdministrations           SOSAdministration[]
  vitalSigns                   VitalSign[]
  clinicalNotes                ClinicalNote[]
  clinicalNoteHistoryAuthor    ClinicalNoteHistory[]       @relation("ClinicalNoteHistoryProfessional")
  clinicalNoteHistoryChanges   ClinicalNoteHistory[]       @relation("ClinicalNoteHistoryChangedBy")
  clinicalProfilesCreated      ClinicalProfile[]           @relation("ClinicalProfileCreator")
  clinicalProfilesUpdated      ClinicalProfile[]           @relation("ClinicalProfileUpdater")
  clinicalProfileHistory       ClinicalProfileHistory[]    @relation("ClinicalProfileHistoryUser")
  dietaryRestrictionsCreated   DietaryRestriction[]        @relation("DietaryRestrictionCreator")
  dietaryRestrictionsUpdated   DietaryRestriction[]        @relation("DietaryRestrictionUpdater")
  dietaryRestrictionHistory    DietaryRestrictionHistory[] @relation("DietaryRestrictionHistoryUser")
  notifications                Notification[]
  clinicalNoteDocumentsCreated ClinicalNoteDocument[]      @relation("ClinicalNoteDocumentCreator")

  // Relações de versionamento (Resident)
  residentsCreated Resident[]        @relation("ResidentCreator")
  residentsUpdated Resident[]        @relation("ResidentUpdater")
  residentHistory  ResidentHistory[] @relation("ResidentHistoryUser")

  // Relações de versionamento (Prescription)
  prescriptionHistory PrescriptionHistory[] @relation("PrescriptionHistoryUser")

  // Relações de versionamento (Medication)
  medicationsCreated Medication[]        @relation("MedicationCreatedBy")
  medicationsUpdated Medication[]        @relation("MedicationUpdatedBy")
  medicationHistory  MedicationHistory[] @relation("MedicationHistoryUser")

  // Relações de versionamento (SOSMedication)
  sosMedicationsCreated SOSMedication[]        @relation("SOSMedicationCreatedBy")
  sosMedicationsUpdated SOSMedication[]        @relation("SOSMedicationUpdatedBy")
  sosMedicationHistory  SOSMedicationHistory[] @relation("SOSMedicationHistoryUser")

  // Relações de versionamento (Vaccination)
  vaccinationsCreated Vaccination[]        @relation("VaccinationCreatedBy")
  vaccinationsUpdated Vaccination[]        @relation("VaccinationUpdatedBy")
  vaccinationHistory  VaccinationHistory[] @relation("VaccinationHistoryUser")

  // Relações de versionamento (Allergy)
  allergiesCreated Allergy[]        @relation("AllergyCreatedBy")
  allergiesUpdated Allergy[]        @relation("AllergyUpdatedBy")
  allergyHistory   AllergyHistory[] @relation("AllergyHistoryUser")

  // Relações de versionamento (Condition)
  conditionsCreated Condition[]        @relation("ConditionCreatedBy")
  conditionsUpdated Condition[]        @relation("ConditionUpdatedBy")
  conditionHistory  ConditionHistory[] @relation("ConditionHistoryUser")

  // Relações de versionamento (VitalSign)
  vitalSignsCreated VitalSign[]        @relation("VitalSignCreator")
  vitalSignsUpdated VitalSign[]        @relation("VitalSignUpdater")
  vitalSignHistory  VitalSignHistory[] @relation("VitalSignHistoryUser")

  // Relações de versionamento (User) - Self-referencing
  createdByUser      User?                @relation("UserCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser      User?                @relation("UserUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  usersCreated       User[]               @relation("UserCreatedBy")
  usersUpdated       User[]               @relation("UserUpdatedBy")
  userHistory        UserHistory[]        @relation("UserHistoryForUser")
  userHistoryChanges UserHistory[]        @relation("UserHistoryUser")
  bedTransfers       BedTransferHistory[]

  // Relações de versionamento (ResidentScheduleConfig)
  scheduleConfigsCreated ResidentScheduleConfig[] @relation("ScheduleConfigCreatedBy")
  scheduleConfigsUpdated ResidentScheduleConfig[] @relation("ScheduleConfigUpdatedBy")

  // Relações de versionamento (ResidentScheduledEvent)
  scheduledEventsCreated ResidentScheduledEvent[] @relation("ScheduledEventCreatedBy")
  scheduledEventsUpdated ResidentScheduledEvent[] @relation("ScheduledEventUpdatedBy")

  @@unique([tenantId, email])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("users")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REFRESH TOKENS
// ──────────────────────────────────────────────────────────────────────────────
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ──────────────────────────────────────────────────────────────────────────────
//  HISTÓRICO DE ALTERAÇÕES DE USUÁRIOS (Imutável - Compliance LGPD)
// ──────────────────────────────────────────────────────────────────────────────
model UserHistory {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  userId   String @db.Uuid

  // Versionamento
  versionNumber Int // Número da versão (1, 2, 3...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo da alteração (obrigatório, min 10 chars)

  // Campos alterados (array de nomes de campos)
  changedFields String[] @default([])

  // Snapshot completo dos dados (ANTES e DEPOIS da alteração)
  // IMPORTANTE: password sempre mascarado como { passwordChanged: true }
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado novo

  // Auditoria
  changedAt     DateTime @db.Timestamptz(3) // Data/hora da alteração
  changedBy     String   @db.Uuid // Usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)

  // Metadados opcionais (IP, User Agent, etc.)
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text
  metadata  Json?   @db.JsonB

  // Relações
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User   @relation("UserHistoryForUser", fields: [userId], references: [id], onDelete: Cascade)
  changedByUser User   @relation("UserHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)

  // Índices para consultas eficientes
  @@index([tenantId, userId, versionNumber(sort: Desc)]) // Listar histórico por usuário
  @@index([tenantId, changedAt(sort: Desc)]) // Auditoria geral por data
  @@index([changedBy]) // Auditar por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("user_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USER PROFILES
// ──────────────────────────────────────────────────────────────────────────────
model UserProfile {
  id       String @id @default(uuid()) @db.Uuid
  userId   String @unique @db.Uuid
  tenantId String @db.Uuid

  // Dados do Perfil
  profilePhoto String? // URL ou path da foto de perfil
  phone        String?
  cpf          String? // CPF do usuário (sincronizado com User.cpf)
  department   String? // Departamento
  birthDate    DateTime? @db.Timestamptz(3)
  notes        String?   @db.Text
  preferences  Json?     @default("{}") // Preferências do usuário (tema, sidebar, etc)

  // Sistema de Permissões ILPI
  positionCode       PositionCode? // Cargo padronizado ILPI
  registrationType   RegistrationType? // Tipo de registro profissional (COREN, CRM, etc)
  registrationNumber String? // Número do registro no conselho
  registrationState  String? // UF do registro (ex: "SP", "RJ")

  // Flags especiais
  isTechnicalManager   Boolean @default(false) // Se é Responsável Técnico da ILPI
  isNursingCoordinator Boolean @default(false) // Se é Coordenador de Enfermagem

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  // Relações
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customPermissions UserPermission[] // Permissões customizadas/sobrepostas

  @@map("user_profiles")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERMISSÕES CUSTOMIZADAS DE USUÁRIO
//  Permite conceder ou revogar permissões específicas para usuários individuais
// ──────────────────────────────────────────────────────────────────────────────
model UserPermission {
  id            String @id @default(uuid()) @db.Uuid
  userProfileId String @db.Uuid
  tenantId      String @db.Uuid

  // Permissão específica
  permission PermissionType

  // Tipo de customização
  isGranted Boolean @default(true) // true = concedida, false = revogada

  // Auditoria
  grantedBy String   @db.Uuid // ID do usuário que concedeu/revogou
  grantedAt DateTime @default(now()) @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  userProfile UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  // Índices
  @@unique([userProfileId, permission]) // Evita duplicatas de permissão por usuário
  @@index([tenantId, userProfileId])
  @@index([permission])
  @@map("user_permissions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  RESIDENTS – MODELO FINAL (conforme especificação)
// ──────────────────────────────────────────────────────────────────────────────
model Resident {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // 0 – Status
  status String @default("Ativo") // Ativo | Inativo | Falecido

  // 1 – Dados Pessoais
  fullName    String
  socialName  String?
  cpf         String
  rg          String?
  rgIssuer    String?
  education   String?
  profession  String?
  cns         String?
  gender      Gender
  civilStatus CivilStatus?
  religion    String?
  birthDate   DateTime     @db.Timestamptz(3)
  nationality String       @default("Brasileira")
  birthCity   String?
  birthState  String? // UF (2 letras)
  motherName  String?
  fatherName  String?
  fotoUrl     String? // URL da foto do residente no MinIO

  // 2 – Endereços
  // Atual
  currentCep        String?
  currentState      String?
  currentCity       String?
  currentStreet     String?
  currentNumber     String?
  currentComplement String?
  currentDistrict   String?
  currentPhone      String?

  // Procedência
  originCep        String?
  originState      String?
  originCity       String?
  originStreet     String?
  originNumber     String?
  originComplement String?
  originDistrict   String?
  originPhone      String?

  // 3 – Contatos de Emergência (array JSON)
  emergencyContacts Json @default("[]")
  // [{ "name": "...", "phone": "...", "relationship": "..." }]

  // 4 – Responsável Legal
  legalGuardianName       String?
  legalGuardianCpf        String?
  legalGuardianRg         String?
  legalGuardianPhone      String?
  legalGuardianType       String? // curador | procurador | responsável convencional
  legalGuardianCep        String?
  legalGuardianState      String?
  legalGuardianCity       String?
  legalGuardianStreet     String?
  legalGuardianNumber     String?
  legalGuardianComplement String?
  legalGuardianDistrict   String?

  // 5 – Admissão
  admissionDate       DateTime  @db.Timestamptz(3)
  admissionType       String? // Voluntária | Involuntária | Judicial | outro
  admissionReason     String?
  admissionConditions String?
  dischargeDate       DateTime? @db.Timestamptz(3)
  dischargeReason     String?

  // 6 – Saúde (Dados Estáveis - dados clínicos evolutivos migraram para clinical_profiles)
  bloodType              BloodType @default(NAO_INFORMADO)
  height                 Decimal?  @db.Decimal(5, 2) // metros
  weight                 Decimal?  @db.Decimal(5, 1) // kg
  dependencyLevel        String? // Grau I - Independente | Grau II - Semidependente | Grau III - Dependente
  mobilityAid            Boolean?
  medicationsOnAdmission String?

  // 7 – Convênios / Planos de Saúde
  healthPlans Json @default("[]")
  // [{ "name": "...", "cardNumber": "...", "cardUrl": "..." }]

  // 8 – Pertences
  belongings Json @default("[]")
  // ["Óculos", "Aparelho auditivo", ...]

  // 9 – Acomodação
  roomId String? @db.Uuid
  bedId  String? @unique @db.Uuid

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // Número da versão atual (incrementa a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String    @db.Uuid // ID do usuário que criou o registro
  updatedBy     String?   @db.Uuid // ID do último usuário que alterou

  // Relações
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator                   User                       @relation("ResidentCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updater                   User?                      @relation("ResidentUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  history                   ResidentHistory[] // Histórico de alterações (imutável)
  bed                       Bed?                       @relation(fields: [bedId], references: [id])
  dailyRecords              DailyRecord[]
  prescriptions             Prescription[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  vitalSigns                VitalSign[]
  clinicalNotes             ClinicalNote[]
  clinicalNoteHistory       ClinicalNoteHistory[]
  residentDocuments         ResidentDocument[]
  clinicalProfile           ClinicalProfile?
  allergies                 Allergy[]
  conditions                Condition[]
  dietaryRestrictions       DietaryRestriction[]
  clinicalNoteDocuments     ClinicalNoteDocument[]
  bedTransferHistory        BedTransferHistory[]
  scheduleConfigs           ResidentScheduleConfig[]
  scheduledEvents           ResidentScheduledEvent[]

  // Índices
  @@unique([tenantId, cpf])
  @@index([tenantId, status])
  @@index([tenantId, admissionDate(sort: Desc)])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("residents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  HISTÓRICO DE ALTERAÇÕES DE RESIDENTES (Imutável - Compliance RDC 502/2021)
// ──────────────────────────────────────────────────────────────────────────────
model ResidentHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Versionamento
  versionNumber Int // Número da versão (1, 2, 3...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo da alteração (obrigatório, min 10 chars)

  // Campos alterados (array de nomes de campos)
  changedFields String[] @default([])

  // Snapshot completo dos dados (ANTES e DEPOIS da alteração)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado novo

  // Auditoria
  changedAt DateTime @db.Timestamptz(3) // Data/hora da alteração
  changedBy String   @db.Uuid // Usuário que fez a alteração

  // Metadados opcionais (IP, User Agent, etc.)
  metadata Json? @default("{}")

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation("ResidentHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)

  // Índices para consultas eficientes
  @@index([tenantId, residentId, versionNumber(sort: Desc)]) // Listar histórico por residente
  @@index([tenantId, changedAt(sort: Desc)]) // Auditoria geral por data
  @@index([changedBy]) // Auditar por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("resident_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERFIL CLÍNICO DO RESIDENTE
// ──────────────────────────────────────────────────────────────────────────────
model ClinicalProfile {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @unique @db.Uuid

  // Dados clínicos textuais
  healthStatus      String? @db.Text
  specialNeeds      String? @db.Text
  functionalAspects String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // Número da versão atual (incrementa a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String?   @db.Uuid // ID do usuário que criou (pode ser NULL se criado automaticamente)
  updatedBy     String?   @db.Uuid // ID do último usuário que alterou

  // Relações
  tenant   Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident                 @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator  User?                    @relation("ClinicalProfileCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater  User?                    @relation("ClinicalProfileUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  history  ClinicalProfileHistory[] // Histórico de versões

  // Índices
  @@index([tenantId, residentId])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("clinical_profiles")
}

// ──────────────────────────────────────────────────────────────────────────────
//  HISTÓRICO DE PERFIL CLÍNICO (VERSIONAMENTO)
// ──────────────────────────────────────────────────────────────────────────────
model ClinicalProfileHistory {
  id                String     @id @default(uuid()) @db.Uuid
  tenantId          String     @db.Uuid
  clinicalProfileId String     @db.Uuid
  versionNumber     Int // Número da versão (1, 2, 3, ...)
  changeType        ChangeType // CREATE | UPDATE | DELETE
  changeReason      String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["healthStatus", "specialNeeds", "functionalAspects"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clinicalProfile ClinicalProfile @relation(fields: [clinicalProfileId], references: [id], onDelete: Cascade)
  user            User            @relation("ClinicalProfileHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, clinicalProfileId, versionNumber(sort: Desc)]) // Buscar histórico de um perfil
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("clinical_profile_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ALERGIAS
// ──────────────────────────────────────────────────────────────────────────────
model Allergy {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados da alergia
  substance String // Medicamento, alimento, látex, etc.
  reaction  String?          @db.Text // Descrição da reação
  severity  AllergySeverity?

  // Observações
  notes String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident         @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User             @relation("AllergyCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?            @relation("AllergyUpdatedBy", fields: [updatedBy], references: [id])
  history       AllergyHistory[]

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([substance])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("allergies")
}

model AllergyHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  allergyId     String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text

  previousData  Json?
  newData       Json
  changedFields String[] @default([])

  changedAt     DateTime @db.Timestamptz(3)
  changedBy     String   @db.Uuid
  changedByName String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?    @db.JsonB

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  allergy Allergy @relation(fields: [allergyId], references: [id], onDelete: Cascade)
  user    User    @relation("AllergyHistoryUser", fields: [changedBy], references: [id])

  @@index([tenantId, allergyId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@index([changeType])
  @@map("allergy_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  CONDIÇÕES CRÔNICAS / DIAGNÓSTICOS
// ──────────────────────────────────────────────────────────────────────────────
model Condition {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados do diagnóstico
  condition String // Nome da condição
  icdCode   String? @db.VarChar(10) // CID-10 (opcional)
  notes     String? @db.Text // Observações clínicas

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User               @relation("ConditionCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?              @relation("ConditionUpdatedBy", fields: [updatedBy], references: [id])
  history       ConditionHistory[]

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([condition])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("conditions")
}

model ConditionHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  conditionId   String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text

  previousData  Json?
  newData       Json
  changedFields String[] @default([])

  changedAt     DateTime @db.Timestamptz(3)
  changedBy     String   @db.Uuid
  changedByName String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?    @db.JsonB

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  condition Condition @relation(fields: [conditionId], references: [id], onDelete: Cascade)
  user      User      @relation("ConditionHistoryUser", fields: [changedBy], references: [id])

  @@index([tenantId, conditionId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@index([changeType])
  @@map("condition_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  RESTRIÇÕES ALIMENTARES
// ──────────────────────────────────────────────────────────────────────────────
model DietaryRestriction {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados da restrição
  restrictionType RestrictionType
  description     String // Ex: "Sem glúten", "Dieta hipossódica"
  notes           String?         @db.Text // Observações do nutricionista

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // Número da versão atual (incrementa a cada UPDATE)
  createdBy     String    @db.Uuid // ID do usuário que criou o registro
  updatedBy     String?   @db.Uuid // ID do último usuário que alterou
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident                    @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator  User                        @relation("DietaryRestrictionCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updater  User?                       @relation("DietaryRestrictionUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  history  DietaryRestrictionHistory[] // Histórico de versões

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([restrictionType])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("dietary_restrictions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  HISTÓRICO DE RESTRIÇÕES ALIMENTARES (VERSIONAMENTO)
// ──────────────────────────────────────────────────────────────────────────────
model DietaryRestrictionHistory {
  id                   String     @id @default(uuid()) @db.Uuid
  tenantId             String     @db.Uuid
  dietaryRestrictionId String     @db.Uuid
  versionNumber        Int // Número da versão (1, 2, 3, ...)
  changeType           ChangeType // CREATE | UPDATE | DELETE
  changeReason         String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["restrictionType", "description", "notes"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dietaryRestriction DietaryRestriction @relation(fields: [dietaryRestrictionId], references: [id], onDelete: Cascade)
  user               User               @relation("DietaryRestrictionHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, dietaryRestrictionId, versionNumber(sort: Desc)]) // Buscar histórico de uma restrição
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("dietary_restriction_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  DOCUMENTOS DE RESIDENTES
// ──────────────────────────────────────────────────────────────────────────────
model ResidentDocument {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de documento
  type String @db.VarChar(100)
  // Tipos possíveis:
  // - CARTAO_CONVENIO
  // - COMPROVANTE_RESIDENCIA_RESIDENTE
  // - DOCUMENTOS_RESPONSAVEL_LEGAL
  // - COMPROVANTE_RESIDENCIA_RESPONSAVEL
  // - DOCUMENTOS_PESSOAIS
  // - LAUDO_MEDICO
  // - TERMO_ADMISSAO
  // - TERMO_CONSENTIMENTO_IMAGEM
  // - TERMO_CONSENTIMENTO_LGPD

  // Arquivo
  fileUrl  String // URL completa do arquivo no S3/MinIO
  fileKey  String? // Chave do arquivo no S3 para deleção
  fileName String // Nome original do arquivo
  fileSize Int? // Tamanho em bytes
  mimeType String? @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Detalhes opcionais (ex: "Unimed", "Laudo de entrada", etc.)
  details String? @db.Text

  // Auditoria
  uploadedBy String    @db.Uuid // ID do usuário que fez upload
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId, type])
  @@index([deletedAt])
  @@map("resident_documents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REGISTROS DIÁRIOS
// ──────────────────────────────────────────────────────────────────────────────
model DailyRecord {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo e metadados
  type RecordType
  date DateTime   @db.Timestamptz(3) // Data do registro (sem hora)
  time String // Hora no formato "HH:mm" (ex: "07:00", "14:30")

  // Dados estruturados (JSON) - cada tipo tem sua própria estrutura
  data Json @default("{}")

  // Responsável pelo registro
  recordedBy String // Nome do profissional
  userId     String @db.Uuid // ID do usuário que fez o registro

  // Observações gerais (opcional)
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Relação com histórico de versões
  history DailyRecordHistory[]

  // Índices para performance
  @@index([tenantId, residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc), time])
  @@index([deletedAt])
  @@map("daily_records")
}

// Histórico de Versões de Registros Diários (para conformidade com prontuário eletrônico)
model DailyRecordHistory {
  id            String @id @default(uuid()) @db.Uuid
  recordId      String @db.Uuid // FK para DailyRecord
  tenantId      String @db.Uuid
  versionNumber Int // Número sequencial da versão (1, 2, 3...)

  // Dados da versão anterior (snapshot completo)
  previousData Json // Snapshot completo do estado anterior

  // Dados da nova versão (para comparação)
  newData Json // Snapshot completo do novo estado

  // Campos alterados (array de nomes de campos: ["time", "data.pressao"])
  changedFields Json @default("[]")

  // Auditoria da mudança
  changeType    String // "UPDATE" ou "DELETE"
  changeReason  String   @db.Text // Motivo obrigatório da mudança
  changedBy     String   @db.Uuid // ID do usuário que fez a mudança
  changedByName String // Nome do usuário que fez a mudança
  changedAt     DateTime @default(now()) @db.Timestamptz(3)

  // IP e User Agent para auditoria adicional
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Relações
  record DailyRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([recordId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("daily_record_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  AGENDA DO RESIDENTE - CONFIGURAÇÕES DE REGISTROS OBRIGATÓRIOS
// ──────────────────────────────────────────────────────────────────────────────
model ResidentScheduleConfig {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de registro obrigatório (usa enum RecordType existente)
  recordType RecordType

  // Frequência de recorrência
  frequency ScheduleFrequency

  // Configurações específicas por frequência
  // Para WEEKLY: 0-6 (0=Domingo, 1=Segunda, ..., 6=Sábado)
  // Para MONTHLY: 1-31 (dia do mês)
  // Para DAILY: null
  dayOfWeek  Int? // 0-6 (apenas para WEEKLY)
  dayOfMonth Int? // 1-31 (apenas para MONTHLY)

  // Horários sugeridos - array de strings "HH:mm"
  // Ex: ["08:00", "14:00"] para 2x ao dia
  suggestedTimes Json @default("[]")

  // Status
  isActive Boolean @default(true)

  // Observações
  notes String? @db.Text

  // Metadados extras (JSON) - usado para armazenar informações específicas por tipo
  // Ex: para ALIMENTACAO: { "mealType": "Café da Manhã" }
  metadata Json? @default("{}")

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ScheduleConfigCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("ScheduleConfigUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId, isActive])
  @@index([recordType])
  @@index([deletedAt])
  @@map("resident_schedule_configs")
}

// ──────────────────────────────────────────────────────────────────────────────
//  AGENDA DO RESIDENTE - AGENDAMENTOS PONTUAIS
// ──────────────────────────────────────────────────────────────────────────────
model ResidentScheduledEvent {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de evento
  eventType ScheduledEventType

  // Data e hora do agendamento
  scheduledDate DateTime @db.Timestamptz(3)
  scheduledTime String // HH:mm

  // Detalhes do evento
  title       String // Ex: "Vacina Influenza - 1ª dose"
  description String? @db.Text

  // Campos específicos para vacinas (quando eventType = VACCINATION)
  vaccineData Json? // {vaccine, dose, manufacturer, etc}

  // Status
  status ScheduledEventStatus @default(SCHEDULED)

  // Referência ao registro criado (quando status = COMPLETED)
  completedRecordId String?   @db.Uuid
  completedAt       DateTime? @db.Timestamptz(3)

  // Observações
  notes String? @db.Text

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ScheduledEventCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("ScheduledEventUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([tenantId, scheduledDate])
  @@index([residentId, scheduledDate])
  @@index([status, scheduledDate])
  @@index([eventType])
  @@index([deletedAt])
  @@map("resident_scheduled_events")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SINAIS VITAIS (Tabela dedicada para análises e consultas otimizadas)
// ──────────────────────────────────────────────────────────────────────────────
model VitalSign {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid
  userId     String @db.Uuid // ID do usuário que registrou

  // Timestamp do registro (data + hora completa)
  timestamp DateTime @db.Timestamptz(3)

  // Sinais Vitais (todos opcionais - registra apenas os que foram aferidos)
  systolicBloodPressure  Float? // Pressão arterial sistólica (mmHg)
  diastolicBloodPressure Float? // Pressão arterial diastólica (mmHg)
  temperature            Float? // Temperatura corporal (°C)
  heartRate              Int? // Frequência cardíaca (bpm)
  oxygenSaturation       Float? // Saturação periférica de O₂ (%)
  bloodGlucose           Float? // Glicemia (mg/dL)

  // Versionamento (RDC 502/2021 + LGPD)
  versionNumber Int     @default(1)
  createdBy     String  @db.Uuid
  updatedBy     String? @db.Uuid

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  creator  User               @relation("VitalSignCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updater  User?              @relation("VitalSignUpdater", fields: [updatedBy], references: [id], onDelete: Restrict)
  history  VitalSignHistory[]

  // Índices para consultas otimizadas
  @@index([tenantId, residentId, timestamp(sort: Desc)])
  @@index([residentId, timestamp(sort: Desc)])
  @@index([tenantId, timestamp(sort: Desc)])
  @@index([deletedAt])
  @@map("vital_signs")
}

model VitalSignHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  vitalSignId   String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text
  previousData  Json?
  newData       Json?
  changedFields String[]
  changedAt     DateTime   @db.Timestamptz(3)
  changedBy     String     @db.Uuid

  // Relações
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vitalSign VitalSign @relation(fields: [vitalSignId], references: [id], onDelete: Cascade)
  user      User      @relation("VitalSignHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)

  @@index([vitalSignId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@map("vital_sign_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PRESCRIÇÕES MÉDICAS
// ──────────────────────────────────────────────────────────────────────────────
model Prescription {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados do Prescritor
  doctorName       String
  doctorCrm        String
  doctorCrmState   String // UF
  prescriptionDate DateTime         @db.Timestamptz(3)
  prescriptionType PrescriptionType
  validUntil       DateTime?        @db.Timestamptz(3) // Obrigatório para ANTIBIOTICO e CONTROLADO
  reviewDate       DateTime?        @db.Timestamptz(3) // Data estimada para revisão da prescrição

  // Campos específicos para CONTROLADO
  controlledClass    ControlledClass?
  notificationNumber String?
  notificationType   NotificationType?

  // Anexos
  prescriptionImageUrl String? // URL da receita médica (obrigatório para controlado)

  // Observações gerais
  notes String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // Número da versão atual (incrementado a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String    @db.Uuid // ID do usuário que criou
  updatedBy     String?   @db.Uuid // ID do último usuário que alterou

  // Relações
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident           Resident                   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  medications        Medication[]
  sosMedications     SOSMedication[]
  administrations    MedicationAdministration[]
  sosAdministrations SOSAdministration[]
  history            PrescriptionHistory[] // Histórico de versões da prescrição

  // Índices
  @@index([tenantId, residentId])
  @@index([tenantId, isActive])
  @@index([tenantId, validUntil])
  @@index([deletedAt])
  @@map("prescriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  HISTÓRICO DE PRESCRIÇÕES (VERSIONAMENTO)
// ──────────────────────────────────────────────────────────────────────────────
model PrescriptionHistory {
  id             String     @id @default(uuid()) @db.Uuid
  tenantId       String     @db.Uuid
  prescriptionId String     @db.Uuid
  versionNumber  Int // Número da versão (1, 2, 3, ...)
  changeType     ChangeType // CREATE | UPDATE | DELETE
  changeReason   String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["doctorName", "validUntil", "medications.0.dose"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  user         User         @relation("PrescriptionHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, prescriptionId, versionNumber(sort: Desc)]) // Buscar histórico de uma prescrição
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("prescription_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAMENTOS CONTÍNUOS
// ──────────────────────────────────────────────────────────────────────────────
model Medication {
  id             String @id @default(uuid()) @db.Uuid
  prescriptionId String @db.Uuid

  // Dados do medicamento
  name           String // DCB (Denominação Comum Brasileira)
  presentation   MedicationPresentation
  concentration  String // Ex: "500mg", "5mg/mL"
  dose           String // Ex: "1 cp", "20 gotas"
  route          AdministrationRoute
  frequency      MedicationFrequency
  scheduledTimes Json                   @default("[]") // Array de horários: ["06:00", "14:00", "22:00"]

  // Período
  startDate DateTime  @db.Timestamptz(3)
  endDate   DateTime? @db.Timestamptz(3) // null = uso contínuo

  // Flags especiais
  isControlled        Boolean @default(false)
  isHighRisk          Boolean @default(false)
  requiresDoubleCheck Boolean @default(false) // Exige dupla checagem

  // Observações
  instructions String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  prescription    Prescription               @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  administrations MedicationAdministration[]
  history         MedicationHistory[]
  createdByUser   User                       @relation("MedicationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?                      @relation("MedicationUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([prescriptionId])
  @@index([isControlled])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("medications")
}

model MedicationHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  medicationId  String     @db.Uuid
  versionNumber Int // Número da versão (1, 2, 3, ...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["name", "dose", "frequency"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  user       User       @relation("MedicationHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, medicationId, versionNumber(sort: Desc)]) // Buscar histórico de um medicamento
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("medication_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAÇÕES SOS (uso eventual)
// ──────────────────────────────────────────────────────────────────────────────
model SOSMedication {
  id             String @id @default(uuid()) @db.Uuid
  prescriptionId String @db.Uuid

  // Dados do medicamento
  name          String
  presentation  MedicationPresentation
  concentration String
  dose          String
  route         AdministrationRoute

  // Indicação e limites
  indication        SOSIndicationType
  indicationDetails String? // Ex: "dor > 7", "febre > 38°C"
  minInterval       String // Ex: "6 horas", "4 horas"
  maxDailyDoses     Int // Limite diário (ex: 3)

  // Período de validade
  startDate DateTime  @db.Timestamptz(3)
  endDate   DateTime? @db.Timestamptz(3)

  // Observações
  instructions String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  prescription       Prescription           @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosAdministrations SOSAdministration[]
  history            SOSMedicationHistory[]
  createdByUser      User                   @relation("SOSMedicationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?                  @relation("SOSMedicationUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([prescriptionId])
  @@index([indication])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("sos_medications")
}

model SOSMedicationHistory {
  id              String     @id @default(uuid()) @db.Uuid
  tenantId        String     @db.Uuid
  sosMedicationId String     @db.Uuid
  versionNumber   Int // Número da versão (1, 2, 3, ...)
  changeType      ChangeType // CREATE | UPDATE | DELETE
  changeReason    String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["name", "dose", "indication"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  user          User          @relation("SOSMedicationHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, sosMedicationId, versionNumber(sort: Desc)]) // Buscar histórico de um medicamento SOS
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("sos_medication_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ADMINISTRAÇÃO DE MEDICAMENTOS CONTÍNUOS
// ──────────────────────────────────────────────────────────────────────────────
model MedicationAdministration {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  prescriptionId String @db.Uuid
  medicationId   String @db.Uuid
  residentId     String @db.Uuid

  // Data/hora da administração
  date          DateTime @db.Timestamptz(3)
  scheduledTime String // Horário programado (ex: "06:00")
  actualTime    String? // Horário real de administração (se diferente)

  // Status
  wasAdministered Boolean @default(false)
  reason          String? // Motivo de não administração

  // Checagem
  administeredBy  String // Nome do profissional
  userId          String  @db.Uuid
  checkedBy       String? // Para dupla checagem
  checkedByUserId String? @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication   Medication   @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([medicationId, date])
  @@index([wasAdministered])
  @@map("medication_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ADMINISTRAÇÃO DE MEDICAÇÕES SOS
// ──────────────────────────────────────────────────────────────────────────────
model SOSAdministration {
  id              String @id @default(uuid()) @db.Uuid
  tenantId        String @db.Uuid
  prescriptionId  String @db.Uuid
  sosMedicationId String @db.Uuid
  residentId      String @db.Uuid

  // Data/hora
  date DateTime @db.Timestamptz(3)
  time String // Horário da administração

  // Motivo
  indication String // Descrição do motivo (ex: "dor intensa no joelho")

  // Checagem
  administeredBy String
  userId         String @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription  Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  resident      Resident      @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([sosMedicationId, date])
  @@map("sos_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  VACINAÇÕES / IMUNIZAÇÕES (RDC 502/2021 - Art. 39)
// ──────────────────────────────────────────────────────────────────────────────
model Vaccination {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // 11 Campos obrigatórios (RDC 502/2021)
  vaccine        String // 1) Vacina/Profilaxia (ex: "COVID-19", "Influenza")
  dose           String // 3) Dose (ex: "1ª dose", "2ª dose", "Reforço")
  date           DateTime @db.Timestamptz(3) // 2) Data da vacinação
  batch          String // 4) Lote do imunizante
  manufacturer   String // 5) Fabricante
  cnes           String // 6) CNES (Código Nacional do Estabelecimento de Saúde)
  healthUnit     String // 7) Estabelecimento de Saúde
  municipality   String // 8) Município
  state          String // 9) UF (2 caracteres)
  certificateUrl String? // 10) URL do comprovante (file upload)
  notes          String?  @db.Text // 11) Observações adicionais

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3) // Soft delete

  // Relações
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident             @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User                 @relation("VaccinationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?                @relation("VaccinationUpdatedBy", fields: [updatedBy], references: [id])
  history       VaccinationHistory[]

  // Índices para performance
  @@index([tenantId, residentId])
  @@index([residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("vaccinations")
}

model VaccinationHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  vaccinationId String     @db.Uuid
  versionNumber Int
  changeType    ChangeType
  changeReason  String     @db.Text

  // Snapshots dos dados (JSON)
  previousData Json?
  newData      Json

  // Campos alterados (array de strings)
  changedFields String[] @default([])

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3)
  changedBy     String   @db.Uuid
  changedByName String?
  ipAddress     String?
  userAgent     String?

  // Metadados adicionais
  metadata Json? @db.JsonB

  // Relações
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vaccination Vaccination @relation(fields: [vaccinationId], references: [id], onDelete: Cascade)
  user        User        @relation("VaccinationHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, vaccinationId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@index([changeType])
  @@map("vaccination_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  EVOLUÇÕES CLÍNICAS MULTIPROFISSIONAIS (SOAP)
//  RDC 502/2021 - Art. 39 (Prontuário Eletrônico)
// ──────────────────────────────────────────────────────────────────────────────
model ClinicalNote {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  residentId     String @db.Uuid
  professionalId String @db.Uuid

  // Profissão do autor
  profession ClinicalProfession

  // Data/hora da evolução
  noteDate DateTime @default(now()) @db.Timestamptz(3)

  // Método SOAP
  subjective String? @db.Text // S - Subjetivo
  objective  String? @db.Text // O - Objetivo
  assessment String? @db.Text // A - Avaliação
  plan       String? @db.Text // P - Plano

  // Tags para filtros e dashboards
  tags String[] @default([])

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  // Versionamento
  version   Int     @default(1)
  isAmended Boolean @default(false) // Marcado como obsoleto

  // Janela de edição (12 horas)
  editableUntil DateTime @db.Timestamptz(3) // noteDate + 12h

  // Relações
  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident     Resident               @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional User                   @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  history      ClinicalNoteHistory[]
  documents    ClinicalNoteDocument[]

  // Índices
  @@index([tenantId, residentId, noteDate(sort: Desc)])
  @@index([tenantId, professionalId])
  @@index([profession])
  @@index([noteDate])
  @@index([tags])
  @@index([isAmended])
  @@map("clinical_notes")
}

// Histórico de Versões de Evoluções Clínicas (audit trail completo)
model ClinicalNoteHistory {
  id      String @id @default(uuid()) @db.Uuid
  noteId  String @db.Uuid
  version Int

  // Snapshot completo
  tenantId       String             @db.Uuid
  residentId     String             @db.Uuid
  professionalId String             @db.Uuid
  profession     ClinicalProfession
  noteDate       DateTime           @db.Timestamptz(3)
  subjective     String?            @db.Text
  objective      String?            @db.Text
  assessment     String?            @db.Text
  plan           String?            @db.Text
  tags           String[]           @default([])

  // Auditoria de alteração
  changeReason String   @db.Text // Motivo obrigatório (minLength 10)
  changedAt    DateTime @default(now()) @db.Timestamptz(3)
  changedBy    String   @db.Uuid

  // Relações
  note          ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional  User         @relation("ClinicalNoteHistoryProfessional", fields: [professionalId], references: [id], onDelete: Restrict)
  changedByUser User         @relation("ClinicalNoteHistoryChangedBy", fields: [changedBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([noteId, version])
  @@index([tenantId, residentId])
  @@index([changedAt])
  @@map("clinical_notes_history")
}

// Documentos anexados às Evoluções Clínicas (gerados com Tiptap)
model ClinicalNoteDocument {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  noteId     String @db.Uuid
  residentId String @db.Uuid

  title        String   @db.VarChar(255)
  type         String?  @db.VarChar(100)
  documentDate DateTime @db.Timestamptz(3)

  // Conteúdo HTML (para futura edição)
  htmlContent String @db.Text

  // PDF no MinIO
  pdfFileUrl  String?
  pdfFileKey  String?
  pdfFileName String? @db.VarChar(255)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clinicalNote ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator      User         @relation("ClinicalNoteDocumentCreator", fields: [createdBy], references: [id])

  @@index([tenantId, residentId])
  @@index([noteId])
  @@map("clinical_note_documents")
}

// ==========================================
// AUDITORIA
// ==========================================

model AuditLog {
  id         Int      @id @default(autoincrement())
  tenantId   String   @map("tenant_id") @db.Uuid
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.VarChar(255)
  action     String   @db.VarChar(50)
  userId     String   @map("user_id") @db.VarChar(255)
  userName   String   @map("user_name") @db.VarChar(255)
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([entityType])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ──────────────────────────────────────────────────────────────────────────────
//  GESTÃO DE LEITOS (MAPA DE OCUPAÇÃO)
//  Estrutura: Building → Floor → Room → Bed
// ──────────────────────────────────────────────────────────────────────────────

// NÍVEL 1: PRÉDIOS / BLOCOS / CASAS
model Building {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  name        String // "Casa Principal", "Bloco A"
  code        String // "PRED-001", "BLOCO-A"
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floors Floor[]

  @@index([tenantId, isActive])
  @@map("buildings")
}

// NÍVEL 2: ANDARES / SETORES / ALAS / PAVILHÕES
model Floor {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  buildingId  String    @db.Uuid
  name        String // "Térreo", "1º Andar", "Ala Feminina"
  code        String // "PISO-0", "PISO-1"
  orderIndex  Int       @default(0) // Ordenação visual (crescente)
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@index([tenantId, buildingId])
  @@index([buildingId, orderIndex])
  @@index([deletedAt])
  @@map("floors")
}

// NÍVEL 3: QUARTOS / ENFERMARIAS / SUÍTES
model Room {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  floorId            String    @db.Uuid
  name               String // "101", "Quarto 3"
  code               String // "Q-101", "Q-102"
  roomNumber         String // "101", "102"
  capacity           Int       @default(1) // Número total de leitos (calculado automaticamente)
  roomType           String? // "Coletivo", "Suíte", "Enfermaria", "Individual", "Duplo", "Triplo"
  genderRestriction  String? // null, "M", "F"
  hasBathroom        Boolean   @default(false) // Se o quarto tem banheiro
  hasPrivateBathroom Boolean   @default(false) // Se tem banheiro privativo
  accessible         Boolean   @default(false) // Se é acessível para PCD
  observations       String?   @db.Text // Observações adicionais
  notes              String?   @db.Text
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt          DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt          DateTime? @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floor  Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds   Bed[]

  @@index([tenantId, floorId])
  @@index([floorId, isActive])
  @@index([deletedAt])
  @@map("rooms")
}

// NÍVEL 4: LEITOS (conecta com Residents)
model Bed {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @db.Uuid
  roomId    String    @db.Uuid
  code      String // "101-A", "101-B", "Leito 1"
  status    String    @default("Disponível") // "Disponível", "Ocupado", "Manutenção" (calculado dinamicamente)
  notes     String?   @db.Text
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room          Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  resident      Resident?
  transfersFrom BedTransferHistory[] @relation("BedTransferFrom")
  transfersTo   BedTransferHistory[] @relation("BedTransferTo")

  @@unique([tenantId, code]) // Código do leito único por tenant
  @@index([tenantId, roomId])
  @@index([roomId, status])
  @@index([tenantId, status])
  @@index([deletedAt])
  @@map("beds")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERFIL INSTITUCIONAL
//  Informações regulatórias, documentação e compliance da ILPI
// ──────────────────────────────────────────────────────────────────────────────

// ENUM: Natureza Jurídica da Instituição
enum LegalNature {
  ASSOCIACAO // Associação sem fins lucrativos
  FUNDACAO // Fundação privada
  EMPRESA_PRIVADA // Empresa privada
  MEI // Microempreendedor Individual

  @@map("LegalNature")
}

// PERFIL INSTITUCIONAL (1:1 com Tenant)
model TenantProfile {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @unique @db.Uuid

  // Logo e identidade visual
  logoUrl String? // URL do logo no S3/MinIO
  logoKey String? // Chave do arquivo no S3 para deleção

  // Natureza jurídica e dados básicos
  legalNature LegalNature?
  tradeName   String? // Nome fantasia

  // Dados regulatórios
  cnesCode         String? @db.VarChar(20) // Código CNES (Cadastro Nacional de Estabelecimentos de Saúde)
  capacityDeclared Int? // Capacidade declarada de residentes
  capacityLicensed Int? // Capacidade licenciada pela vigilância sanitária

  // Contatos institucionais
  contactPhone String?
  contactEmail String?
  websiteUrl   String?

  // Informações complementares
  foundedAt DateTime? @db.Timestamptz(3) // Data de fundação
  mission   String?   @db.Text // Missão institucional
  vision    String?   @db.Text // Visão institucional
  values    String?   @db.Text // Valores institucionais

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId])
  @@index([legalNature])
  @@index([deletedAt])
  @@map("tenant_profiles")
}

// ENUM: Status de compliance do documento
enum DocumentStatus {
  OK // Documento OK (sem vencimento ou com vencimento > 30 dias)
  PENDENTE // Documento obrigatório não enviado
  VENCENDO // Vence em <= 30 dias
  VENCIDO // Vencimento ultrapassado

  @@map("DocumentStatus")
}

// DOCUMENTOS INSTITUCIONAIS
model TenantDocument {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // Tipo de documento (baseado na natureza jurídica)
  type String @db.VarChar(100) // ESTATUTO, CMI, CNPJ, ALVARA_USO, etc.

  // Arquivo
  fileUrl  String // URL completa do arquivo no S3/MinIO
  fileKey  String? // Chave do arquivo no S3 para deleção
  fileName String // Nome original do arquivo
  fileSize Int? // Tamanho em bytes
  mimeType String? @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Metadados do documento
  issuedAt       DateTime?      @db.Timestamptz(3) // Data de emissão
  expiresAt      DateTime?      @db.Timestamptz(3) // Data de vencimento (se aplicável)
  status         DocumentStatus @default(PENDENTE) // Calculado automaticamente
  documentNumber String?        @db.VarChar(100) // Número do documento (ex: protocolo, número de alvará)
  issuerEntity   String?        @db.VarChar(200) // Entidade emissora (ex: Vigilância Sanitária, Corpo de Bombeiros)
  tags           String[]       @default([]) // Tags para categorização adicional

  // Observações
  notes String? @db.Text

  // Versionamento e substituição
  version      Int       @default(1) // Versão do documento (incrementa a cada substituição)
  replacedById String?   @db.Uuid // ID do documento que substituiu este
  replacedAt   DateTime? @db.Timestamptz(3) // Data em que foi substituído

  // Auditoria
  uploadedBy String    @db.Uuid // ID do usuário que fez upload
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replacedBy TenantDocument?   @relation("DocumentReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces   TenantDocument[]  @relation("DocumentReplacement")
  history    DocumentHistory[]

  // Índices
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, expiresAt])
  @@index([expiresAt])
  @@index([status])
  @@index([deletedAt])
  @@index([replacedById])
  @@index([version])
  @@map("tenant_documents")
}

// Histórico de documentos para auditoria completa
model DocumentHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  documentId String @db.Uuid // Documento atual relacionado

  // Ação realizada
  action DocumentAction // CREATED, UPDATED, REPLACED, DELETED
  reason String?        @db.Text // Motivo da alteração

  // Snapshot dos dados anteriores (JSON)
  previousData Json? // Estado anterior do documento
  newData      Json? // Novo estado do documento

  // Campos que mudaram
  changedFields String[] @default([]) // Lista de campos alterados

  // Auditoria
  changedBy String   @db.Uuid // Usuário que realizou a ação
  changedAt DateTime @default(now()) @db.Timestamptz(3)

  // Relações
  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document TenantDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, documentId])
  @@index([documentId])
  @@index([action])
  @@index([changedAt])
  @@map("document_history")
}

// Enum para ações de histórico de documentos
enum DocumentAction {
  CREATED // Documento criado
  UPDATED // Metadados atualizados
  REPLACED // Arquivo substituído
  DELETED // Documento deletado
}

// ============================================
// NOTIFICATIONS SYSTEM
// ============================================

enum SystemNotificationType {
  // Prescrições
  PRESCRIPTION_EXPIRED
  PRESCRIPTION_EXPIRING
  PRESCRIPTION_MISSING_RECEIPT
  PRESCRIPTION_CONTROLLED_NO_RECEIPT

  // Sinais Vitais
  VITAL_SIGN_ABNORMAL_BP
  VITAL_SIGN_ABNORMAL_GLUCOSE
  VITAL_SIGN_ABNORMAL_TEMPERATURE
  VITAL_SIGN_ABNORMAL_HEART_RATE
  VITAL_SIGN_ABNORMAL_RESPIRATORY_RATE

  // Documentos
  DOCUMENT_EXPIRED
  DOCUMENT_EXPIRING

  // Registro Diário
  DAILY_RECORD_MISSING

  // Medicação
  MEDICATION_ADMINISTRATION_MISSED
  MEDICATION_ADMINISTRATION_LATE

  // POPs
  POP_REVIEW_DUE

  // Sistema
  SYSTEM_UPDATE
  SYSTEM_MAINTENANCE
  USER_MENTION

  // Agendamentos
  SCHEDULED_EVENT_DUE
  SCHEDULED_EVENT_MISSED
}

enum NotificationCategory {
  PRESCRIPTION
  VITAL_SIGN
  DOCUMENT
  DAILY_RECORD
  MEDICATION
  POP
  SYSTEM
  SCHEDULED_EVENT
}

enum NotificationSeverity {
  CRITICAL // Requer ação imediata (vermelho)
  WARNING // Requer atenção (amarelo/laranja)
  INFO // Informativo (azul)
  SUCCESS // Sucesso (verde)
}

// ──────────────────────────────────────────────────────────────────────────────
//  ENUMS - POPs (Procedimentos Operacionais Padrão)
// ──────────────────────────────────────────────────────────────────────────────

enum PopStatus {
  DRAFT // Rascunho (criado por RT ou sugestão de enfermeiro)
  PUBLISHED // Publicado e vigente
  OBSOLETE // Substituído ou descontinuado

  @@map("PopStatus")
}

enum PopCategory {
  GESTAO_OPERACAO // Gestão e Operação (8 templates)
  ENFERMAGEM_CUIDADOS // Enfermagem e Cuidados (20 templates)

  @@map("PopCategory")
}

enum PopAction {
  CREATED // POP criado
  UPDATED // Conteúdo atualizado
  PUBLISHED // Publicado (de DRAFT para PUBLISHED)
  VERSIONED // Nova versão criada
  OBSOLETED // Marcado como obsoleto
  DELETED // Soft delete

  @@map("PopAction")
}

model Notification {
  id       String  @id @default(uuid()) @db.Uuid
  tenantId String  @db.Uuid
  userId   String? @db.Uuid // null = broadcast para todos do tenant

  // Tipo e Categoria
  type     SystemNotificationType
  category NotificationCategory
  severity NotificationSeverity

  // Conteúdo
  title     String  @db.VarChar(255)
  message   String  @db.Text
  actionUrl String? @db.Text // URL para navegação ao clicar

  // Referência à entidade relacionada
  entityType String? @db.VarChar(50) // Ex: "PRESCRIPTION", "VITAL_SIGN"
  entityId   String? @db.Uuid

  // Metadata flexível para informações adicionais
  metadata Json? @db.JsonB

  // Status de leitura
  read   Boolean   @default(false)
  readAt DateTime? @db.Timestamptz(3)

  // Expiração automática
  expiresAt DateTime? @db.Timestamptz(3)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([tenantId, userId, read, createdAt(sort: Desc)])
  @@index([tenantId, category, read, createdAt(sort: Desc)])
  @@index([tenantId, severity, read, createdAt(sort: Desc)])
  @@index([type])
  @@index([category])
  @@index([severity])
  @@index([expiresAt])
  @@index([read])
  @@map("notifications")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MODELS - POPs (Procedimentos Operacionais Padrão)
// ──────────────────────────────────────────────────────────────────────────────

model Pop {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // Identificação
  title      String      @db.VarChar(255)
  category   PopCategory
  templateId String?     @db.VarChar(100) // ID do template (ex: "POP_HIGIENIZACAO_MAOS")

  // Conteúdo (HTML do Tiptap - headings, listas, tabelas)
  content String @db.Text

  // Status e Workflow
  status PopStatus @default(DRAFT)

  // Versionamento
  version      Int       @default(1)
  replacedById String?   @db.Uuid
  replacedAt   DateTime? @db.Timestamptz(3)

  // Revisão periódica
  reviewIntervalMonths Int?
  lastReviewedAt       DateTime? @db.Timestamptz(3)
  nextReviewDate       DateTime? @db.Timestamptz(3)
  requiresReview       Boolean   @default(false)

  // Observações
  notes String? @db.Text

  // Auditoria
  createdBy   String    @db.Uuid
  updatedBy   String?   @db.Uuid
  publishedBy String?   @db.Uuid
  publishedAt DateTime? @db.Timestamptz(3)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  // Relações
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replacedBy  Pop?            @relation("PopReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces    Pop[]           @relation("PopReplacement")
  attachments PopAttachment[]
  history     PopHistory[]

  // Índices
  @@index([tenantId, status])
  @@index([tenantId, category, status])
  @@index([tenantId, templateId])
  @@index([status])
  @@index([category])
  @@index([nextReviewDate])
  @@index([requiresReview])
  @@index([replacedById])
  @@index([deletedAt])
  @@map("pops")
}

model PopHistory {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  popId    String @db.Uuid

  // Ação e motivo
  action PopAction
  reason String?   @db.Text

  // Snapshots para auditoria
  previousData  Json?    @db.JsonB
  newData       Json?    @db.JsonB
  changedFields String[] @default([])

  // Auditoria
  changedBy     String   @db.Uuid
  changedByName String   @db.VarChar(255)
  changedAt     DateTime @default(now()) @db.Timestamptz(3)
  ipAddress     String?  @db.VarChar(45)
  userAgent     String?  @db.Text

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pop    Pop    @relation(fields: [popId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, popId, changedAt(sort: Desc)])
  @@index([popId, action])
  @@index([changedAt(sort: Desc)])
  @@index([action])
  @@map("pop_history")
}

model PopAttachment {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  popId    String @db.Uuid

  // Arquivo
  fileUrl  String  @db.Text
  fileKey  String? @db.Text
  fileName String  @db.VarChar(255)
  fileSize Int?
  mimeType String? @db.VarChar(100)

  // Metadados opcionais
  description String? @db.Text
  type        String? @db.VarChar(50) // FORMULARIO, CHECKLIST, FLUXOGRAMA, etc.

  // Auditoria
  uploadedBy String    @db.Uuid
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pop    Pop    @relation(fields: [popId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, popId])
  @@index([popId])
  @@index([deletedAt])
  @@map("pop_attachments")
}

// ──────────────────────────────────────────────────────────────────────────────
//  HISTÓRICO DE TRANSFERÊNCIAS DE LEITOS (Compliance RDC 502/2021)
// ──────────────────────────────────────────────────────────────────────────────
model BedTransferHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Leitos
  fromBedId String @db.Uuid
  toBedId   String @db.Uuid

  // Motivo da transferência
  reason String @db.Text // Obrigatório, min 10 chars

  // Data e hora da transferência
  transferredAt DateTime @default(now()) @db.Timestamptz(3)

  // Auditoria
  transferredBy String    @db.Uuid // ID do usuário que realizou a transferência
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  fromBed  Bed      @relation("BedTransferFrom", fields: [fromBedId], references: [id], onDelete: Restrict)
  toBed    Bed      @relation("BedTransferTo", fields: [toBedId], references: [id], onDelete: Restrict)
  user     User     @relation(fields: [transferredBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId, transferredAt(sort: Desc)])
  @@index([fromBedId])
  @@index([toBedId])
  @@index([deletedAt])
  @@map("bed_transfer_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MÓDULO SUPERADMIN - FATURAMENTO E MÉTRICAS
// ──────────────────────────────────────────────────────────────────────────────

// Enums para Faturamento
enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE

  @@map("InvoiceStatus")
}

enum PaymentGateway {
  ASAAS
  MANUAL

  @@map("PaymentGateway")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  PIX
  TRANSFER

  @@map("PaymentMethod")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED

  @@map("PaymentStatus")
}

enum AlertType {
  PAYMENT_FAILED
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_CANCELLED
  USAGE_LIMIT_EXCEEDED
  TENANT_SUSPENDED
  SYSTEM_ERROR

  @@map("AlertType")
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL

  @@map("AlertSeverity")
}

// Model: Invoice (Fatura)
model Invoice {
  id             String        @id @default(uuid()) @db.Uuid
  tenantId       String        @db.Uuid
  subscriptionId String        @db.Uuid
  invoiceNumber  String        @unique @db.VarChar(50) // INV-2024-0001
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("BRL") @db.VarChar(3)
  status         InvoiceStatus
  dueDate        DateTime      @db.Timestamptz(3)
  paidAt         DateTime?     @db.Timestamptz(3)
  asaasInvoiceId String?       @unique @db.VarChar(255)
  paymentUrl     String?       @db.Text
  createdAt      DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime      @updatedAt @db.Timestamptz(3)

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  payments     Payment[]

  // Índices
  @@index([tenantId, status])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([asaasInvoiceId])
  @@map("invoices")
}

// Model: Payment (Pagamento)
model Payment {
  id        String         @id @default(uuid()) @db.Uuid
  invoiceId String         @db.Uuid
  amount    Decimal        @db.Decimal(10, 2)
  currency  String         @default("BRL") @db.VarChar(3)
  gateway   PaymentGateway
  gatewayId String?        @db.VarChar(255) // ID externo (Asaas)
  method    PaymentMethod
  status    PaymentStatus
  paidAt    DateTime?      @db.Timestamptz(3)
  metadata  Json?          @db.JsonB
  createdAt DateTime       @default(now()) @db.Timestamptz(3)

  // Relações
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Índices
  @@index([invoiceId])
  @@index([status])
  @@index([gateway, gatewayId])
  @@map("payments")
}

// Model: UsageMetrics (Métricas Mensais de Uso)
model UsageMetrics {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  month           DateTime @db.Date // Primeiro dia do mês
  activeResidents Int      @default(0)
  activeUsers     Int      @default(0)
  dailyRecords    Int      @default(0)
  prescriptions   Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Constraint: Um registro por tenant por mês
  @@unique([tenantId, month])
  @@index([tenantId, month])
  @@map("usage_metrics")
}

// Model: WebhookEvent (Auditoria de Webhooks)
model WebhookEvent {
  id             String         @id @default(uuid()) @db.Uuid
  gateway        PaymentGateway
  eventType      String         @db.VarChar(100)
  gatewayEventId String?        @db.VarChar(255) // ID único do evento no gateway
  payload        Json           @db.JsonB
  processed      Boolean        @default(false)
  processedAt    DateTime?      @db.Timestamptz(3)
  error          String?        @db.Text
  createdAt      DateTime       @default(now()) @db.Timestamptz(3)

  // Índices
  @@index([gateway, gatewayEventId])
  @@index([processed])
  @@index([createdAt(sort: Desc)])
  @@map("webhook_events")
}

// Model: SystemAlert (Alertas para SuperAdmin)
model SystemAlert {
  id        String        @id @default(uuid()) @db.Uuid
  type      AlertType
  severity  AlertSeverity
  title     String        @db.VarChar(255)
  message   String        @db.Text
  metadata  Json?         @db.JsonB
  tenantId  String?       @db.Uuid
  read      Boolean       @default(false)
  readAt    DateTime?     @db.Timestamptz(3)
  createdAt DateTime      @default(now()) @db.Timestamptz(3)

  // Relações
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([type, severity])
  @@index([read])
  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  @@map("system_alerts")
}

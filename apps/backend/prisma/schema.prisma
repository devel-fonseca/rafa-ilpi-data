// ──────────────────────────────────────────────────────────────────────────────
//  Prisma Schema – Sistema Multi‑Tenant para Residências de Idosos
//  Data: 15/11/2025
//  Autor: @efonseca78 (BR)
// ──────────────────────────────────────────────────────────────────────────────

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ENUMS (usados em várias tabelas)
// ──────────────────────────────────────────────────────────────────────────────
enum PlanType {
  FREE
  BASICO
  PROFISSIONAL
  ENTERPRISE

  @@map("PlanType")
}

// ENUM: Tipos de Permissões do Sistema
enum PermissionType {
  // Residentes
  VIEW_RESIDENTS
  CREATE_RESIDENTS
  UPDATE_RESIDENTS
  DELETE_RESIDENTS

  // Registros Diários
  VIEW_DAILY_RECORDS
  CREATE_DAILY_RECORDS
  UPDATE_DAILY_RECORDS
  DELETE_DAILY_RECORDS

  // Prescrições
  VIEW_PRESCRIPTIONS
  CREATE_PRESCRIPTIONS
  UPDATE_PRESCRIPTIONS
  DELETE_PRESCRIPTIONS

  // Administração de Medicamentos
  VIEW_MEDICATIONS
  ADMINISTER_MEDICATIONS
  ADMINISTER_CONTROLLED_MEDICATIONS

  // Sinais Vitais
  VIEW_VITAL_SIGNS
  RECORD_VITAL_SIGNS

  // Vacinações
  VIEW_VACCINATIONS
  RECORD_VACCINATIONS

  // Evoluções Clínicas (SOAP)
  VIEW_CLINICAL_NOTES
  CREATE_CLINICAL_NOTES
  UPDATE_CLINICAL_NOTES
  DELETE_CLINICAL_NOTES

  // Perfis Clínicos
  VIEW_CLINICAL_PROFILE
  UPDATE_CLINICAL_PROFILE

  // Alergias
  VIEW_ALLERGIES
  CREATE_ALLERGIES
  UPDATE_ALLERGIES
  DELETE_ALLERGIES

  // Condições Crônicas
  VIEW_CONDITIONS
  CREATE_CONDITIONS
  UPDATE_CONDITIONS
  DELETE_CONDITIONS

  // Restrições Alimentares
  VIEW_DIETARY_RESTRICTIONS
  CREATE_DIETARY_RESTRICTIONS
  UPDATE_DIETARY_RESTRICTIONS
  DELETE_DIETARY_RESTRICTIONS

  // Gestão de Leitos
  VIEW_BEDS
  MANAGE_BEDS

  // Infraestrutura (Prédios, Andares, Quartos, Leitos)
  MANAGE_INFRASTRUCTURE

  // Documentos
  VIEW_DOCUMENTS
  UPLOAD_DOCUMENTS
  DELETE_DOCUMENTS

  // Usuários e Permissões
  VIEW_USERS
  CREATE_USERS
  UPDATE_USERS
  DELETE_USERS
  MANAGE_PERMISSIONS

  // Relatórios e Auditoria
  VIEW_REPORTS
  EXPORT_DATA
  VIEW_AUDIT_LOGS

  // Configurações Institucionais
  VIEW_INSTITUTIONAL_SETTINGS
  UPDATE_INSTITUTIONAL_SETTINGS

  // Perfil Institucional
  VIEW_INSTITUTIONAL_PROFILE
  UPDATE_INSTITUTIONAL_PROFILE

  @@map("PermissionType")
}

// ENUM: Cargos ILPI (baseado em funções reais de uma ILPI)
enum PositionCode {
  ADMINISTRATOR              // Administrador da ILPI
  TECHNICAL_MANAGER          // Responsável Técnico (nível superior)
  NURSING_COORDINATOR        // Coordenador de Enfermagem
  NURSE                      // Enfermeiro
  NURSING_TECHNICIAN         // Técnico de Enfermagem
  NURSING_ASSISTANT          // Auxiliar de Enfermagem
  DOCTOR                     // Médico
  PSYCHOLOGIST               // Psicólogo
  SOCIAL_WORKER              // Assistente Social
  PHYSIOTHERAPIST            // Fisioterapeuta
  NUTRITIONIST               // Nutricionista
  SPEECH_THERAPIST           // Fonoaudiólogo
  OCCUPATIONAL_THERAPIST     // Terapeuta Ocupacional
  CAREGIVER                  // Cuidador de Idosos
  ADMINISTRATIVE             // Administrativo
  ADMINISTRATIVE_ASSISTANT   // Assistente Administrativo
  OTHER                      // Outros

  @@map("PositionCode")
}

// ENUM: Tipo de Registro Profissional
enum RegistrationType {
  COREN  // Conselho Regional de Enfermagem
  CRM    // Conselho Regional de Medicina
  CRN    // Conselho Regional de Nutrição
  CREFITO // Conselho Regional de Fisioterapia e Terapia Ocupacional
  CRP    // Conselho Regional de Psicologia
  CREFONO // Conselho Regional de Fonoaudiologia
  CRESS  // Conselho Regional de Serviço Social
  NONE   // Sem registro (para cargos que não exigem)

  @@map("RegistrationType")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL

  @@map("TenantStatus")
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO

  @@map("Gender")
}

enum CivilStatus {
  SOLTEIRO
  CASADO
  DIVORCIADO
  VIUVO
  UNIAO_ESTAVEL

  @@map("CivilStatus")
}

enum BloodType {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
  NAO_INFORMADO

  @@map("BloodType")
}

enum RecordType {
  HIGIENE
  ALIMENTACAO
  HIDRATACAO
  MONITORAMENTO
  ELIMINACAO
  COMPORTAMENTO
  INTERCORRENCIA
  ATIVIDADES
  VISITA
  OUTROS

  @@map("RecordType")
}

enum PrescriptionType {
  ROTINA
  ALTERACAO_PONTUAL
  ANTIBIOTICO
  ALTO_RISCO
  CONTROLADO
  OUTRO

  @@map("PrescriptionType")
}

enum AdministrationRoute {
  VO
  IM
  EV
  SC
  TOPICA
  SL
  RETAL
  OCULAR
  NASAL
  INALATORIA
  OUTRA

  @@map("AdministrationRoute")
}

enum MedicationPresentation {
  COMPRIMIDO
  CAPSULA
  AMPOLA
  GOTAS
  SOLUCAO
  SUSPENSAO
  POMADA
  CREME
  SPRAY
  INALADOR
  ADESIVO
  SUPOSITORIO
  OUTRO

  @@map("MedicationPresentation")
}

enum NotificationType {
  AMARELA
  AZUL
  BRANCA_ESPECIAL
  NAO_APLICA

  @@map("NotificationType")
}

enum ControlledClass {
  BZD
  PSICOFARMACO
  OPIOIDE
  ANTICONVULSIVANTE
  OUTRO

  @@map("ControlledClass")
}

enum MedicationFrequency {
  UMA_VEZ_DIA
  DUAS_VEZES_DIA
  SEIS_SEIS_H
  OITO_OITO_H
  DOZE_DOZE_H
  PERSONALIZADO

  @@map("MedicationFrequency")
}

enum SOSIndicationType {
  DOR
  FEBRE
  ANSIEDADE
  AGITACAO
  NAUSEA
  INSONIA
  OUTRO

  @@map("SOSIndicationType")
}

// ENUM: Profissões para Evoluções Clínicas (SOAP)
enum ClinicalProfession {
  MEDICINE             // Médico
  NURSING              // Enfermagem
  NUTRITION            // Nutrição
  PHYSIOTHERAPY        // Fisioterapia
  PSYCHOLOGY           // Psicologia
  SOCIAL_WORK          // Serviço Social
  SPEECH_THERAPY       // Fonoaudiologia
  OCCUPATIONAL_THERAPY // Terapia Ocupacional

  @@map("ClinicalProfession")
}

enum AllergySeverity {
  LEVE
  MODERADA
  GRAVE
  ANAFILAXIA

  @@map("AllergySeverity")
}

enum RestrictionType {
  ALERGIA_ALIMENTAR
  INTOLERANCIA
  RESTRICAO_MEDICA
  RESTRICAO_RELIGIOSA
  DISFAGIA
  DIABETES
  HIPERTENSAO
  OUTRA

  @@map("RestrictionType")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PLANOS
// ──────────────────────────────────────────────────────────────────────────────
model Plan {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  displayName  String
  type         PlanType
  maxResidents Int
  maxUsers     Int
  price        Decimal? @db.Decimal(10, 2)
  trialDays    Int      @default(0)
  isPopular    Boolean  @default(false)
  features     Json     @default("{}")
  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime @updatedAt @db.Timestamptz(3)

  subscriptions Subscription[]

  @@map("plans")
}

// ──────────────────────────────────────────────────────────────────────────────
//  TENANTS (Clínicas / Residências)
// ──────────────────────────────────────────────────────────────────────────────
model Tenant {
  id         String       @id @default(uuid()) @db.Uuid
  name       String
  slug       String       @unique
  cnpj       String?      @unique
  email      String
  phone      String?
  status     TenantStatus @default(TRIAL)
  schemaName String       @unique

  // Endereço detalhado
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  deletedAt DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  subscriptions             Subscription[]
  users                     User[]
  userProfiles              UserProfile[]
  residents                 Resident[]
  dailyRecords              DailyRecord[]
  dailyRecordHistory        DailyRecordHistory[]
  vitalSigns                VitalSign[]
  prescriptions             Prescription[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  clinicalNotes             ClinicalNote[]
  clinicalNoteHistory       ClinicalNoteHistory[]
  clinicalProfiles          ClinicalProfile[]
  allergies                 Allergy[]
  conditions                Condition[]
  dietaryRestrictions       DietaryRestriction[]
  auditLogs                 AuditLog[]
  buildings                 Building[]
  floors                    Floor[]
  rooms                     Room[]
  beds                      Bed[]
  profile                   TenantProfile?
  documents                 TenantDocument[]
  residentDocuments         ResidentDocument[]
  notifications             Notification[]

  @@map("tenants")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SUBSCRIPTIONS (Stripe‑style)
// ──────────────────────────────────────────────────────────────────────────────
model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  planId             String    @db.Uuid
  startDate          DateTime  @default(now()) @db.Timestamptz(3)
  endDate            DateTime? @db.Timestamptz(3)
  currentPeriodStart DateTime? @db.Timestamptz(3)
  currentPeriodEnd   DateTime? @db.Timestamptz(3)
  trialEndDate       DateTime? @db.Timestamptz(3)
  status             String // trialing | active | past_due | canceled | unpaid | incomplete

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@map("subscriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USERS (por tenant)
// ──────────────────────────────────────────────────────────────────────────────
model User {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @db.Uuid
  name                  String
  email                 String
  password              String
  role                  String // admin | user | viewer (pode virar enum depois)
  isActive              Boolean   @default(true)
  lastLogin             DateTime? @db.Timestamptz(3)
  passwordResetRequired Boolean   @default(false)
  deletedAt             DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant                     Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile                    UserProfile?
  refreshTokens              RefreshToken[]
  dailyRecords               DailyRecord[]
  medicationAdministrations  MedicationAdministration[]
  sosAdministrations         SOSAdministration[]
  vaccinations               Vaccination[]
  vitalSigns                 VitalSign[]
  clinicalNotes              ClinicalNote[]
  clinicalNoteHistoryAuthor  ClinicalNoteHistory[]      @relation("ClinicalNoteHistoryProfessional")
  clinicalNoteHistoryChanges ClinicalNoteHistory[]      @relation("ClinicalNoteHistoryChangedBy")
  clinicalProfilesUpdated    ClinicalProfile[]
  allergiesRecorded          Allergy[]
  conditionsRecorded         Condition[]
  dietaryRestrictionsRecorded DietaryRestriction[]
  notifications              Notification[]

  @@unique([tenantId, email])
  @@map("users")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REFRESH TOKENS
// ──────────────────────────────────────────────────────────────────────────────
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ──────────────────────────────────────────────────────────────────────────────
//  USER PROFILES
// ──────────────────────────────────────────────────────────────────────────────
model UserProfile {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @unique @db.Uuid
  tenantId     String    @db.Uuid

  // Dados do Perfil
  profilePhoto String?   // URL ou path da foto de perfil
  phone        String?
  department   String?   // Departamento
  birthDate    DateTime? @db.Timestamptz(3)
  notes        String?   @db.Text
  preferences  Json?     @default("{}")  // Preferências do usuário (tema, sidebar, etc)

  // Sistema de Permissões ILPI
  positionCode       PositionCode?      // Cargo padronizado ILPI
  registrationType   RegistrationType?  // Tipo de registro profissional (COREN, CRM, etc)
  registrationNumber String?            // Número do registro no conselho
  registrationState  String?            // UF do registro (ex: "SP", "RJ")

  // Flags especiais
  isTechnicalManager    Boolean @default(false) // Se é Responsável Técnico da ILPI
  isNursingCoordinator  Boolean @default(false) // Se é Coordenador de Enfermagem

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid

  // Relações
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customPermissions UserPermission[] // Permissões customizadas/sobrepostas

  @@map("user_profiles")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERMISSÕES CUSTOMIZADAS DE USUÁRIO
//  Permite conceder ou revogar permissões específicas para usuários individuais
// ──────────────────────────────────────────────────────────────────────────────
model UserPermission {
  id             String         @id @default(uuid()) @db.Uuid
  userProfileId  String         @db.Uuid
  tenantId       String         @db.Uuid

  // Permissão específica
  permission     PermissionType

  // Tipo de customização
  isGranted      Boolean        @default(true) // true = concedida, false = revogada

  // Auditoria
  grantedBy      String         @db.Uuid // ID do usuário que concedeu/revogou
  grantedAt      DateTime       @default(now()) @db.Timestamptz(3)
  createdAt      DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime       @updatedAt @db.Timestamptz(3)

  // Relações
  userProfile    UserProfile    @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  // Índices
  @@unique([userProfileId, permission]) // Evita duplicatas de permissão por usuário
  @@index([tenantId, userProfileId])
  @@index([permission])
  @@map("user_permissions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  RESIDENTS – MODELO FINAL (conforme especificação)
// ──────────────────────────────────────────────────────────────────────────────
model Resident {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // 0 – Status
  status String @default("Ativo") // Ativo | Inativo | Falecido

  // 1 – Dados Pessoais
  fullName    String
  socialName  String?
  cpf         String
  rg          String?
  rgIssuer    String?
  education   String?
  profession  String?
  cns         String?
  gender      Gender
  civilStatus CivilStatus?
  religion    String?
  birthDate   DateTime     @db.Timestamptz(3)
  nationality String       @default("Brasileira")
  birthCity   String?
  birthState  String? // UF (2 letras)
  motherName  String?
  fatherName  String?
  fotoUrl     String? // URL da foto do residente no MinIO

  // 2 – Endereços
  // Atual
  currentCep        String?
  currentState      String?
  currentCity       String?
  currentStreet     String?
  currentNumber     String?
  currentComplement String?
  currentDistrict   String?
  currentPhone      String?

  // Procedência
  originCep        String?
  originState      String?
  originCity       String?
  originStreet     String?
  originNumber     String?
  originComplement String?
  originDistrict   String?
  originPhone      String?

  // 3 – Contatos de Emergência (array JSON)
  emergencyContacts Json @default("[]")
  // [{ "name": "...", "phone": "...", "relationship": "..." }]

  // 4 – Responsável Legal
  legalGuardianName       String?
  legalGuardianCpf        String?
  legalGuardianRg         String?
  legalGuardianPhone      String?
  legalGuardianType       String? // curador | procurador | responsável convencional
  legalGuardianCep        String?
  legalGuardianState      String?
  legalGuardianCity       String?
  legalGuardianStreet     String?
  legalGuardianNumber     String?
  legalGuardianComplement String?
  legalGuardianDistrict   String?

  // 5 – Admissão
  admissionDate       DateTime  @db.Timestamptz(3)
  admissionType       String? // Voluntária | Involuntária | Judicial | outro
  admissionReason     String?
  admissionConditions String?
  dischargeDate       DateTime? @db.Timestamptz(3)
  dischargeReason     String?

  // 6 – Saúde (Dados Estáveis - dados clínicos evolutivos migraram para clinical_profiles)
  bloodType              BloodType @default(NAO_INFORMADO)
  height                 Decimal?  @db.Decimal(5, 2) // metros
  weight                 Decimal?  @db.Decimal(5, 1) // kg
  dependencyLevel        String? // Grau I - Independente | Grau II - Semidependente | Grau III - Dependente
  mobilityAid            Boolean?
  medicationsOnAdmission String?

  // 7 – Convênios / Planos de Saúde
  healthPlans Json @default("[]")
  // [{ "name": "...", "cardNumber": "...", "cardUrl": "..." }]

  // 8 – Pertences
  belongings Json @default("[]")
  // ["Óculos", "Aparelho auditivo", ...]

  // 9 – Acomodação
  roomId String? @db.Uuid
  bedId  String? @unique @db.Uuid

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bed                       Bed?                       @relation(fields: [bedId], references: [id])
  dailyRecords              DailyRecord[]
  prescriptions             Prescription[]
  medicationAdministrations MedicationAdministration[]
  sosAdministrations        SOSAdministration[]
  vaccinations              Vaccination[]
  vitalSigns                VitalSign[]
  clinicalNotes             ClinicalNote[]
  clinicalNoteHistory       ClinicalNoteHistory[]
  residentDocuments         ResidentDocument[]
  clinicalProfile           ClinicalProfile?
  allergies                 Allergy[]
  conditions                Condition[]
  dietaryRestrictions       DietaryRestriction[]

  // Índices
  @@unique([tenantId, cpf])
  @@index([tenantId, status])
  @@index([tenantId, admissionDate(sort: Desc)])
  @@index([deletedAt])
  @@map("residents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERFIL CLÍNICO DO RESIDENTE
// ──────────────────────────────────────────────────────────────────────────────
model ClinicalProfile {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  residentId String   @unique @db.Uuid

  // Dados clínicos textuais
  healthStatus       String? @db.Text
  specialNeeds       String? @db.Text
  functionalAspects  String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  updatedBy String?   @db.Uuid

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  // Índices
  @@index([tenantId, residentId])
  @@index([deletedAt])
  @@map("clinical_profiles")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ALERGIAS
// ──────────────────────────────────────────────────────────────────────────────
model Allergy {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @db.Uuid
  residentId String    @db.Uuid

  // Dados da alergia
  substance String              // Medicamento, alimento, látex, etc.
  reaction  String?    @db.Text // Descrição da reação
  severity  AllergySeverity?

  // Observações
  notes String? @db.Text

  // Auditoria
  recordedBy String    @db.Uuid
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [recordedBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([substance])
  @@index([deletedAt])
  @@map("allergies")
}

// ──────────────────────────────────────────────────────────────────────────────
//  CONDIÇÕES CRÔNICAS / DIAGNÓSTICOS
// ──────────────────────────────────────────────────────────────────────────────
model Condition {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @db.Uuid
  residentId String    @db.Uuid

  // Dados do diagnóstico
  condition String              // Nome da condição
  icdCode   String?   @db.VarChar(10) // CID-10 (opcional)
  notes     String?   @db.Text // Observações clínicas

  // Auditoria
  recordedBy String    @db.Uuid
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [recordedBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([condition])
  @@index([deletedAt])
  @@map("conditions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  RESTRIÇÕES ALIMENTARES
// ──────────────────────────────────────────────────────────────────────────────
model DietaryRestriction {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @db.Uuid
  residentId String    @db.Uuid

  // Dados da restrição
  restrictionType RestrictionType
  description     String              // Ex: "Sem glúten", "Dieta hipossódica"
  notes           String?   @db.Text  // Observações do nutricionista

  // Auditoria
  recordedBy String    @db.Uuid
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [recordedBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId])
  @@index([restrictionType])
  @@index([deletedAt])
  @@map("dietary_restrictions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  DOCUMENTOS DE RESIDENTES
// ──────────────────────────────────────────────────────────────────────────────
model ResidentDocument {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  residentId  String    @db.Uuid

  // Tipo de documento
  type        String    @db.VarChar(100)
  // Tipos possíveis:
  // - CARTAO_CONVENIO
  // - COMPROVANTE_RESIDENCIA_RESIDENTE
  // - DOCUMENTOS_RESPONSAVEL_LEGAL
  // - COMPROVANTE_RESIDENCIA_RESPONSAVEL
  // - DOCUMENTOS_PESSOAIS
  // - LAUDO_MEDICO
  // - TERMO_ADMISSAO
  // - TERMO_CONSENTIMENTO_IMAGEM
  // - TERMO_CONSENTIMENTO_LGPD

  // Arquivo
  fileUrl     String    // URL completa do arquivo no S3/MinIO
  fileKey     String?   // Chave do arquivo no S3 para deleção
  fileName    String    // Nome original do arquivo
  fileSize    Int?      // Tamanho em bytes
  mimeType    String?   @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Detalhes opcionais (ex: "Unimed", "Laudo de entrada", etc.)
  details     String?   @db.Text

  // Auditoria
  uploadedBy  String    @db.Uuid // ID do usuário que fez upload
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  // Relações
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident    Resident  @relation(fields: [residentId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId, type])
  @@index([deletedAt])
  @@map("resident_documents")
}

// ──────────────────────────────────────────────────────────────────────────────
//  REGISTROS DIÁRIOS
// ──────────────────────────────────────────────────────────────────────────────
model DailyRecord {
  id         String     @id @default(uuid()) @db.Uuid
  tenantId   String     @db.Uuid
  residentId String     @db.Uuid

  // Tipo e metadados
  type RecordType
  date DateTime   @db.Timestamptz(3) // Data do registro (sem hora)
  time String // Hora no formato "HH:mm" (ex: "07:00", "14:30")

  // Dados estruturados (JSON) - cada tipo tem sua própria estrutura
  data Json @default("{}")

  // Responsável pelo registro
  recordedBy String // Nome do profissional
  userId     String @db.Uuid // ID do usuário que fez o registro

  // Observações gerais (opcional)
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para performance
  @@index([tenantId, residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc), time])
  @@index([deletedAt])
  @@map("daily_records")

  // Relação com histórico de versões
  history DailyRecordHistory[]
}

// Histórico de Versões de Registros Diários (para conformidade com prontuário eletrônico)
model DailyRecordHistory {
  id             String   @id @default(uuid()) @db.Uuid
  recordId       String   @db.Uuid // FK para DailyRecord
  tenantId       String   @db.Uuid
  versionNumber  Int // Número sequencial da versão (1, 2, 3...)

  // Dados da versão anterior (snapshot completo)
  previousData   Json // Snapshot completo do estado anterior

  // Dados da nova versão (para comparação)
  newData        Json // Snapshot completo do novo estado

  // Campos alterados (array de nomes de campos: ["time", "data.pressao"])
  changedFields  Json @default("[]")

  // Auditoria da mudança
  changeType     String // "UPDATE" ou "DELETE"
  changeReason   String @db.Text // Motivo obrigatório da mudança
  changedBy      String @db.Uuid // ID do usuário que fez a mudança
  changedByName  String // Nome do usuário que fez a mudança
  changedAt      DateTime @default(now()) @db.Timestamptz(3)

  // IP e User Agent para auditoria adicional
  ipAddress      String? @db.VarChar(45)
  userAgent      String? @db.Text

  // Relações
  record DailyRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([recordId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("daily_record_history")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SINAIS VITAIS (Tabela dedicada para análises e consultas otimizadas)
// ──────────────────────────────────────────────────────────────────────────────
model VitalSign {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  residentId String   @db.Uuid
  userId     String   @db.Uuid // ID do usuário que registrou

  // Timestamp do registro (data + hora completa)
  timestamp  DateTime @db.Timestamptz(3)

  // Sinais Vitais (todos opcionais - registra apenas os que foram aferidos)
  systolicBloodPressure   Float? // Pressão arterial sistólica (mmHg)
  diastolicBloodPressure  Float? // Pressão arterial diastólica (mmHg)
  temperature             Float? // Temperatura corporal (°C)
  heartRate               Int?   // Frequência cardíaca (bpm)
  oxygenSaturation        Float? // Saturação periférica de O₂ (%)
  bloodGlucose            Float? // Glicemia (mg/dL)

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para consultas otimizadas
  @@index([tenantId, residentId, timestamp(sort: Desc)])
  @@index([residentId, timestamp(sort: Desc)])
  @@index([tenantId, timestamp(sort: Desc)])
  @@index([deletedAt])
  @@map("vital_signs")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PRESCRIÇÕES MÉDICAS
// ──────────────────────────────────────────────────────────────────────────────
model Prescription {
  id         String           @id @default(uuid()) @db.Uuid
  tenantId   String           @db.Uuid
  residentId String           @db.Uuid

  // Dados do Prescritor
  doctorName       String
  doctorCrm        String
  doctorCrmState   String // UF
  prescriptionDate DateTime @db.Timestamptz(3)
  prescriptionType PrescriptionType
  validUntil       DateTime? @db.Timestamptz(3) // Obrigatório para ANTIBIOTICO e CONTROLADO
  reviewDate       DateTime? @db.Timestamptz(3) // Data estimada para revisão da prescrição

  // Campos específicos para CONTROLADO
  controlledClass    ControlledClass?
  notificationNumber String?
  notificationType   NotificationType?

  // Anexos
  prescriptionImageUrl String? // URL da receita médica (obrigatório para controlado)

  // Observações gerais
  notes String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  createdBy String    @db.Uuid // ID do usuário que criou

  // Relações
  tenant              Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident            Resident                   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  medications         Medication[]
  sosMedications      SOSMedication[]
  administrations     MedicationAdministration[]
  sosAdministrations  SOSAdministration[]

  // Índices
  @@index([tenantId, residentId])
  @@index([tenantId, isActive])
  @@index([tenantId, validUntil])
  @@index([deletedAt])
  @@map("prescriptions")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAMENTOS CONTÍNUOS
// ──────────────────────────────────────────────────────────────────────────────
model Medication {
  id             String                 @id @default(uuid()) @db.Uuid
  prescriptionId String                 @db.Uuid

  // Dados do medicamento
  name           String // DCB (Denominação Comum Brasileira)
  presentation   MedicationPresentation
  concentration  String // Ex: "500mg", "5mg/mL"
  dose           String // Ex: "1 cp", "20 gotas"
  route          AdministrationRoute
  frequency      MedicationFrequency
  scheduledTimes Json                   @default("[]") // Array de horários: ["06:00", "14:00", "22:00"]

  // Período
  startDate DateTime  @db.Timestamptz(3)
  endDate   DateTime? @db.Timestamptz(3) // null = uso contínuo

  // Flags especiais
  isControlled        Boolean @default(false)
  isHighRisk          Boolean @default(false)
  requiresDoubleCheck Boolean @default(false) // Exige dupla checagem

  // Observações
  instructions String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  prescription    Prescription               @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  administrations MedicationAdministration[]

  // Índices
  @@index([prescriptionId])
  @@index([isControlled])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@map("medications")
}

// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAÇÕES SOS (uso eventual)
// ──────────────────────────────────────────────────────────────────────────────
model SOSMedication {
  id             String                 @id @default(uuid()) @db.Uuid
  prescriptionId String                 @db.Uuid

  // Dados do medicamento
  name           String
  presentation   MedicationPresentation
  concentration  String
  dose           String
  route          AdministrationRoute

  // Indicação e limites
  indication        SOSIndicationType
  indicationDetails String? // Ex: "dor > 7", "febre > 38°C"
  minInterval       String // Ex: "6 horas", "4 horas"
  maxDailyDoses     Int // Limite diário (ex: 3)

  // Período de validade
  startDate DateTime  @db.Timestamptz(3)
  endDate   DateTime? @db.Timestamptz(3)

  // Observações
  instructions String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  prescription       Prescription        @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosAdministrations SOSAdministration[]

  // Índices
  @@index([prescriptionId])
  @@index([indication])
  @@index([deletedAt])
  @@map("sos_medications")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ADMINISTRAÇÃO DE MEDICAMENTOS CONTÍNUOS
// ──────────────────────────────────────────────────────────────────────────────
model MedicationAdministration {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  prescriptionId String   @db.Uuid
  medicationId   String   @db.Uuid
  residentId     String   @db.Uuid

  // Data/hora da administração
  date          DateTime @db.Timestamptz(3)
  scheduledTime String // Horário programado (ex: "06:00")
  actualTime    String? // Horário real de administração (se diferente)

  // Status
  wasAdministered Boolean @default(false)
  reason          String? // Motivo de não administração

  // Checagem
  administeredBy  String // Nome do profissional
  userId          String @db.Uuid
  checkedBy       String? // Para dupla checagem
  checkedByUserId String? @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication   Medication   @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([medicationId, date])
  @@index([wasAdministered])
  @@map("medication_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ADMINISTRAÇÃO DE MEDICAÇÕES SOS
// ──────────────────────────────────────────────────────────────────────────────
model SOSAdministration {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  prescriptionId  String   @db.Uuid
  sosMedicationId String   @db.Uuid
  residentId      String   @db.Uuid

  // Data/hora
  date DateTime @db.Timestamptz(3)
  time String // Horário da administração

  // Motivo
  indication String // Descrição do motivo (ex: "dor intensa no joelho")

  // Checagem
  administeredBy String
  userId         String @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription  Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  resident      Resident      @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([sosMedicationId, date])
  @@map("sos_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  VACINAÇÕES / IMUNIZAÇÕES (RDC 502/2021 - Art. 39)
// ──────────────────────────────────────────────────────────────────────────────
model Vaccination {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  residentId     String   @db.Uuid

  // 11 Campos obrigatórios (RDC 502/2021)
  vaccine        String                    // 1) Vacina/Profilaxia (ex: "COVID-19", "Influenza")
  dose           String                    // 3) Dose (ex: "1ª dose", "2ª dose", "Reforço")
  date           DateTime   @db.Timestamptz(3)       // 2) Data da vacinação
  batch          String                    // 4) Lote do imunizante
  manufacturer   String                    // 5) Fabricante
  cnes           String                    // 6) CNES (Código Nacional do Estabelecimento de Saúde)
  healthUnit     String                    // 7) Estabelecimento de Saúde
  municipality   String                    // 8) Município
  state          String                    // 9) UF (2 caracteres)
  certificateUrl String?                   // 10) URL do comprovante (file upload)
  notes          String?    @db.Text       // 11) Observações adicionais

  // Auditoria
  userId         String     @db.Uuid       // ID do usuário que registrou
  createdAt      DateTime   @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime   @updatedAt @db.Timestamptz(3)
  deletedAt      DateTime?  @db.Timestamptz(3) // Soft delete

  // Relações
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices para performance
  @@index([tenantId, residentId])
  @@index([residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([deletedAt])
  @@map("vaccinations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  EVOLUÇÕES CLÍNICAS MULTIPROFISSIONAIS (SOAP)
//  RDC 502/2021 - Art. 39 (Prontuário Eletrônico)
// ──────────────────────────────────────────────────────────────────────────────
model ClinicalNote {
  id             String             @id @default(uuid()) @db.Uuid
  tenantId       String             @db.Uuid
  residentId     String             @db.Uuid
  professionalId String             @db.Uuid

  // Profissão do autor
  profession     ClinicalProfession

  // Data/hora da evolução
  noteDate       DateTime           @default(now()) @db.Timestamptz(3)

  // Método SOAP
  subjective     String?            @db.Text  // S - Subjetivo
  objective      String?            @db.Text  // O - Objetivo
  assessment     String?            @db.Text  // A - Avaliação
  plan           String?            @db.Text  // P - Plano

  // Tags para filtros e dashboards
  tags           String[]           @default([])

  // Auditoria
  createdAt      DateTime           @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime           @updatedAt @db.Timestamptz(3)
  createdBy      String             @db.Uuid
  updatedBy      String?            @db.Uuid

  // Versionamento
  version        Int                @default(1)
  isAmended      Boolean            @default(false)  // Marcado como obsoleto

  // Janela de edição (12 horas)
  editableUntil  DateTime           @db.Timestamptz(3)  // noteDate + 12h

  // Relações
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional   User               @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  history        ClinicalNoteHistory[]

  // Índices
  @@index([tenantId, residentId, noteDate(sort: Desc)])
  @@index([tenantId, professionalId])
  @@index([profession])
  @@index([noteDate])
  @@index([tags])
  @@index([isAmended])
  @@map("clinical_notes")
}

// Histórico de Versões de Evoluções Clínicas (audit trail completo)
model ClinicalNoteHistory {
  id             String             @id @default(uuid()) @db.Uuid
  noteId         String             @db.Uuid
  version        Int

  // Snapshot completo
  tenantId       String             @db.Uuid
  residentId     String             @db.Uuid
  professionalId String             @db.Uuid
  profession     ClinicalProfession
  noteDate       DateTime           @db.Timestamptz(3)
  subjective     String?            @db.Text
  objective      String?            @db.Text
  assessment     String?            @db.Text
  plan           String?            @db.Text
  tags           String[]           @default([])

  // Auditoria de alteração
  changeReason   String             @db.Text  // Motivo obrigatório (minLength 10)
  changedAt      DateTime           @default(now()) @db.Timestamptz(3)
  changedBy      String             @db.Uuid

  // Relações
  note           ClinicalNote       @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional   User               @relation("ClinicalNoteHistoryProfessional", fields: [professionalId], references: [id], onDelete: Restrict)
  changedByUser  User               @relation("ClinicalNoteHistoryChangedBy", fields: [changedBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([noteId, version])
  @@index([tenantId, residentId])
  @@index([changedAt])
  @@map("clinical_notes_history")
}

// ==========================================
// AUDITORIA
// ==========================================

model AuditLog {
  id         Int      @id @default(autoincrement())
  tenantId   String   @map("tenant_id") @db.Uuid
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.VarChar(255)
  action     String   @db.VarChar(50)
  userId     String   @map("user_id") @db.VarChar(255)
  userName   String   @map("user_name") @db.VarChar(255)
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([entityType])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ──────────────────────────────────────────────────────────────────────────────
//  GESTÃO DE LEITOS (MAPA DE OCUPAÇÃO)
//  Estrutura: Building → Floor → Room → Bed
// ──────────────────────────────────────────────────────────────────────────────

// NÍVEL 1: PRÉDIOS / BLOCOS / CASAS
model Building {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  name        String    // "Casa Principal", "Bloco A"
  code        String    // "PRED-001", "BLOCO-A"
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floors Floor[]

  @@index([tenantId, isActive])
  @@map("buildings")
}

// NÍVEL 2: ANDARES / SETORES / ALAS / PAVILHÕES
model Floor {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  buildingId  String    @db.Uuid
  name        String    // "Térreo", "1º Andar", "Ala Feminina"
  code        String    // "PISO-0", "PISO-1"
  orderIndex  Int       @default(0) // Ordenação visual (crescente)
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime? @db.Timestamptz(3)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@index([tenantId, buildingId])
  @@index([buildingId, orderIndex])
  @@index([deletedAt])
  @@map("floors")
}

// NÍVEL 3: QUARTOS / ENFERMARIAS / SUÍTES
model Room {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @db.Uuid
  floorId               String    @db.Uuid
  name                  String    // "101", "Quarto 3"
  code                  String    // "Q-101", "Q-102"
  roomNumber            String    // "101", "102"
  capacity              Int       @default(1) // Número total de leitos (calculado automaticamente)
  roomType              String?   // "Coletivo", "Suíte", "Enfermaria", "Individual", "Duplo", "Triplo"
  genderRestriction     String?   // null, "M", "F"
  hasBathroom           Boolean   @default(false) // Se o quarto tem banheiro
  hasPrivateBathroom    Boolean   @default(false) // Se tem banheiro privativo
  accessible            Boolean   @default(false) // Se é acessível para PCD
  observations          String?   @db.Text // Observações adicionais
  notes                 String?   @db.Text
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt             DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt             DateTime? @db.Timestamptz(3)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floor  Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds   Bed[]

  @@index([tenantId, floorId])
  @@index([floorId, isActive])
  @@index([deletedAt])
  @@map("rooms")
}

// NÍVEL 4: LEITOS (conecta com Residents)
model Bed {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @db.Uuid
  roomId    String    @db.Uuid
  code      String    // "101-A", "101-B", "Leito 1"
  status    String    @default("Disponível") // "Disponível", "Ocupado", "Manutenção" (calculado dinamicamente)
  notes     String?   @db.Text
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room     Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  resident Resident?

  @@unique([tenantId, code]) // Código do leito único por tenant
  @@index([tenantId, roomId])
  @@index([roomId, status])
  @@index([tenantId, status])
  @@index([deletedAt])
  @@map("beds")
}

// ──────────────────────────────────────────────────────────────────────────────
//  PERFIL INSTITUCIONAL
//  Informações regulatórias, documentação e compliance da ILPI
// ──────────────────────────────────────────────────────────────────────────────

// ENUM: Natureza Jurídica da Instituição
enum LegalNature {
  ASSOCIACAO      // Associação sem fins lucrativos
  FUNDACAO        // Fundação privada
  EMPRESA_PRIVADA // Empresa privada
  MEI             // Microempreendedor Individual

  @@map("LegalNature")
}

// PERFIL INSTITUCIONAL (1:1 com Tenant)
model TenantProfile {
  id                  String       @id @default(uuid()) @db.Uuid
  tenantId            String       @unique @db.Uuid

  // Logo e identidade visual
  logoUrl             String?      // URL do logo no S3/MinIO
  logoKey             String?      // Chave do arquivo no S3 para deleção

  // Natureza jurídica e dados básicos
  legalNature         LegalNature?
  tradeName           String?      // Nome fantasia

  // Dados regulatórios
  cnesCode            String?      @db.VarChar(20)  // Código CNES (Cadastro Nacional de Estabelecimentos de Saúde)
  capacityDeclared    Int?         // Capacidade declarada de residentes
  capacityLicensed    Int?         // Capacidade licenciada pela vigilância sanitária

  // Contatos institucionais
  contactPhone        String?
  contactEmail        String?
  websiteUrl          String?

  // Informações complementares
  foundedAt           DateTime?    @db.Timestamptz(3)         // Data de fundação
  mission             String?      @db.Text         // Missão institucional
  vision              String?      @db.Text         // Visão institucional
  values              String?      @db.Text         // Valores institucionais

  // Observações
  notes               String?      @db.Text

  // Auditoria
  createdAt           DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt           DateTime     @updatedAt @db.Timestamptz(3)
  deletedAt           DateTime?    @db.Timestamptz(3)

  // Relações
  tenant              Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId])
  @@index([legalNature])
  @@index([deletedAt])
  @@map("tenant_profiles")
}

// ENUM: Status de compliance do documento
enum DocumentStatus {
  OK         // Documento OK (sem vencimento ou com vencimento > 30 dias)
  PENDENTE   // Documento obrigatório não enviado
  VENCENDO   // Vence em <= 30 dias
  VENCIDO    // Vencimento ultrapassado

  @@map("DocumentStatus")
}

// DOCUMENTOS INSTITUCIONAIS
model TenantDocument {
  id          String          @id @default(uuid()) @db.Uuid
  tenantId    String          @db.Uuid

  // Tipo de documento (baseado na natureza jurídica)
  type        String          @db.VarChar(100) // ESTATUTO, CMI, CNPJ, ALVARA_USO, etc.

  // Arquivo
  fileUrl     String          // URL completa do arquivo no S3/MinIO
  fileKey     String?         // Chave do arquivo no S3 para deleção
  fileName    String          // Nome original do arquivo
  fileSize    Int?            // Tamanho em bytes
  mimeType    String?         @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Metadados do documento
  issuedAt    DateTime?       @db.Timestamptz(3)         // Data de emissão
  expiresAt   DateTime?       @db.Timestamptz(3)         // Data de vencimento (se aplicável)
  status      DocumentStatus  @default(PENDENTE) // Calculado automaticamente

  // Observações
  notes       String?         @db.Text

  // Auditoria
  uploadedBy  String          @db.Uuid         // ID do usuário que fez upload
  createdAt   DateTime        @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime        @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime?       @db.Timestamptz(3)

  // Relações
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, expiresAt])
  @@index([expiresAt])
  @@index([status])
  @@index([deletedAt])
  @@map("tenant_documents")
}

// ============================================
// NOTIFICATIONS SYSTEM
// ============================================

enum SystemNotificationType {
  // Prescrições
  PRESCRIPTION_EXPIRED
  PRESCRIPTION_EXPIRING
  PRESCRIPTION_MISSING_RECEIPT
  PRESCRIPTION_CONTROLLED_NO_RECEIPT

  // Sinais Vitais
  VITAL_SIGN_ABNORMAL_BP
  VITAL_SIGN_ABNORMAL_GLUCOSE
  VITAL_SIGN_ABNORMAL_TEMPERATURE
  VITAL_SIGN_ABNORMAL_HEART_RATE
  VITAL_SIGN_ABNORMAL_RESPIRATORY_RATE

  // Documentos
  DOCUMENT_EXPIRED
  DOCUMENT_EXPIRING

  // Registro Diário
  DAILY_RECORD_MISSING

  // Medicação
  MEDICATION_ADMINISTRATION_MISSED
  MEDICATION_ADMINISTRATION_LATE

  // Sistema
  SYSTEM_UPDATE
  SYSTEM_MAINTENANCE
  USER_MENTION
}

enum NotificationCategory {
  PRESCRIPTION
  VITAL_SIGN
  DOCUMENT
  DAILY_RECORD
  MEDICATION
  SYSTEM
}

enum NotificationSeverity {
  CRITICAL  // Requer ação imediata (vermelho)
  WARNING   // Requer atenção (amarelo/laranja)
  INFO      // Informativo (azul)
  SUCCESS   // Sucesso (verde)
}

model Notification {
  id          String                    @id @default(uuid()) @db.Uuid
  tenantId    String                    @db.Uuid
  userId      String?                   @db.Uuid // null = broadcast para todos do tenant

  // Tipo e Categoria
  type        SystemNotificationType
  category    NotificationCategory
  severity    NotificationSeverity

  // Conteúdo
  title       String               @db.VarChar(255)
  message     String               @db.Text
  actionUrl   String?              @db.Text // URL para navegação ao clicar

  // Referência à entidade relacionada
  entityType  String?              @db.VarChar(50) // Ex: "PRESCRIPTION", "VITAL_SIGN"
  entityId    String?              @db.Uuid

  // Metadata flexível para informações adicionais
  metadata    Json?                @db.JsonB

  // Status de leitura
  read        Boolean              @default(false)
  readAt      DateTime?            @db.Timestamptz(3)

  // Expiração automática
  expiresAt   DateTime?            @db.Timestamptz(3)

  // Auditoria
  createdAt   DateTime             @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime             @updatedAt @db.Timestamptz(3)

  // Relações
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([tenantId, userId, read, createdAt(sort: Desc)])
  @@index([tenantId, category, read, createdAt(sort: Desc)])
  @@index([tenantId, severity, read, createdAt(sort: Desc)])
  @@index([type])
  @@index([category])
  @@index([severity])
  @@index([expiresAt])
  @@index([read])
  @@map("notifications")
}

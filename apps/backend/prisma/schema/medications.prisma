// ──────────────────────────────────────────────────────────────────────────────
//  MEDICAÇÕES E PRESCRIÇÕES
//
//  Prescrições, medicamentos regulares, SOS e administração
// ──────────────────────────────────────────────────────────────────────────────

model Prescription {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Dados do Prescritor
  doctorName       String
  doctorCrm        String
  doctorCrmState   String // UF
  prescriptionDate DateTime         @db.Date
  prescriptionType PrescriptionType
  validUntil       DateTime?        @db.Date // Obrigatório para ANTIBIOTICO e CONTROLADO
  reviewDate       DateTime?        @db.Date // Data estimada para revisão da prescrição

  // Campos específicos para CONTROLADO
  controlledClass    ControlledClass?
  notificationNumber String?
  notificationType   NotificationType?

  // ──────────────────────────────────────────────────────────────────────────────
  // ARQUIVO ORIGINAL (backup para auditoria)
  // ──────────────────────────────────────────────────────────────────────────────
  originalFileUrl      String? @db.Text
  originalFileKey      String? @db.Text
  originalFileName     String? @db.Text
  originalFileSize     Int?
  originalFileMimeType String? @db.VarChar(100)
  originalFileHash     String? @db.VarChar(64) // SHA-256

  // ──────────────────────────────────────────────────────────────────────────────
  // ARQUIVO PROCESSADO (PDF com carimbo institucional)
  // ──────────────────────────────────────────────────────────────────────────────
  processedFileUrl  String? @db.Text
  processedFileKey  String? @db.Text
  processedFileName String? @db.Text
  processedFileSize Int?
  processedFileHash String? @db.VarChar(64) // SHA-256

  // ──────────────────────────────────────────────────────────────────────────────
  // TOKEN PÚBLICO PARA VALIDAÇÃO
  // ──────────────────────────────────────────────────────────────────────────────
  publicToken String? @unique @db.VarChar(64) // UUID para validação externa

  // ──────────────────────────────────────────────────────────────────────────────
  // METADADOS DO PROCESSAMENTO
  // ──────────────────────────────────────────────────────────────────────────────
  processingMetadata Json? @db.JsonB // Dados do carimbo institucional

  // Observações gerais
  notes String? @db.Text

  // Revisão Médica (quando prescrição é revisada por médico)
  lastMedicalReviewDate DateTime? @db.Date // Data da consulta médica
  lastReviewedByDoctor  String? // Nome do médico que revisou
  lastReviewDoctorCrm   String? // CRM do médico revisor
  lastReviewDoctorState String? // UF do CRM do médico revisor
  lastReviewNotes       String?   @db.Text // Observações da revisão

  // Status
  isActive Boolean @default(true)

  // Auditoria e Versionamento
  versionNumber Int       @default(1) // Número da versão atual (incrementado a cada UPDATE)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)
  createdBy     String    @db.Uuid // ID do usuário que criou
  updatedBy     String?   @db.Uuid // ID do último usuário que alterou

  // Relações
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident           Resident                   @relation(fields: [residentId], references: [id], onDelete: Cascade)
  medications        Medication[]
  sosMedications     SOSMedication[]
  administrations    MedicationAdministration[]
  sosAdministrations SOSAdministration[]
  history            PrescriptionHistory[] // Histórico de versões da prescrição

  // Índices
  @@index([tenantId, residentId])
  @@index([tenantId, isActive])
  @@index([tenantId, validUntil])
  @@index([tenantId, lastMedicalReviewDate])
  @@index([deletedAt])
  // Índices compostos para queries frequentes
  @@index([tenantId, residentId, isActive]) // Listar prescrições ativas do residente
  @@index([tenantId, isActive, validUntil]) // Prescrições ativas próximas do vencimento
  @@index([isActive, deletedAt]) // Relatórios e dashboards por status
  @@map("prescriptions")
}

model PrescriptionHistory {
  id             String     @id @default(uuid()) @db.Uuid
  tenantId       String     @db.Uuid
  prescriptionId String     @db.Uuid
  versionNumber  Int // Número da versão (1, 2, 3, ...)
  changeType     ChangeType // CREATE | UPDATE | DELETE
  changeReason   String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["doctorName", "validUntil", "medications.0.dose"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  user         User         @relation("PrescriptionHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, prescriptionId, versionNumber(sort: Desc)]) // Buscar histórico de uma prescrição
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("prescription_history")
}

model Medication {
  id             String @id @default(uuid()) @db.Uuid
  prescriptionId String @db.Uuid

  // Dados do medicamento
  name           String // DCB (Denominação Comum Brasileira)
  presentation   MedicationPresentation
  concentration  String // Ex: "500mg", "5mg/mL"
  dose           String // Ex: "1 cp", "20 gotas"
  route          AdministrationRoute
  frequency      MedicationFrequency
  scheduledTimes Json                   @default("[]") // Array de horários: ["06:00", "14:00", "22:00"]

  // Período
  startDate DateTime  @db.Date
  endDate   DateTime? @db.Date // null = uso contínuo

  // Flags especiais
  isControlled        Boolean @default(false)
  isHighRisk          Boolean @default(false)
  requiresDoubleCheck Boolean @default(false) // Exige dupla checagem

  // Observações
  instructions String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  prescription    Prescription               @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  administrations MedicationAdministration[]
  history         MedicationHistory[]
  createdByUser   User                       @relation("MedicationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?                      @relation("MedicationUpdatedBy", fields: [updatedBy], references: [id])
  medicationLocks MedicationLock[]

  // Índices
  @@index([prescriptionId])
  @@index([isControlled])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  // Índices compostos para queries frequentes
  @@index([prescriptionId, deletedAt]) // Medicamentos ativos de uma prescrição
  @@index([prescriptionId, startDate, endDate]) // Medicamentos vigentes de uma prescrição
  @@index([deletedAt, startDate, endDate]) // Relatórios por período sem filtro tenantId
  @@map("medications")
}

model MedicationHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  medicationId  String     @db.Uuid
  versionNumber Int // Número da versão (1, 2, 3, ...)
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["name", "dose", "frequency"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  user       User       @relation("MedicationHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, medicationId, versionNumber(sort: Desc)]) // Buscar histórico de um medicamento
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("medication_history")
}

model SOSMedication {
  id             String @id @default(uuid()) @db.Uuid
  prescriptionId String @db.Uuid

  // Dados do medicamento
  name          String
  presentation  MedicationPresentation
  concentration String
  dose          String
  route         AdministrationRoute

  // Indicação e limites
  indication        SOSIndicationType
  indicationDetails String? // Ex: "dor > 7", "febre > 38°C"
  minInterval       String // Ex: "6 horas", "4 horas"
  maxDailyDoses     Int // Limite diário (ex: 3)

  // Período de validade
  startDate DateTime  @db.Date
  endDate   DateTime? @db.Date

  // Observações
  instructions String? @db.Text

  // Auditoria e Versionamento
  versionNumber Int       @default(1)
  createdBy     String    @db.Uuid
  updatedBy     String?   @db.Uuid
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime? @db.Timestamptz(3)

  // Relações
  prescription       Prescription           @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosAdministrations SOSAdministration[]
  history            SOSMedicationHistory[]
  createdByUser      User                   @relation("SOSMedicationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?                  @relation("SOSMedicationUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([prescriptionId])
  @@index([indication])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@map("sos_medications")
}

model SOSMedicationHistory {
  id              String     @id @default(uuid()) @db.Uuid
  tenantId        String     @db.Uuid
  sosMedicationId String     @db.Uuid
  versionNumber   Int // Número da versão (1, 2, 3, ...)
  changeType      ChangeType // CREATE | UPDATE | DELETE
  changeReason    String     @db.Text // Motivo obrigatório da alteração

  // Snapshots dos dados (JSON)
  previousData Json? // Estado anterior (null em CREATE)
  newData      Json // Estado atual após a alteração

  // Campos alterados (array de strings)
  changedFields String[] @default([]) // Ex: ["name", "dose", "indication"]

  // Auditoria detalhada
  changedAt     DateTime @db.Timestamptz(3) // Timestamp da alteração
  changedBy     String   @db.Uuid // ID do usuário que fez a alteração
  changedByName String? // Nome do usuário (desnormalizado para performance)
  ipAddress     String? // IP de onde veio a requisição
  userAgent     String? // Browser/device usado

  // Metadados adicionais (JSON flexível)
  metadata Json? @db.JsonB // Dados extras: sessionId, requestId, etc.

  // Relações
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  user          User          @relation("SOSMedicationHistoryUser", fields: [changedBy], references: [id])

  // Índices para performance
  @@index([tenantId, sosMedicationId, versionNumber(sort: Desc)]) // Buscar histórico de um medicamento SOS
  @@index([tenantId, changedAt(sort: Desc)]) // Buscar alterações recentes do tenant
  @@index([changedBy]) // Buscar alterações por usuário
  @@index([changeType]) // Filtrar por tipo de alteração
  @@map("sos_medication_history")
}

model MedicationAdministration {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  prescriptionId String @db.Uuid
  medicationId   String @db.Uuid
  residentId     String @db.Uuid

  // Data/hora da administração
  date          DateTime @db.Date
  scheduledTime String // Horário programado (ex: "06:00")
  actualTime    String? // Horário real de administração (se diferente)

  // Status
  wasAdministered Boolean @default(false)
  reason          String? // Motivo de não administração

  // Checagem
  administeredBy  String // Nome do profissional
  userId          String  @db.Uuid
  checkedBy       String? // Para dupla checagem
  checkedByUserId String? @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication   Medication   @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([medicationId, date])
  @@index([wasAdministered])
  // Índices compostos para queries frequentes
  @@index([tenantId, date, wasAdministered]) // Administrações pendentes do dia
  @@index([residentId, date, wasAdministered]) // Administrações pendentes do residente
  @@index([date, scheduledTime]) // Relatórios por dia com ordenação por horário
  @@map("medication_administrations")
}

model SOSAdministration {
  id              String @id @default(uuid()) @db.Uuid
  tenantId        String @db.Uuid
  prescriptionId  String @db.Uuid
  sosMedicationId String @db.Uuid
  residentId      String @db.Uuid

  // Data/hora
  date DateTime @db.Date
  time String // Horário da administração

  // Motivo
  indication String // Descrição do motivo (ex: "dor intensa no joelho")

  // Checagem
  administeredBy String
  userId         String @db.Uuid

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescription  Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  sosMedication SOSMedication @relation(fields: [sosMedicationId], references: [id], onDelete: Cascade)
  resident      Resident      @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Índices
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc)])
  @@index([sosMedicationId, date])
  @@map("sos_administrations")
}

// ──────────────────────────────────────────────────────────────────────────────
//  LOCKS DE MEDICAMENTOS (WebSocket Real-Time)
//
//  Evita administração simultânea do mesmo medicamento por múltiplos usuários
// ──────────────────────────────────────────────────────────────────────────────

model MedicationLock {
  id           String @id @default(uuid()) @db.Uuid
  tenantId     String @db.Uuid // Stored for reference, no FK (cross-schema)
  medicationId String @db.Uuid

  // Data/horário do agendamento (não da administração real)
  scheduledDate DateTime @db.Date
  scheduledTime String // Ex: "06:00", "14:00", "22:00"

  // Informações do lock
  lockedByUserId   String   @db.Uuid
  lockedByUserName String
  lockedAt         DateTime @default(now()) @db.Timestamptz(3)
  expiresAt        DateTime @db.Timestamptz(3) // Auto-expira após 5 minutos

  // Metadados
  sessionId String? // ID da sessão do browser
  ipAddress String? // IPv4 ou IPv6

  // Relações (sem FK para Tenant - cross-schema)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  user       User       @relation("UserMedicationLocks", fields: [lockedByUserId], references: [id], onDelete: Cascade)

  // Índices
  @@unique([medicationId, scheduledDate, scheduledTime]) // Apenas 1 lock por medicamento+data+horário
  @@index([medicationId])
  @@index([lockedByUserId])
  @@index([expiresAt])
  @@index([medicationId, scheduledDate, scheduledTime]) // Query de locks ativos
  @@map("medication_locks")
}

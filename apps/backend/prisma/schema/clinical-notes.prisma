// ──────────────────────────────────────────────────────────────────────────────
//  EVOLUÇÕES CLÍNICAS (SOAP)
//
//  Notas clínicas multidisciplinares e documentos anexados
// ──────────────────────────────────────────────────────────────────────────────

model ClinicalNote {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  residentId     String @db.Uuid
  professionalId String @db.Uuid

  // Profissão do autor
  profession ClinicalProfession

  // Data/hora da evolução
  noteDate DateTime @default(now()) @db.Timestamptz(3)

  // Método SOAP
  subjective String? @db.Text // S - Subjetivo
  objective  String? @db.Text // O - Objetivo
  assessment String? @db.Text // A - Avaliação
  plan       String? @db.Text // P - Plano

  // Tags para filtros e dashboards
  tags String[] @default([])

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  // Versionamento
  version   Int     @default(1)
  isAmended Boolean @default(false) // Marcado como obsoleto

  // Janela de edição (12 horas)
  editableUntil DateTime @db.Timestamptz(3) // noteDate + 12h

  // Vínculo com alerta de sinal vital (opcional)
  vitalSignAlertId String? @db.Uuid

  // Relações
  tenant         Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident               @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional   User                   @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  vitalSignAlert VitalSignAlert?        @relation(fields: [vitalSignAlertId], references: [id])
  history        ClinicalNoteHistory[]
  documents      ClinicalNoteDocument[]

  // Índices
  @@index([tenantId, residentId, noteDate(sort: Desc)])
  @@index([tenantId, professionalId])
  @@index([profession])
  @@index([noteDate])
  @@index([tags])
  @@index([isAmended])
  @@index([vitalSignAlertId])
  @@map("clinical_notes")
}

model ClinicalNoteHistory {
  id      String @id @default(uuid()) @db.Uuid
  noteId  String @db.Uuid
  version Int

  // Snapshot completo
  tenantId       String             @db.Uuid
  residentId     String             @db.Uuid
  professionalId String             @db.Uuid
  profession     ClinicalProfession
  noteDate       DateTime           @db.Timestamptz(3)
  subjective     String?            @db.Text
  objective      String?            @db.Text
  assessment     String?            @db.Text
  plan           String?            @db.Text
  tags           String[]           @default([])

  // Auditoria de alteração
  changeReason String   @db.Text // Motivo obrigatório (minLength 10)
  changedAt    DateTime @default(now()) @db.Timestamptz(3)
  changedBy    String   @db.Uuid

  // Relações
  note          ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  professional  User         @relation("ClinicalNoteHistoryProfessional", fields: [professionalId], references: [id], onDelete: Restrict)
  changedByUser User         @relation("ClinicalNoteHistoryChangedBy", fields: [changedBy], references: [id], onDelete: Restrict)

  // Índices
  @@index([noteId, version])
  @@index([tenantId, residentId])
  @@index([changedAt])
  @@map("clinical_notes_history")
}

model ClinicalNoteDocument {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  noteId     String @db.Uuid
  residentId String @db.Uuid

  title        String   @db.VarChar(255)
  type         String?  @db.VarChar(100)
  documentDate DateTime @db.Timestamptz(3)

  // Conteúdo HTML (para futura edição)
  htmlContent String @db.Text

  // PDF no MinIO
  pdfFileUrl  String?
  pdfFileKey  String?
  pdfFileName String? @db.VarChar(255)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  createdBy String   @db.Uuid

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clinicalNote ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  resident     Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  creator      User         @relation("ClinicalNoteDocumentCreator", fields: [createdBy], references: [id])

  @@index([tenantId, residentId])
  @@index([noteId])
  @@map("clinical_note_documents")
}

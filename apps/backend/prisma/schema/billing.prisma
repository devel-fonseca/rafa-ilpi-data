// ──────────────────────────────────────────────────────────────────────────────
//  FATURAMENTO E PAGAMENTOS
//
//  Faturas, Pagamentos, Métricas de Uso e Webhooks (SuperAdmin)
// ──────────────────────────────────────────────────────────────────────────────

model Invoice {
  id              String        @id @default(uuid()) @db.Uuid
  tenantId        String        @db.Uuid
  subscriptionId  String        @db.Uuid
  invoiceNumber   String        @unique @db.VarChar(50) // INV-2024-0001
  amount          Decimal       @db.Decimal(10, 2)
  originalAmount  Decimal?      @map("original_amount") @db.Decimal(10, 2) // Valor antes do desconto
  discountPercent Decimal?      @map("discount_percent") @db.Decimal(5, 2) // Desconto aplicado (0-100%)
  discountReason  String?       @map("discount_reason") @db.VarChar(255) // Motivo do desconto
  billingCycle    String?       @map("billing_cycle") @db.VarChar(20) // MONTHLY | ANNUAL
  description     String?       @db.Text // Descrição da fatura
  currency        String        @default("BRL") @db.VarChar(3)
  status           InvoiceStatus
  dueDate          DateTime      @db.Date
  paidAt           DateTime?     @db.Timestamptz(3)
  asaasInvoiceId   String?       @unique @db.VarChar(255)
  asaasInvoiceUrl  String?       @db.Text @map("asaas_invoice_url") // URL para visualizar fatura no Asaas
  asaasBankSlipUrl String?       @db.Text @map("asaas_bank_slip_url") // URL do boleto PDF
  asaasPixQrCodeId String?       @db.Text @map("asaas_pix_qr_code_id") // ID do QR Code PIX no Asaas
  asaasPixPayload  String?       @db.Text @map("asaas_pix_payload") // Código PIX copia-e-cola
  paymentUrl       String?       @db.Text
  createdAt        DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime      @updatedAt @db.Timestamptz(3)

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  payments     Payment[]

  // Índices
  @@index([tenantId, status])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([asaasInvoiceId])
  @@map("invoices")
}

model Payment {
  id        String         @id @default(uuid()) @db.Uuid
  invoiceId String         @db.Uuid
  amount    Decimal        @db.Decimal(10, 2)
  currency  String         @default("BRL") @db.VarChar(3)
  gateway   PaymentGateway
  gatewayId String?        @db.VarChar(255) // ID externo (Asaas)
  method    PaymentMethod
  status    PaymentStatus
  paidAt    DateTime?      @db.Timestamptz(3)
  metadata  Json?          @db.JsonB
  createdAt DateTime       @default(now()) @db.Timestamptz(3)

  // Relações
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Índices
  @@index([invoiceId])
  @@index([status])
  @@index([gateway, gatewayId])
  @@map("payments")
}

model UsageMetrics {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  month           DateTime @db.Date // Primeiro dia do mês
  activeResidents Int      @default(0)
  activeUsers     Int      @default(0)
  dailyRecords    Int      @default(0)
  prescriptions   Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Constraint: Um registro por tenant por mês
  @@unique([tenantId, month])
  @@index([tenantId, month])
  @@map("usage_metrics")
}

model WebhookEvent {
  id             String         @id @default(uuid()) @db.Uuid
  gateway        PaymentGateway
  eventType      String         @db.VarChar(100)
  gatewayEventId String?        @db.VarChar(255) // ID único do evento no gateway
  payload        Json           @db.JsonB
  processed      Boolean        @default(false)
  processedAt    DateTime?      @db.Timestamptz(3)
  error          String?        @db.Text
  createdAt      DateTime       @default(now()) @db.Timestamptz(3)

  // Índices
  @@index([gateway, gatewayEventId])
  @@index([processed])
  @@index([createdAt(sort: Desc)])
  @@map("webhook_events")
}

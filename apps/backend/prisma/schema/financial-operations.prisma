// ──────────────────────────────────────────────────────────────────────────────
//  FINANCEIRO OPERACIONAL (TENANT)
//
//  Gestão de categorias, contas, métodos de pagamento, transações e conciliação
//  IMPORTANTE: este módulo NÃO substitui billing SaaS (Invoice/Subscription).
// ──────────────────────────────────────────────────────────────────────────────

model FinancialCategory {
  id               String                @id @default(uuid()) @db.Uuid
  tenantId         String                @db.Uuid
  name             String                @db.VarChar(100)
  description      String?               @db.Text
  type             FinancialCategoryType
  parentCategoryId String?               @db.Uuid
  isSystemDefault  Boolean               @default(false)
  isActive         Boolean               @default(true)
  createdBy        String                @db.Uuid
  updatedBy        String?               @db.Uuid
  createdAt        DateTime              @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime              @updatedAt @db.Timestamptz(3)
  deletedAt        DateTime?             @db.Timestamptz(3)

  parent       FinancialCategory?     @relation("FinancialCategoryHierarchy", fields: [parentCategoryId], references: [id], onDelete: SetNull)
  children     FinancialCategory[]    @relation("FinancialCategoryHierarchy")
  transactions FinancialTransaction[]

  @@unique([tenantId, name, deletedAt])
  @@index([tenantId, type, isActive])
  @@index([tenantId, parentCategoryId])
  @@index([deletedAt])
  @@map("financial_categories")
}

model FinancialPaymentMethod {
  id                         String    @id @default(uuid()) @db.Uuid
  tenantId                   String    @db.Uuid
  name                       String    @db.VarChar(100)
  code                       String    @db.VarChar(50)
  description                String?   @db.Text
  requiresManualConfirmation Boolean   @default(false)
  allowsInstallments         Boolean   @default(false)
  maxInstallments            Int       @default(1)
  isActive                   Boolean   @default(true)
  createdAt                  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt                  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt                  DateTime? @db.Timestamptz(3)

  transactions FinancialTransaction[]

  @@unique([tenantId, code, deletedAt])
  @@index([tenantId, isActive])
  @@index([deletedAt])
  @@map("financial_payment_methods")
}

model FinancialBankAccount {
  id                String               @id @default(uuid()) @db.Uuid
  tenantId          String               @db.Uuid
  bankCode          String               @db.VarChar(10)
  bankName          String               @db.VarChar(100)
  branch            String               @db.VarChar(20)
  accountNumber     String               @db.VarChar(50)
  accountType       FinancialAccountType
  pixKey            String?              @db.VarChar(100)
  pixKeyType        String?              @db.VarChar(20)
  accountName       String               @db.VarChar(100)
  currentBalance    Decimal              @default(0) @db.Decimal(15, 2)
  lastBalanceUpdate DateTime?            @db.Timestamptz(3)
  isActive          Boolean              @default(true)
  isDefault         Boolean              @default(false)
  createdBy         String               @db.Uuid
  updatedBy         String?              @db.Uuid
  createdAt         DateTime             @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime             @updatedAt @db.Timestamptz(3)
  deletedAt         DateTime?            @db.Timestamptz(3)

  transactions    FinancialTransaction[]
  reconciliations FinancialReconciliation[]
  ledgerEntries   FinancialBankAccountLedger[]

  @@unique([tenantId, bankCode, branch, accountNumber, deletedAt])
  @@index([tenantId, isActive])
  @@index([tenantId, isDefault])
  @@index([deletedAt])
  @@map("financial_bank_accounts")
}

model FinancialTransaction {
  id                   String                     @id @default(uuid()) @db.Uuid
  tenantId             String                     @db.Uuid
  transactionNumber    String?                    @db.VarChar(50)
  type                 FinancialTransactionType
  categoryId           String                     @db.Uuid
  residentId           String?                    @db.Uuid
  residentContractId   String?                    @db.Uuid
  isAutoGenerated      Boolean                    @default(false)
  generationSource     String?                    @db.VarChar(50)
  amount               Decimal                    @db.Decimal(15, 2)
  currency             String                     @default("BRL") @db.VarChar(3)
  discountAmount       Decimal                    @default(0) @db.Decimal(15, 2)
  lateFeeAmount        Decimal                    @default(0) @db.Decimal(15, 2)
  netAmount            Decimal                    @db.Decimal(15, 2)
  issueDate            DateTime                   @db.Date
  dueDate              DateTime                   @db.Date
  paymentDate          DateTime?                  @db.Date
  competenceMonth      DateTime                   @db.Date
  paymentMethodId      String?                    @db.Uuid
  bankAccountId        String?                    @db.Uuid
  status               FinancialTransactionStatus @default(PENDING)
  description          String                     @db.Text
  notes                String?                    @db.Text
  isRecurring          Boolean                    @default(false)
  recurrenceId         String?                    @db.Uuid
  recurrenceFrequency  String?                    @db.VarChar(20)
  attachmentDocumentId String?                    @db.Uuid
  createdBy            String                     @db.Uuid
  confirmedBy          String?                    @db.Uuid
  createdAt            DateTime                   @default(now()) @db.Timestamptz(3)
  updatedAt            DateTime                   @updatedAt @db.Timestamptz(3)
  deletedAt            DateTime?                  @db.Timestamptz(3)

  category      FinancialCategory             @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  paymentMethod FinancialPaymentMethod?       @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  bankAccount   FinancialBankAccount?         @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  items         FinancialReconciliationItem[]
  ledgerEntries FinancialBankAccountLedger[]

  @@index([tenantId, status, dueDate])
  @@index([tenantId, competenceMonth, type])
  @@index([tenantId, residentId])
  @@index([tenantId, residentContractId])
  @@index([categoryId])
  @@index([paymentMethodId])
  @@index([bankAccountId])
  @@index([deletedAt])
  @@map("financial_transactions")
}

model FinancialBankAccountLedger {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  bankAccountId String   @db.Uuid
  transactionId String?  @db.Uuid
  entryType     String   @db.VarChar(40)
  referenceType String?  @db.VarChar(40)
  referenceId   String?  @db.Uuid
  description   String?  @db.Text
  effectiveDate DateTime @db.Date
  amount        Decimal  @db.Decimal(15, 2)
  balanceAfter  Decimal  @db.Decimal(15, 2)
  createdBy     String?  @db.Uuid
  createdAt     DateTime @default(now()) @db.Timestamptz(3)

  bankAccount FinancialBankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  transaction FinancialTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([tenantId, bankAccountId, effectiveDate, createdAt])
  @@index([transactionId])
  @@index([tenantId, entryType])
  @@map("financial_bank_account_ledger")
}

model FinancialReconciliation {
  id                          String                        @id @default(uuid()) @db.Uuid
  tenantId                    String                        @db.Uuid
  bankAccountId               String                        @db.Uuid
  reconciliationDate          DateTime                      @db.Date
  startDate                   DateTime                      @db.Date
  endDate                     DateTime                      @db.Date
  openingBalance              Decimal                       @db.Decimal(15, 2)
  closingBalance              Decimal                       @db.Decimal(15, 2)
  systemBalance               Decimal                       @db.Decimal(15, 2)
  difference                  Decimal                       @db.Decimal(15, 2)
  status                      FinancialReconciliationStatus @default(PENDING)
  reconciledTransactionsCount Int                           @default(0)
  totalIncome                 Decimal                       @default(0) @db.Decimal(15, 2)
  totalExpense                Decimal                       @default(0) @db.Decimal(15, 2)
  notes                       String?                       @db.Text
  discrepancyReason           String?                       @db.Text
  reconciledBy                String?                       @db.Uuid
  createdAt                   DateTime                      @default(now()) @db.Timestamptz(3)
  updatedAt                   DateTime                      @updatedAt @db.Timestamptz(3)

  bankAccount FinancialBankAccount          @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  items       FinancialReconciliationItem[]

  @@unique([tenantId, bankAccountId, reconciliationDate])
  @@index([tenantId, bankAccountId, status])
  @@map("financial_reconciliations")
}

model FinancialReconciliationItem {
  id                  String    @id @default(uuid()) @db.Uuid
  reconciliationId    String    @db.Uuid
  transactionId       String    @db.Uuid
  isReconciled        Boolean   @default(false)
  reconciliationNotes String?   @db.Text
  reconciledAt        DateTime? @db.Timestamptz(3)
  reconciledBy        String?   @db.Uuid

  reconciliation FinancialReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  transaction    FinancialTransaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@unique([reconciliationId, transactionId])
  @@index([transactionId])
  @@map("financial_reconciliation_items")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ALERTAS MÉDICOS DE SINAIS VITAIS
//
//  Sistema de alertas médicos persistentes vinculados a sinais vitais anormais.
//  Complementa o sistema de notificações broadcast com registro clínico permanente.
// ──────────────────────────────────────────────────────────────────────────────

model VitalSignAlert {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  residentId     String   @db.Uuid
  vitalSignId    String   @db.Uuid
  notificationId String?  @db.Uuid

  // Tipo e severidade do alerta
  type     VitalSignAlertType
  severity AlertSeverity

  // Descrição do alerta
  title       String @db.VarChar(255)
  description String @db.Text
  value       String @db.VarChar(100) // Ex: "175/98 mmHg", "280 mg/dL"
  metadata    Json   @db.JsonB // { threshold, expectedRange, detectedAt, etc }

  // Gerenciamento do alerta
  status     AlertStatus @default(ACTIVE)
  priority   Int         @default(0) // 0-5 para ordenação (calculado automaticamente)
  assignedTo String?     @db.Uuid // Profissional responsável

  // Documentação médica
  medicalNotes String? @db.Text // Observações da equipe
  actionTaken  String? @db.Text // Conduta aplicada

  // Auditoria
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  resolvedAt DateTime? @db.Timestamptz(3)
  resolvedBy String?   @db.Uuid
  createdBy  String?   @db.Uuid // NULL = criado automaticamente pelo sistema

  // Relacionamentos
  tenant         Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident       Resident                 @relation(fields: [residentId], references: [id], onDelete: Cascade)
  vitalSign      VitalSign                @relation(fields: [vitalSignId], references: [id], onDelete: Cascade)
  notification   Notification?            @relation(fields: [notificationId], references: [id], onDelete: SetNull)
  clinicalNotes  ClinicalNote[]           // Um alerta pode gerar várias evoluções
  assignedUser   User?                    @relation("AssignedAlerts", fields: [assignedTo], references: [id], onDelete: SetNull)
  resolvedUser   User?                    @relation("ResolvedAlerts", fields: [resolvedBy], references: [id], onDelete: SetNull)
  history        VitalSignAlertHistory[]  // Histórico de alterações para exibição ao usuário

  // Índices para performance
  @@index([tenantId, residentId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([residentId, status])
  @@index([vitalSignId])
  @@index([notificationId])
  @@index([assignedTo])
  @@map("vital_sign_alerts")
}

// ──────────────────────────────────────────────────────────────────────────────
//  ENUMS
// ──────────────────────────────────────────────────────────────────────────────

enum VitalSignAlertType {
  PRESSURE_HIGH      // PA sistólica elevada
  PRESSURE_LOW       // PA sistólica baixa
  GLUCOSE_HIGH       // Hiperglicemia
  GLUCOSE_LOW        // Hipoglicemia
  TEMPERATURE_HIGH   // Febre/Hipertermia
  TEMPERATURE_LOW    // Hipotermia
  OXYGEN_LOW         // Hipóxia
  HEART_RATE_HIGH    // Taquicardia
  HEART_RATE_LOW     // Bradicardia
}

enum AlertStatus {
  ACTIVE       // Aguardando conduta (recém-criado)
  IN_TREATMENT // Em tratamento (conduta aplicada ou evolução criada)
  MONITORING   // Sob monitoramento contínuo
  RESOLVED     // Resolvido com sucesso
  IGNORED      // Ignorado (com justificativa em medicalNotes)
}

// NOTA: AlertSeverity já está definido em enums.prisma (linhas 583-589)
// Reutilizando: INFO, WARNING, CRITICAL

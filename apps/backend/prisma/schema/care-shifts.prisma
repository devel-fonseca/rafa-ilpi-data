// ──────────────────────────────────────────────────────────────────────────────
//  ESCALA DE CUIDADOS - Gestão de Turnos, Equipes e Plantões
//
//  Módulo para organização de cobertura assistencial 24h conforme RDC 502/2021
//  Data: 21/01/2026
//  Autor: @efonseca78 (BR)
// ──────────────────────────────────────────────────────────────────────────────

// ==========================================
// TURNOS FIXOS DO SISTEMA
// ==========================================

// ShiftTemplate: Turnos fixos pré-configurados (5 turnos)
// Tabela SHARED (public schema) - read-only para usuários
// IMPORTANTE: UUIDs são FIXOS (definidos em seed file), não gerados dinamicamente
model ShiftTemplate {
  id           String            @id @db.Uuid // UUID fixo (sem @default) - definido em seed
  type         ShiftTemplateType @unique
  name         String            @db.VarChar(50) // "Dia 8h", "Noite 12h"
  startTime    String            @db.VarChar(5) // "07:00" (HH:mm)
  endTime      String            @db.VarChar(5) // "15:00" (HH:mm)
  duration     Int // Duração em horas (8 ou 12)
  description  String?           @db.Text
  isActive     Boolean           @default(true) // Sistema pode desativar turnos obsoletos
  displayOrder Int               @default(0) // Ordem de exibição

  // Relações
  // tenantConfigs - NO relation (cross-schema, validated in app layer)
  // weeklyAssignments - NO relation (cross-schema, validated in app layer)
  // shifts - NO relation (cross-schema, validated in app layer)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  @@map("shift_templates")
}

// TenantShiftConfig: Configuração de turnos por tenant
// Tabela TENANT-SCOPED (schema do tenant) - customizações opcionais dos 5 turnos padrão
// Se não existir config, usa valores padrão de public.shift_templates
model TenantShiftConfig {
  id              String  @id @default(uuid()) @db.Uuid
  tenantId        String  @db.Uuid // Stored for reference, no FK (cross-schema)
  shiftTemplateId String  @db.Uuid // FK para public.shift_templates (cross-schema, validated in app)
  isEnabled       Boolean @default(true) // Tenant pode desabilitar turnos que não usa
  customName      String? @db.VarChar(50) // Nome customizado (ex: "Plantão Manhã")

  // Horários customizados (opcional) - se null, usa o padrão do ShiftTemplate
  customStartTime String? @db.VarChar(5) // "08:00" (se ILPI inicia às 08h ao invés de 07h)
  customEndTime   String? @db.VarChar(5) // "16:00"
  customDuration  Int? // Duração em horas (calculado automaticamente se não fornecido)

  notes String? @db.Text

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  @@unique([shiftTemplateId, deletedAt])
  @@index([tenantId])
  @@index([isEnabled])
  @@index([deletedAt])
  @@map("tenant_shift_config")
}

// ==========================================
// EQUIPES DE CUIDADORES
// ==========================================

// Team: Equipes reutilizáveis de cuidadores
// Tabela TENANT-SCOPED (schema do tenant)
model Team {
  id          String  @id @default(uuid()) @db.Uuid
  tenantId    String  @db.Uuid // Stored for reference, no FK (cross-schema)
  name        String  @db.VarChar(100) // "Equipe A Manhã"
  description String? @db.Text
  isActive    Boolean @default(true)
  color       String? @db.VarChar(7) // Hex color para UI (#FF5733)

  // Relações
  members               TeamMember[]
  shifts                Shift[]
  originalSubstitutions ShiftSubstitution[]    @relation("OriginalTeam")
  newSubstitutions      ShiftSubstitution[]    @relation("NewTeam")

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  @@index([tenantId, isActive])
  @@index([deletedAt])
  @@map("teams")
}

// TeamMember: Membros das equipes (relação N:M)
// Tabela TENANT-SCOPED
model TeamMember {
  id       String  @id @default(uuid()) @db.Uuid
  tenantId String  @db.Uuid // Stored for reference, no FK (cross-schema)
  teamId   String  @db.Uuid
  userId   String  @db.Uuid // Stored for reference, no FK (same-schema but managed by Prisma)
  role     String? @db.VarChar(50) // "Líder", "Substituto" (opcional)

  // Relações
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  // user - NO FK (evita problemas de referência, Prisma gerencia a relação)

  // Auditoria
  addedBy   String    @db.Uuid
  addedAt   DateTime  @default(now()) @db.Timestamptz(3)
  removedBy String?   @db.Uuid
  removedAt DateTime? @db.Timestamptz(3)

  @@unique([teamId, userId, removedAt]) // Permite re-adicionar após remoção
  @@index([tenantId, teamId])
  @@index([userId])
  @@index([removedAt])
  @@map("team_members")
}

// ==========================================
// PLANTÕES CONCRETOS
// ==========================================

// Shift: Plantão concreto (data + turno + equipe)
// Tabela TENANT-SCOPED
model Shift {
  id              String      @id @default(uuid()) @db.Uuid
  tenantId        String      @db.Uuid // Stored for reference, no FK (cross-schema)
  date            DateTime    @db.Date
  shiftTemplateId String      @db.Uuid // Stored for reference, no FK (cross-schema to public.shift_templates)
  teamId          String?     @db.Uuid // null = sem equipe ou membros individuais
  status          ShiftStatus @default(SCHEDULED)
  notes           String?     @db.Text

  // Relações (apenas same-schema)
  // shiftTemplate - NO FK (cross-schema to public.shift_templates, validated in app layer)
  team          Team?                 @relation(fields: [teamId], references: [id], onDelete: SetNull)
  members       ShiftAssignment[]
  substitutions ShiftSubstitution[]
  history       ShiftHistory[]

  // Versionamento
  versionNumber Int @default(1)

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  @@unique([tenantId, date, shiftTemplateId, deletedAt])
  @@index([tenantId, date])
  @@index([tenantId, date, status])
  @@index([teamId])
  @@index([status])
  @@index([deletedAt])
  @@map("shifts")
}

// ShiftAssignment: Membros designados para o plantão
// Tabela TENANT-SCOPED
model ShiftAssignment {
  id         String  @id @default(uuid()) @db.Uuid
  tenantId   String  @db.Uuid // Stored for reference, no FK (cross-schema)
  shiftId    String  @db.Uuid
  userId     String  @db.Uuid
  isFromTeam Boolean @default(true) // true = veio da equipe, false = adicionado manualmente

  // Relações
  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  // user - NO FK (userId stored for reference, validated in app layer)

  // Auditoria
  assignedBy String    @db.Uuid
  assignedAt DateTime  @default(now()) @db.Timestamptz(3)
  removedBy  String?   @db.Uuid
  removedAt  DateTime? @db.Timestamptz(3)

  @@unique([shiftId, userId, removedAt]) // Permite re-adicionar após remoção
  @@index([tenantId, shiftId])
  @@index([userId])
  @@index([removedAt])
  @@map("shift_assignments")
}

// ==========================================
// SUBSTITUIÇÕES PONTUAIS
// ==========================================

// ShiftSubstitution: Registro de substituições pontuais
// Tabela TENANT-SCOPED
model ShiftSubstitution {
  id       String           @id @default(uuid()) @db.Uuid
  tenantId String           @db.Uuid // Stored for reference, no FK (cross-schema)
  shiftId  String           @db.Uuid
  type     SubstitutionType
  reason   String           @db.Text // Motivo obrigatório

  // Para TEAM_REPLACEMENT
  originalTeamId String? @db.Uuid
  newTeamId      String? @db.Uuid

  // Para MEMBER_REPLACEMENT / MEMBER_ADDITION
  originalUserId String? @db.Uuid
  newUserId      String? @db.Uuid

  // Relações
  shift        Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  originalTeam Team? @relation("OriginalTeam", fields: [originalTeamId], references: [id], onDelete: SetNull)
  newTeam      Team? @relation("NewTeam", fields: [newTeamId], references: [id], onDelete: SetNull)
  // originalUser - NO FK (originalUserId stored for reference, validated in app layer)
  // newUser - NO FK (newUserId stored for reference, validated in app layer)

  // Auditoria
  substitutedBy String   @db.Uuid
  substitutedAt DateTime @default(now()) @db.Timestamptz(3)

  @@index([tenantId, shiftId])
  @@index([shiftId, type])
  @@map("shift_substitutions")
}

// ==========================================
// HISTÓRICO DE VERSIONAMENTO
// ==========================================

// ShiftHistory: Histórico de alterações do plantão
// Tabela TENANT-SCOPED
model ShiftHistory {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid // Stored for reference, no FK (cross-schema)
  shiftId       String     @db.Uuid
  versionNumber Int
  changeType    ChangeType // CREATE | UPDATE | DELETE
  changeReason  String     @db.Text // Motivo obrigatório (min 10 chars)

  // Snapshots JSON
  previousData  Json? // null em CREATE
  newData       Json
  changedFields String[] @default([]) // ["teamId", "status"]

  // Relações
  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  // user - NO FK (changedBy stored for reference, validated in app layer)

  // Auditoria
  changedBy String   @db.Uuid
  changedAt DateTime @default(now()) @db.Timestamptz(3)

  @@index([tenantId, shiftId, versionNumber(sort: Desc)])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("shift_history")
}

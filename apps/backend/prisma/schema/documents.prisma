// ──────────────────────────────────────────────────────────────────────────────
//  DOCUMENTAÇÃO INSTITUCIONAL
//
//  Perfil e documentos da instituição (CNPJ, alvarás, etc)
// ──────────────────────────────────────────────────────────────────────────────

model TenantProfile {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @unique @db.Uuid

  // Logo e identidade visual
  logoUrl String? // URL do logo no S3/MinIO
  logoKey String? // Chave do arquivo no S3 para deleção

  // Natureza jurídica e dados básicos
  legalNature LegalNature?
  tradeName   String? // Nome fantasia

  // Dados regulatórios
  cnesCode         String? @db.VarChar(20) // Código CNES (Cadastro Nacional de Estabelecimentos de Saúde)
  capacityDeclared Int? // Capacidade declarada de residentes
  capacityLicensed Int? // Capacidade licenciada pela vigilância sanitária

  // Contatos institucionais
  contactPhone String?
  contactEmail String?
  websiteUrl   String?

  // Informações complementares
  foundedAt DateTime? @db.Date // Data de fundação
  mission   String?   @db.Text // Missão institucional
  vision    String?   @db.Text // Visão institucional
  values    String?   @db.Text // Valores institucionais

  // Observações
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId])
  @@index([legalNature])
  @@index([deletedAt])
  @@map("tenant_profiles")
}

model TenantDocument {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // Tipo de documento (baseado na natureza jurídica)
  type String @db.VarChar(100) // ESTATUTO, CMI, CNPJ, ALVARA_USO, etc.

  // Arquivo
  fileUrl  String // URL completa do arquivo no S3/MinIO
  fileKey  String? // Chave do arquivo no S3 para deleção
  fileName String // Nome original do arquivo
  fileSize Int? // Tamanho em bytes
  mimeType String? @db.VarChar(100) // application/pdf, image/jpeg, etc.

  // Metadados do documento
  issuedAt       DateTime?      @db.Date // Data de emissão
  expiresAt      DateTime?      @db.Date // Data de vencimento (se aplicável)
  status         DocumentStatus @default(PENDENTE) // Calculado automaticamente
  documentNumber String?        @db.VarChar(100) // Número do documento (ex: protocolo, número de alvará)
  issuerEntity   String?        @db.VarChar(200) // Entidade emissora (ex: Vigilância Sanitária, Corpo de Bombeiros)
  tags           String[]       @default([]) // Tags para categorização adicional

  // Observações
  notes String? @db.Text

  // Versionamento e substituição
  version      Int       @default(1) // Versão do documento (incrementa a cada substituição)
  replacedById String?   @db.Uuid // ID do documento que substituiu este
  replacedAt   DateTime? @db.Timestamptz(3) // Data em que foi substituído

  // Auditoria
  uploadedBy String    @db.Uuid // ID do usuário que fez upload
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  // Relações
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replacedBy TenantDocument?   @relation("DocumentReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces   TenantDocument[]  @relation("DocumentReplacement")
  history    DocumentHistory[]

  // Índices
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, expiresAt])
  @@index([expiresAt])
  @@index([status])
  @@index([deletedAt])
  @@index([replacedById])
  @@index([version])
  @@map("tenant_documents")
}

model DocumentHistory {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  documentId String @db.Uuid // Documento atual relacionado

  // Ação realizada
  action DocumentAction // CREATED, UPDATED, REPLACED, DELETED
  reason String?        @db.Text // Motivo da alteração

  // Snapshot dos dados anteriores (JSON)
  previousData Json? // Estado anterior do documento
  newData      Json? // Novo estado do documento

  // Campos que mudaram
  changedFields String[] @default([]) // Lista de campos alterados

  // Auditoria
  changedBy String   @db.Uuid // Usuário que realizou a ação
  changedAt DateTime @default(now()) @db.Timestamptz(3)

  // Relações
  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document TenantDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Índices
  @@index([tenantId, documentId])
  @@index([documentId])
  @@index([action])
  @@index([changedAt])
  @@map("document_history")
}

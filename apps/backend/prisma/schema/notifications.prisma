// ──────────────────────────────────────────────────────────────────────────────
//  NOTIFICAÇÕES E ALERTAS
//
//  Sistema de notificações e alertas do sistema
// ──────────────────────────────────────────────────────────────────────────────

model Notification {
  id       String  @id @default(uuid()) @db.Uuid
  tenantId String  @db.Uuid

  // Tipo e Categoria
  type     SystemNotificationType
  category NotificationCategory
  severity NotificationSeverity

  // Conteúdo
  title     String  @db.VarChar(255)
  message   String  @db.Text
  actionUrl String? @db.Text // URL para navegação ao clicar

  // Referência à entidade relacionada
  entityType String? @db.VarChar(50) // Ex: "PRESCRIPTION", "VITAL_SIGN"
  entityId   String? @db.Uuid

  // Metadata flexível para informações adicionais
  metadata Json? @db.JsonB

  // Expiração automática
  expiresAt DateTime? @db.Timestamptz(3)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reads           NotificationRead[] // Rastreamento individual de leitura
  vitalSignAlerts VitalSignAlert[] // Alertas médicos vinculados a esta notificação
  sentinelEventNotifications SentinelEventNotification[] // Notificações de Eventos Sentinela

  // Índices para performance
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, category, createdAt(sort: Desc)])
  @@index([tenantId, severity, createdAt(sort: Desc)])
  @@index([type])
  @@index([category])
  @@index([severity])
  @@index([expiresAt])
  @@index([tenantId, type]) // Notificações por tipo
  @@index([entityType, entityId]) // Buscar notificações de uma entidade específica
  @@map("notifications")
}

// Tabela de rastreamento individual de leitura de notificações
model NotificationRead {
  id             String   @id @default(uuid()) @db.Uuid
  notificationId String   @db.Uuid
  userId         String   @db.Uuid
  readAt         DateTime @default(now()) @db.Timestamptz(3)

  // Relações
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@unique([notificationId, userId]) // Um usuário só pode marcar como lida uma vez
  @@index([userId, readAt(sort: Desc)]) // Histórico de leituras do usuário
  @@index([notificationId]) // Buscar leituras de uma notificação
  @@map("notification_reads")
}

model SystemAlert {
  id        String        @id @default(uuid()) @db.Uuid
  type      AlertType
  severity  AlertSeverity
  title     String        @db.VarChar(255)
  message   String        @db.Text
  metadata  Json?         @db.JsonB
  tenantId  String?       @db.Uuid
  read      Boolean       @default(false)
  readAt    DateTime?     @db.Timestamptz(3)
  createdAt DateTime      @default(now()) @db.Timestamptz(3)

  // Relações
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([type, severity])
  @@index([read])
  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  // Índices compostos adicionais para queries frequentes
  @@index([tenantId, read, createdAt(sort: Desc)]) // Alertas não lidos do tenant
  @@index([type, read, createdAt(sort: Desc)]) // Alertas não lidos por tipo
  @@map("system_alerts")
}

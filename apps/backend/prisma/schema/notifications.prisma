// ──────────────────────────────────────────────────────────────────────────────
//  NOTIFICAÇÕES E ALERTAS
//
//  Sistema de notificações e alertas do sistema
// ──────────────────────────────────────────────────────────────────────────────

model Notification {
  id       String  @id @default(uuid()) @db.Uuid
  tenantId String  @db.Uuid
  userId   String? @db.Uuid // null = broadcast para todos do tenant

  // Tipo e Categoria
  type     SystemNotificationType
  category NotificationCategory
  severity NotificationSeverity

  // Conteúdo
  title     String  @db.VarChar(255)
  message   String  @db.Text
  actionUrl String? @db.Text // URL para navegação ao clicar

  // Referência à entidade relacionada
  entityType String? @db.VarChar(50) // Ex: "PRESCRIPTION", "VITAL_SIGN"
  entityId   String? @db.Uuid

  // Metadata flexível para informações adicionais
  metadata Json? @db.JsonB

  // Status de leitura
  read   Boolean   @default(false)
  readAt DateTime? @db.Timestamptz(3)

  // Expiração automática
  expiresAt DateTime? @db.Timestamptz(3)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([tenantId, userId, read, createdAt(sort: Desc)])
  @@index([tenantId, category, read, createdAt(sort: Desc)])
  @@index([tenantId, severity, read, createdAt(sort: Desc)])
  @@index([type])
  @@index([category])
  @@index([severity])
  @@index([expiresAt])
  @@index([read])
  // Índices compostos adicionais para queries frequentes
  @@index([userId, read, createdAt(sort: Desc)]) // Notificações não lidas do usuário
  @@index([tenantId, type, read]) // Notificações por tipo (ex: MEDICATION_DUE)
  @@index([entityType, entityId]) // Buscar notificações de uma entidade específica
  @@map("notifications")
}

model SystemAlert {
  id        String        @id @default(uuid()) @db.Uuid
  type      AlertType
  severity  AlertSeverity
  title     String        @db.VarChar(255)
  message   String        @db.Text
  metadata  Json?         @db.JsonB
  tenantId  String?       @db.Uuid
  read      Boolean       @default(false)
  readAt    DateTime?     @db.Timestamptz(3)
  createdAt DateTime      @default(now()) @db.Timestamptz(3)

  // Relações
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices
  @@index([type, severity])
  @@index([read])
  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  // Índices compostos adicionais para queries frequentes
  @@index([tenantId, read, createdAt(sort: Desc)]) // Alertas não lidos do tenant
  @@index([type, read, createdAt(sort: Desc)]) // Alertas não lidos por tipo
  @@map("system_alerts")
}

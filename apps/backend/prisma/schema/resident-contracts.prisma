// ============================================================================
// RESIDENT CONTRACTS - Contratos Digitalizados dos Residentes
// ============================================================================

enum ContractHistoryAction {
  CREATED
  UPDATED
  REPLACED
  DELETED
}

enum SignatoryRole {
  RESIDENTE
  RESPONSAVEL_LEGAL
  RESPONSAVEL_CONTRATUAL
  TESTEMUNHA
  ILPI
}

model ResidentContract {
  id                     String                 @id @default(uuid()) @db.Uuid
  tenantId               String                 @db.Uuid
  residentId             String                 @db.Uuid
  contractNumber         String                 @db.VarChar(100)
  startDate              DateTime               @db.Date
  endDate                DateTime?              @db.Date
  isIndefinite           Boolean                @default(false)
  monthlyAmount          Decimal                @db.Decimal(10, 2)
  dueDay                 Int
  lateFeePercent         Decimal                @default(0) @db.Decimal(5, 2)
  interestMonthlyPercent Decimal                @default(0) @db.Decimal(5, 2)
  status                 ContractDocumentStatus
  adjustmentIndex        String?                @db.VarChar(50)
  adjustmentRate         Decimal?               @db.Decimal(5, 2)
  lastAdjustmentDate     DateTime?              @db.Date
  signatories            Json                   @db.JsonB
  originalFileUrl        String?                @db.Text
  originalFileKey        String?                @db.Text
  originalFileName       String?                @db.Text
  originalFileSize       Int?
  originalFileMimeType   String?                @db.VarChar(100)
  originalFileHash       String?                @db.VarChar(64)
  processedFileUrl       String?                @db.Text
  processedFileKey       String?                @db.Text
  processedFileName      String?                @db.Text
  processedFileSize      Int?
  processedFileHash      String?                @db.VarChar(64)
  publicToken            String                 @unique @db.VarChar(64) // Token público para validação de autenticidade
  notes                  String?                @db.Text
  version                Int                    @default(1)
  versionMajor           Int                    @default(1)
  versionMinor           Int                    @default(0)
  replacedById           String?                @db.Uuid
  replacedAt             DateTime?              @db.Timestamptz(3)
  rescindedAt            DateTime?              @db.Timestamptz(3)
  rescissionReason       String?                @db.Text
  uploadedBy             String                 @db.Uuid
  createdAt              DateTime               @default(now()) @db.Timestamptz(3)
  updatedAt              DateTime               @updatedAt @db.Timestamptz(3)
  deletedAt              DateTime?              @db.Timestamptz(3)

  // Relations
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident     Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  uploader     User               @relation("ContractUploader", fields: [uploadedBy], references: [id])
  replacedBy   ResidentContract?  @relation("ContractReplacements", fields: [replacedById], references: [id])
  replacements ResidentContract[] @relation("ContractReplacements")
  history      ContractHistory[]

  @@unique([tenantId, contractNumber])
  @@index([tenantId, residentId])
  @@index([tenantId, status])
  @@index([tenantId, endDate])
  @@index([residentId])
  @@index([endDate])
  @@index([status])
  @@index([isIndefinite])
  @@index([rescindedAt])
  @@index([deletedAt])
  @@index([replacedById])
  @@index([version])
  @@index([versionMajor, versionMinor])
  @@index([processedFileHash])
  @@map("resident_contracts")
}

model ContractHistory {
  id            String                @id @default(uuid()) @db.Uuid
  tenantId      String                @db.Uuid
  contractId    String                @db.Uuid
  action        ContractHistoryAction
  reason        String?               @db.Text
  previousData  Json?                 @db.JsonB
  newData       Json?                 @db.JsonB
  changedFields String[]              @default([])
  changedBy     String                @db.Uuid
  changedAt     DateTime              @default(now()) @db.Timestamptz(3)

  // Relations
  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract ResidentContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user     User             @relation("ContractHistoryUser", fields: [changedBy], references: [id])

  @@index([tenantId, contractId])
  @@index([contractId])
  @@index([action])
  @@index([changedAt])
  @@map("resident_contracts_history")
}

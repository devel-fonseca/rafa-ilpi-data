// ──────────────────────────────────────────────────────────────────────────────
//  NÚCLEO MULTI-TENANT
//
//  Plan, Tenant e Subscription - Hub central do sistema
// ──────────────────────────────────────────────────────────────────────────────

// ──────────────────────────────────────────────────────────────────────────────
//  PLANOS
// ──────────────────────────────────────────────────────────────────────────────
model Plan {
  id                    String       @id @default(uuid()) @db.Uuid
  name                  String       @unique
  displayName           String
  type                  PlanType
  maxResidents          Int
  maxUsers              Int
  price                 Decimal?     @db.Decimal(10, 2)
  annualDiscountPercent Decimal?     @default(0) @map("annual_discount_percent") @db.Decimal(5, 2) // Desconto para assinaturas anuais (0-100%)
  trialDays             Int          @default(0)
  isPopular             Boolean      @default(false)
  isActive              Boolean      @default(true)
  features              Json         @default("{}")
  billingCycle          BillingCycle @default(MONTHLY) // MONTHLY | ANNUAL
  createdAt             DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt             DateTime     @updatedAt @db.Timestamptz(3)

  subscriptions  Subscription[]
  contracts      ServiceContract[] // DEPRECATED - migrar para termsOfService
  termsOfService TermsOfService[]  @relation("TermsOfServicePlan") // Nova tabela de termos de uso

  @@map("plans")
}

// ──────────────────────────────────────────────────────────────────────────────
//  TENANTS (Clínicas / Residências)
// ──────────────────────────────────────────────────────────────────────────────
model Tenant {
  id         String       @id @default(uuid()) @db.Uuid
  name       String
  slug       String       @unique
  cnpj       String?      @unique
  email      String
  phone      String?
  status     TenantStatus @default(TRIAL)
  schemaName String       @unique

  // Asaas Integration
  asaasCustomerId String? @unique @db.VarChar(255) // ID do cliente no Asaas

  // Endereço detalhado
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?

  // Timezone
  timezone String @default("America/Sao_Paulo") @db.VarChar(50) // Timezone IANA do tenant

  // ========== CUSTOMIZAÇÕES DE PLANO (OVERRIDES) ==========
  // Estes campos sobrescrevem os limites do plano base para casos especiais:
  // - Retenção de clientes (oferecer +users/features para evitar cancelamento)
  // - Testes e validações (liberar features temporariamente)
  // - Negociações comerciais (ajuste fino antes de fechar contrato)
  //
  // Lógica de resolução: customField ?? plan.field ?? default
  customMaxUsers     Int?  // null = usa Plan.maxUsers | número = override
  customMaxResidents Int?  // null = usa Plan.maxResidents | número = override
  customFeatures     Json? // null = usa Plan.features | objeto = merge com plano base
  // Exemplo customFeatures: {"evolucoes_clinicas": true, "agenda": false}
  // Adiciona "evolucoes_clinicas" e remove "agenda" do plano base

  deletedAt DateTime? @db.Timestamptz(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  subscriptions              Subscription[]
  users                      User[]
  userProfiles               UserProfile[]
  userHistory                UserHistory[] // Histórico de usuários
  residents                  Resident[]
  residentHistory            ResidentHistory[] // Histórico de residentes
  dailyRecords               DailyRecord[]
  dailyRecordHistory         DailyRecordHistory[]
  vitalSigns                 VitalSign[]
  prescriptions              Prescription[]
  prescriptionHistory        PrescriptionHistory[] // Histórico de prescrições
  medicationHistory          MedicationHistory[] // Histórico de medicamentos
  sosMedicationHistory       SOSMedicationHistory[] // Histórico de medicamentos SOS
  medicationAdministrations  MedicationAdministration[]
  sosAdministrations         SOSAdministration[]
  vaccinations               Vaccination[]
  vaccinationHistory         VaccinationHistory[] // Histórico de vacinações
  allergies                  Allergy[]
  allergyHistory             AllergyHistory[] // Histórico de alergias
  conditions                 Condition[]
  conditionHistory           ConditionHistory[] // Histórico de condições
  clinicalNotes              ClinicalNote[]
  clinicalNoteHistory        ClinicalNoteHistory[]
  clinicalProfiles           ClinicalProfile[]
  clinicalProfileHistory     ClinicalProfileHistory[]
  dietaryRestrictions        DietaryRestriction[]
  dietaryRestrictionHistory  DietaryRestrictionHistory[]
  buildings                  Building[]
  floors                     Floor[]
  beds                       Bed[]
  profile                    TenantProfile?
  documents                  TenantDocument[]
  residentDocuments          ResidentDocument[]
  residentContracts          ResidentContract[] // Contratos de serviço dos residentes (NÃO confundir com ServiceContract de SaaS)
  contractHistory            ContractHistory[] // Histórico de alterações nos contratos dos residentes
  notifications              Notification[]
  clinicalNoteDocuments      ClinicalNoteDocument[]
  documentHistory            DocumentHistory[]
  pops                       Pop[]
  popAttachments             PopAttachment[]
  popHistory                 PopHistory[]
  VitalSignHistory           VitalSignHistory[]
  bedTransferHistory         BedTransferHistory[]
  residentScheduleConfigs    ResidentScheduleConfig[]
  residentScheduledEvents    ResidentScheduledEvent[]
  invoices                   Invoice[] // SuperAdmin - Faturas
  usageMetrics               UsageMetrics[] // SuperAdmin - Métricas de uso
  systemAlerts                SystemAlert[] // SuperAdmin - Alertas
  contractAcceptance          ContractAcceptance? // DEPRECATED - migrar para termsOfServiceAcceptance
  termsOfServiceAcceptance    TermsOfServiceAcceptance? // Nova tabela de aceite de termos de uso
  privacyPolicyAcceptance     PrivacyPolicyAcceptance?
  messages                    Message[]
  messageRecipients          MessageRecipient[]
  messageAttachments         MessageAttachment[]
  emailLogs                  EmailLog[] // Auditoria de emails enviados
  accessLogs                 AccessLog[] // Logs de acesso e auditoria de segurança
  vitalSignAlerts            VitalSignAlert[] // Alertas médicos de sinais vitais
  institutionalEvents        InstitutionalEvent[] // Eventos institucionais
  sentinelEventNotifications SentinelEventNotification[] // Notificações de Eventos Sentinela
  stats                      TenantStats? // Cache de estatísticas (evita N+1 queries)
  residentBelongings         ResidentBelonging[] // Pertences dos residentes
  belongingTerms             BelongingTerm[] // Termos de pertences
  belongingHistory           BelongingHistory[] // Histórico de pertences

  @@index([timezone])
  @@map("tenants")
}

// ──────────────────────────────────────────────────────────────────────────────
//  SUBSCRIPTIONS (Stripe‑style)
// ──────────────────────────────────────────────────────────────────────────────
model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @db.Uuid
  planId             String    @db.Uuid
  startDate          DateTime  @default(now()) @db.Timestamptz(3)
  endDate            DateTime? @db.Timestamptz(3)
  currentPeriodStart DateTime? @db.Timestamptz(3)
  currentPeriodEnd   DateTime? @db.Timestamptz(3)
  trialEndDate       DateTime? @db.Timestamptz(3)
  status             String // trialing | active | past_due | canceled | unpaid | incomplete

  // Asaas Integration
  asaasSubscriptionId String?   @unique @db.VarChar(255) // ID da assinatura no Asaas
  asaasCreatedAt      DateTime? @db.Timestamptz(3) @map("asaas_created_at") // Data de criação no Asaas
  asaasCreationError  String?   @db.Text @map("asaas_creation_error") // Erro na tentativa de criação (retry manual)
  lastSyncedAt        DateTime? @db.Timestamptz(3) @map("last_synced_at") // Última sincronização com Asaas
  asaasSyncError      String?   @db.Text @map("asaas_sync_error") // Erro na sincronização

  // Pricing Overrides (Descontos e Preços Personalizados)
  discountPercent Decimal? @db.Decimal(5, 2) // Desconto percentual (0.00 a 100.00)
  discountReason  String? // Razão do desconto (ex: "Promoção Black Friday", "Cliente VIP")
  customPrice     Decimal? @db.Decimal(10, 2) // Preço customizado (override total do plan.price)

  // Feature Snapshot (Features no momento da assinatura)
  subscribedFeatures Json? @map("subscribed_features")

  // Billing Preferences (Onboarding)
  billingCycle           String? @map("billing_cycle") @db.VarChar(20) // MONTHLY | ANNUAL
  preferredPaymentMethod String? @map("preferred_payment_method") @db.VarChar(50) // PIX | BOLETO | CREDIT_CARD

  // Trial Alerts Control (Idempotência - evitar emails duplicados)
  trialAlert7Sent Boolean @default(false) @map("trial_alert_7_sent") // Email D-7 enviado
  trialAlert3Sent Boolean @default(false) @map("trial_alert_3_sent") // Email D-3 enviado
  trialAlert1Sent Boolean @default(false) @map("trial_alert_1_sent") // Email D-1 enviado

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan     Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)
  invoices Invoice[] // SuperAdmin - Faturas da assinatura

  @@map("subscriptions")
}

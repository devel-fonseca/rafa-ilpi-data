// ──────────────────────────────────────────────────────────────────────────────
//  REGISTROS DIÁRIOS
//
//  Registros diários de cuidados e agenda do residente
// ──────────────────────────────────────────────────────────────────────────────

model DailyRecord {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo e metadados
  type RecordType
  date DateTime   @db.Date // Data do registro (sem hora)
  time String // Hora no formato "HH:mm" (ex: "07:00", "14:30")

  // Dados estruturados (JSON) - cada tipo tem sua própria estrutura
  data Json @default("{}")

  // ─────────────────────────────────────────────────────────────
  // CAMPOS PARA INTERCORRÊNCIAS E RDC 502/2021 (opcionais)
  // ─────────────────────────────────────────────────────────────
  incidentCategory        IncidentCategory?
  incidentSubtypeClinical IncidentSubtypeClinical?
  incidentSubtypeAssist   IncidentSubtypeAssistencial?
  incidentSubtypeAdmin    IncidentSubtypeAdministrativa?
  incidentSeverity        IncidentSeverity?
  isEventoSentinela       Boolean                        @default(false)
  isDoencaNotificavel     Boolean                        @default(false)
  rdcIndicators           Json                           @default("[]") // Array de RdcIndicatorType
  notificadoVigilancia    Boolean                        @default(false)
  dataNotificacao         DateTime?                      @db.Timestamptz(3)
  protocoloNotificacao    String?                        @db.VarChar(100)

  // Responsável pelo registro
  recordedBy String // Nome do profissional
  userId     String @db.Uuid // ID do usuário que fez o registro

  // Observações gerais (opcional)
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Relação com histórico de versões
  history DailyRecordHistory[]

  // Relação com Eventos Sentinela
  sentinelEventNotifications SentinelEventNotification[]

  // Índices para performance
  @@index([tenantId, residentId, date(sort: Desc)])
  @@index([tenantId, date(sort: Desc)])
  @@index([residentId, date(sort: Desc), time])
  @@index([deletedAt])
  // Índices compostos adicionais para queries frequentes
  @@index([tenantId, type, date(sort: Desc)]) // Registros por tipo (ex: ALIMENTACAO do dia)
  @@index([residentId, type, date(sort: Desc)]) // Registros do residente por tipo
  @@index([tenantId, date, deletedAt]) // Registros ativos do dia
  @@map("daily_records")
}

model DailyRecordHistory {
  id            String @id @default(uuid()) @db.Uuid
  recordId      String @db.Uuid // FK para DailyRecord
  tenantId      String @db.Uuid
  versionNumber Int // Número sequencial da versão (1, 2, 3...)

  // Dados da versão anterior (snapshot completo)
  previousData Json // Snapshot completo do estado anterior

  // Dados da nova versão (para comparação)
  newData Json // Snapshot completo do novo estado

  // Campos alterados (array de nomes de campos: ["time", "data.pressao"])
  changedFields Json @default("[]")

  // Auditoria da mudança
  changeType    String // "UPDATE" ou "DELETE"
  changeReason  String   @db.Text // Motivo obrigatório da mudança
  changedBy     String   @db.Uuid // ID do usuário que fez a mudança
  changedByName String // Nome do usuário que fez a mudança
  changedAt     DateTime @default(now()) @db.Timestamptz(3)

  // IP e User Agent para auditoria adicional
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Relações
  record DailyRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([recordId, versionNumber])
  @@index([tenantId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("daily_record_history")
}

model ResidentScheduleConfig {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de registro obrigatório (usa enum RecordType existente)
  recordType RecordType

  // Frequência de recorrência
  frequency ScheduleFrequency

  // Configurações específicas por frequência
  // Para WEEKLY: 0-6 (0=Domingo, 1=Segunda, ..., 6=Sábado)
  // Para MONTHLY: 1-31 (dia do mês)
  // Para DAILY: null
  dayOfWeek  Int? // 0-6 (apenas para WEEKLY)
  dayOfMonth Int? // 1-31 (apenas para MONTHLY)

  // Horários sugeridos - array de strings "HH:mm"
  // Ex: ["08:00", "14:00"] para 2x ao dia
  suggestedTimes Json @default("[]")

  // Status
  isActive Boolean @default(true)

  // Observações
  notes String? @db.Text

  // Metadados extras (JSON) - usado para armazenar informações específicas por tipo
  // Ex: para ALIMENTACAO: { "mealType": "Café da Manhã" }
  metadata Json? @default("{}")

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ScheduleConfigCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("ScheduleConfigUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([tenantId, residentId])
  @@index([residentId, isActive])
  @@index([recordType])
  @@index([deletedAt])
  // Índices compostos adicionais para queries frequentes
  @@index([residentId, recordType, isActive]) // Configurações ativas do residente por tipo
  @@index([tenantId, recordType, isActive]) // Configurações ativas do tenant por tipo
  @@map("resident_schedule_configs")
}

model ResidentScheduledEvent {
  id         String @id @default(uuid()) @db.Uuid
  tenantId   String @db.Uuid
  residentId String @db.Uuid

  // Tipo de evento
  eventType ScheduledEventType

  // Data e hora do agendamento
  scheduledDate DateTime @db.Date
  scheduledTime String // HH:mm

  // Detalhes do evento
  title       String // Ex: "Vacina Influenza - 1ª dose"
  description String? @db.Text

  // Campos específicos para vacinas (quando eventType = VACCINATION)
  vaccineData Json? // {vaccine, dose, manufacturer, etc}

  // Status
  status ScheduledEventStatus @default(SCHEDULED)

  // Referência ao registro criado (quando status = COMPLETED)
  completedRecordId String?   @db.Uuid
  completedAt       DateTime? @db.Timestamptz(3)

  // Observações
  notes String? @db.Text

  // Auditoria
  createdBy String    @db.Uuid
  updatedBy String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  // Relações
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ScheduledEventCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("ScheduledEventUpdatedBy", fields: [updatedBy], references: [id])

  // Índices
  @@index([tenantId, scheduledDate])
  @@index([residentId, scheduledDate])
  @@index([status, scheduledDate])
  @@index([eventType])
  @@index([deletedAt])
  // Índices compostos adicionais para queries frequentes
  @@index([tenantId, status, scheduledDate]) // Eventos pendentes do dia
  @@index([residentId, status, scheduledDate]) // Eventos pendentes do residente
  @@index([tenantId, eventType, scheduledDate]) // Eventos por tipo (ex: VACINACAO)
  @@map("resident_scheduled_events")
}

// ──────────────────────────────────────────────────────────────────────────────
//  GESTÃO DE INTERCORRÊNCIAS E CONFORMIDADE RDC 502/2021
// ──────────────────────────────────────────────────────────────────────────────

// Indicadores mensais RDC 502/2021
model IncidentMonthlyIndicator {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid // Stored for reference, no FK (cross-schema)

  year  Int // 2024, 2025, etc
  month Int // 1-12

  indicatorType RdcIndicatorType

  numerator   Int // Casos identificados
  denominator Int // Total de residentes (média do mês)
  rate        Float // Taxa calculada (numerator/denominator * 100)

  incidentIds Json  @default("[]") // Array de UUIDs
  metadata    Json? @db.JsonB

  calculatedAt DateTime @default(now()) @db.Timestamptz(3)
  calculatedBy String?  @db.Uuid // Stored for reference, no FK (cross-schema)

  // Sem relações - ambos tenantId e calculatedBy são apenas para auditoria
  // Não podem ter FKs devido a cross-schema constraints

  @@unique([tenantId, year, month, indicatorType])
  @@index([tenantId, year(sort: Desc), month(sort: Desc)])
  @@index([indicatorType])
  @@map("incident_monthly_indicators")
}

// Rastreamento de notificações à vigilância (Eventos Sentinela)
model SentinelEventNotification {
  id             String @id @default(uuid()) @db.Uuid
  tenantId       String @db.Uuid
  dailyRecordId  String @db.Uuid
  notificationId String @db.Uuid

  eventType String @db.VarChar(100) // QUEDA_COM_LESAO, TENTATIVA_SUICIDIO

  status String @default("PENDENTE") @db.VarChar(50) // PENDENTE, ENVIADO, CONFIRMADO

  protocolo          String?   @db.VarChar(100)
  dataEnvio          DateTime? @db.Timestamptz(3)
  dataConfirmacao    DateTime? @db.Timestamptz(3)
  responsavelEnvio   String?   @db.Uuid
  emailEnviado       Boolean   @default(false)
  emailEnviadoEm     DateTime? @db.Timestamptz(3)
  emailDestinatarios Json?     @default("[]")

  observacoes String? @db.Text
  metadata    Json?   @db.JsonB

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dailyRecord  DailyRecord  @relation(fields: [dailyRecordId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User?        @relation("SentinelEventResponsible", fields: [responsavelEnvio], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([dailyRecordId])
  @@index([status])
  @@map("sentinel_event_notifications")
}

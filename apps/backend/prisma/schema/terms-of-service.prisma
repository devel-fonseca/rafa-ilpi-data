// ──────────────────────────────────────────────────────────────────────────────
//  TERMOS DE USO SaaS
//
//  Modelos para gerenciar termos de uso, aceites e compliance LGPD
//  (Substitui ServiceContract - nova terminologia)
// ──────────────────────────────────────────────────────────────────────────────

// Termos de Uso (Templates Versionados)
model TermsOfService {
  id            String         @id @default(uuid()) @db.Uuid
  version       String         @db.VarChar(50) // "v1.0", "v1.1", "v2.0"
  planId        String?        @db.Uuid // NULL = genérico para todos planos
  status        ContractStatus @default(DRAFT)
  effectiveFrom DateTime?      @map("effective_from") @db.Timestamptz(3)
  title         String         @db.VarChar(255)
  content       String         @db.Text // HTML/Markdown
  contentHash   String         @map("content_hash") @db.VarChar(64) // SHA-256
  createdBy     String         @map("created_by") @db.Uuid
  createdAt     DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(3)
  revokedAt     DateTime?      @map("revoked_at") @db.Timestamptz(3)
  revokedBy     String?        @map("revoked_by") @db.Uuid

  // Relações
  plan        Plan?                      @relation("TermsOfServicePlan", fields: [planId], references: [id], onDelete: SetNull)
  creator     User                       @relation("TermsCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  revoker     User?                      @relation("TermsRevoker", fields: [revokedBy], references: [id], onDelete: Restrict)
  acceptances TermsOfServiceAcceptance[]

  @@unique([version, planId])
  @@index([status])
  @@index([effectiveFrom])
  @@index([planId])
  @@map("terms_of_service")
}

// Registros de Aceite dos Termos de Uso (Prova Jurídica)
model TermsOfServiceAcceptance {
  id           String   @id @default(uuid()) @db.Uuid
  termsId      String   @map("terms_id") @db.Uuid
  tenantId     String   @unique @db.Uuid // Tenant só aceita uma vez (camelCase no DB)
  userId       String   @db.Uuid // Stored for reference, no FK (cross-schema, camelCase no DB)
  acceptedAt   DateTime @default(now()) @map("accepted_at") @db.Timestamptz(3)
  ipAddress    String   @map("ip_address") @db.VarChar(45)
  userAgent    String   @map("user_agent") @db.Text
  termsVersion String   @map("terms_version") @db.VarChar(50) // Snapshot imutável
  termsHash    String   @map("terms_hash") @db.VarChar(64) // Snapshot imutável
  termsContent String   @map("terms_content") @db.Text // Snapshot imutável

  // Relações
  terms  TermsOfService @relation(fields: [termsId], references: [id], onDelete: Restrict)
  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // user - NO FK (cross-schema: public → tenant_xxx)

  @@index([termsId])
  @@index([acceptedAt])
  @@map("terms_of_service_acceptances")
}

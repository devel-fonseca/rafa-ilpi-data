// ──────────────────────────────────────────────────────────────────────────────
//  CONTRATOS DE SERVIÇO SaaS
//
//  Modelos para gerenciar contratos de serviço, aceites e compliance LGPD
// ──────────────────────────────────────────────────────────────────────────────

// Contratos de Serviço (Templates Versionados)
model ServiceContract {
  id            String         @id @default(uuid()) @db.Uuid
  version       String // "v1.0", "v1.1", "v2.0"
  planId        String?        @db.Uuid // NULL = genérico para todos planos
  status        ContractStatus @default(DRAFT)
  effectiveFrom DateTime?      @db.Timestamptz(3)
  title         String         @db.VarChar(255)
  content       String // HTML/Markdown
  contentHash   String         @db.VarChar(64) // SHA-256
  createdBy     String         @db.Uuid
  createdAt     DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(3)
  revokedAt     DateTime?      @db.Timestamptz(3)
  revokedBy     String?        @db.Uuid

  // Relações
  plan        Plan?                @relation(fields: [planId], references: [id], onDelete: SetNull)
  creator     User                 @relation("ContractCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  revoker     User?                @relation("ContractRevoker", fields: [revokedBy], references: [id], onDelete: Restrict)
  acceptances ContractAcceptance[]

  @@unique([version, planId])
  @@index([status])
  @@index([effectiveFrom])
  @@index([planId])
  @@map("service_contracts")
}

// Registros de Aceite (Prova Jurídica)
model ContractAcceptance {
  id              String   @id @default(uuid()) @db.Uuid
  contractId      String   @db.Uuid
  tenantId        String   @unique @db.Uuid // Tenant só aceita uma vez
  userId          String   @db.Uuid // Stored for reference, no FK (cross-schema)
  acceptedAt      DateTime @default(now()) @db.Timestamptz(3)
  ipAddress       String   @db.VarChar(45)
  userAgent       String
  contractVersion String   @db.VarChar(50) // Snapshot imutável
  contractHash    String   @db.VarChar(64) // Snapshot imutável
  contractContent String // Snapshot imutável

  // Relações
  contract ServiceContract @relation(fields: [contractId], references: [id], onDelete: Restrict)
  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // user - NO FK (cross-schema: public → tenant_xxx)

  @@index([contractId])
  @@index([acceptedAt])
  @@map("contract_acceptances")
}

// Registros de Aceite da Política de Privacidade (Prova Jurídica LGPD)
model PrivacyPolicyAcceptance {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @unique @db.Uuid // Tenant só aceita uma vez
  userId              String   @db.Uuid // Stored for reference, no FK (cross-schema)
  acceptedAt          DateTime @default(now()) @db.Timestamptz(3)
  ipAddress           String   @db.VarChar(45)
  userAgent           String
  policyVersion       String   @db.VarChar(50) // ex: "2.2"
  policyEffectiveDate String   @db.VarChar(50) // ex: "24/12/2025"
  policyContent       String   @db.Text // Snapshot completo Markdown

  // Declarações LGPD registradas no onboarding
  lgpdIsDataController           Boolean @default(false)
  lgpdHasLegalBasis              Boolean @default(false)
  lgpdAcknowledgesResponsibility Boolean @default(false)

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // user - NO FK (cross-schema: public → tenant_xxx)

  @@index([tenantId])
  @@index([acceptedAt])
  @@map("privacy_policy_acceptances")
}

# Contratos + Integração com Financeiro Operacional

**Status:** ✅ Implementado (Fase 1 + Fase 2)
**Versão:** 1.0.0
**Última atualização:** 12/02/2026

## Objetivo

Documentar as mudanças do módulo de contratos e sua integração com o Financeiro Operacional para geração e acompanhamento das mensalidades.

## O que mudou em Contratos

### 1) Novos campos financeiros no contrato

Adicionados no modelo `ResidentContract`:
- `lateFeePercent` (multa por atraso, %)
- `interestMonthlyPercent` (juros por atraso, % ao mês)

Referências:
- Prisma schema: `apps/backend/prisma/schema/resident-contracts.prisma`
- Migration: `apps/backend/prisma/migrations/20260212182000_add_contract_late_fee_interest/migration.sql`
- DTO: `apps/backend/src/resident-contracts/dto/create-contract.dto.ts`
- Service: `apps/backend/src/resident-contracts/resident-contracts.service.ts`
- Frontend upload: `apps/frontend/src/pages/contracts/ResidentContractUpload.tsx`
- Frontend view: `apps/frontend/src/pages/contracts/ResidentContractView.tsx`

### 2) Aba de detalhes do contrato (ajustes de UX)

- Exibição de multa e juros junto de “Valores e Pagamento”.
- Bloco “Assinantes” ajustado para “Responsáveis Contratuais” (sem ILPI/testemunha).
- “Informações de cadastro” simplificadas em linha única.
- Aba de arquivos simplificada para usuário final (somente “Ver contrato”).

## Integração Contratos -> Financeiro

### Serviço de geração automática

Serviço central:
- `apps/backend/src/financial-operations/services/financial-contract-transactions.service.ts`

Responsabilidades:
- Gerar mensalidades por competência para contratos vigentes.
- Criar transações de receita vinculadas ao contrato (`residentContractId`).
- Usar categoria de receita “Mensalidades de residentes”.
- Manter idempotência por contrato + competência.

### Fonte e rastreabilidade das transações

Transações automáticas recebem:
- `isAutoGenerated = true`
- `generationSource = 'RESIDENT_CONTRACT'`
- `residentContractId` preenchido

### Índice de idempotência

Migration:
- `apps/backend/prisma/migrations/20260212173000_add_unique_contract_competence_generation/migration.sql`

Objetivo:
- Evitar duplicidade de mensalidade automática para o mesmo contrato/competência/fonte.

### Ponto de entrada manual

Endpoint para geração sob demanda:
- `POST /api/financial/transactions/generate-from-contracts`

Arquivo:
- `apps/backend/src/financial-operations/controllers/financial-transactions.controller.ts`

### Sincronização best-effort em fluxos existentes

A sincronização de competência atual é acionada em pontos de leitura/uso, reduzindo dependência de cron para esse caso:
- Listagem de transações
- Listagem de fechamentos
- Listagem de pagas sem fechamento
- Upload/atualização de contratos (best-effort para contrato específico)

## Histórico financeiro no detalhe do contrato

### Backend

`GET /api/financial/transactions` aceita filtro:
- `residentContractId`

Arquivos:
- DTO query: `apps/backend/src/financial-operations/dto/query-transactions.dto.ts`
- Service: `apps/backend/src/financial-operations/services/financial-transactions.service.ts`

### Frontend

Aba “Financeiro” no detalhe do contrato:
- mostra parcelas/transações vinculadas
- resumo (pagas/pendentes/atrasadas)
- ação por linha: **Abrir no Financeiro** (deep link com filtros)

Arquivo:
- `apps/frontend/src/pages/contracts/ResidentContractView.tsx`

## Deep link Contrato -> Financeiro

Ação “Abrir no Financeiro” envia query params para `/dashboard/financeiro`:
- `tab=transactions`
- `residentContractId=<id>`
- `status=<status da linha>`
- `dueDateFrom` / `dueDateTo` (data da linha)

A página financeira lê e aplica esses filtros automaticamente.

Arquivo:
- `apps/frontend/src/pages/financial/FinancialOperationsPage.tsx`

## Regras e tradeoffs

### Tradeoff 1: sincronização sem cron dedicado para contratos

Decisão:
- disparar sincronização em pontos de fluxo (listagem e eventos de contrato), em vez de cron exclusivo.

Motivo:
- evita acoplamento com job global em provider request-scoped;
- reduz risco de inconsistência sem exigir scheduler adicional para esse contexto.

### Tradeoff 2: geração automática foca competência atual

Decisão:
- foco operacional na competência corrente para manter previsibilidade e custo baixo.

Motivo:
- evita geração massiva retroativa involuntária;
- permite backfill controlado quando necessário.

### Tradeoff 3: juros/multa no contrato não recalculam automaticamente parcelas já geradas

Estado atual:
- campos ficam registrados no contrato e disponíveis para uso operacional.

Motivo:
- preserva estabilidade das transações já emitidas;
- política de recálculo retroativo pode variar por ILPI e será fase posterior.

## Checklist de operação pós-deploy

1. Aplicar migrations no schema público e tenants.
2. Rodar seed financeiro por tenant (se ambiente novo).
3. Validar permissões financeiras por cargo.
4. Validar criação/edição de contrato com multa e juros.
5. Validar geração de mensalidade do contrato.
6. Validar aba “Financeiro” no detalhe do contrato.

## Comandos úteis

```bash
cd apps/backend
npm run prisma:migrate:prod
npm run tenants:sync-schemas
npm run prisma:seed:financial-operations
npm run build
```

## Próximas evoluções sugeridas

- Política formal de cálculo de juros/multa temporal (ao dia/pró-rata/mês).
- Recálculo assistido para parcelas em aberto após alteração contratual.
- Integração de fechamento com importação de extrato bancário (OFX/API).
